<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hub v25.0: Face-Locked</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; color: white; }
        
        /* HELEN-STYLE VIDEO ELEMENT (Hidden) */
        #cam-feed { position: absolute; top: 0; left: 0; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
        
        /* 2D MENU */
        #ui-layer { position: absolute; z-index: 9999; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        h1 { font-weight: 200; letter-spacing: 8px; text-transform: uppercase; margin-bottom: 30px; }
        .hub-card { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); padding: 40px; border-radius: 16px; width: 450px; text-align: center; }
        .btn-main { background: linear-gradient(135deg, #00d2ff 0%, #0078ff 100%); border: none; padding: 15px 30px; color: white; font-weight: bold; font-size: 16px; border-radius: 30px; cursor: pointer; margin-top: 20px; width: 100%; }
        
        /* DEBUG PREVIEW (Bottom Left) */
        #debug-view { position: absolute; bottom: 10px; left: 10px; width: 160px; height: 120px; background: #222; border: 2px solid #00ff00; z-index: 10000; display: none; object-fit: cover; }
    </style>
</head>
<body>

    <video id="cam-feed" autoplay muted playsinline></video>
    <video id="debug-view" autoplay muted playsinline></video>

    <div id="ui-layer">
        <h1>The Hub <span style="color:#00d2ff">v25</span></h1>
        <div class="hub-card">
            <h3 style="margin: 0 0 10px;">Face-Lock Engine</h3>
            
            <button class="btn-main" onclick="startHelenSystem()" style="background:#333;">1. START CAMERA</button>
            <div id="status" style="color:#666; margin-top:10px; font-size:0.9em;">Status: Standby</div>

            <hr style="border:0; border-top:1px solid #333; margin:20px 0;">
            
            <button class="btn-main" onclick="document.getElementById('file-input').click()">LOAD MEDIA</button>
            <input type="file" id="file-input" style="display:none" multiple>
            
            <button id="btn-vr" class="btn-main" style="background: #ff9d00; display:none; margin-top:20px;" onclick="enterVR()">2. ENTER VR</button>
        </div>
    </div>

    <a-scene background="color: #000" fog="type: exponential; color: #000; density: 0.015">
        
        <a-assets>
            <img id="grid-texture" src="https://cdn.aframe.io/a-painter/images/floor.jpg">
            <video id="video-src" src="" loop="false" crossorigin="anonymous"></video>
        </a-assets>

        <a-plane id="env-floor" position="0 0 -4" rotation="-90 0 0" width="80" height="80" 
                 src="#grid-texture" repeat="40 40" color="#1a1a1a" roughness="0.2" metalness="0.8">
        </a-plane>

        <a-light type="ambient" color="#222" intensity="0.5"></a-light>
        <a-light type="point" position="0 4 -4" intensity="0.5" color="#fff"></a-light>

        <a-curvedimage id="screen-cinema" src="#video-src" height="9" radius="11" theta-length="80" rotation="0 135 0" position="0 4 0" side="double"></a-curvedimage>

        <a-entity id="menu-wrapper" position="0 1.2 -1.5" rotation="-15 0 0">
            <a-box depth="0.01" height="0.8" width="2.4" color="#111" opacity="0.8"></a-box>
            <a-plane id="btn-cam" position="-0.9 0.3 0.02" width="0.4" height="0.12" color="#0078ff" class="clickable">
                <a-text value="CAM TOGGLE" align="center"></a-text>
            </a-plane>
            <a-plane id="btn-play" position="0 0 0.02" width="0.6" height="0.2" color="#ff9d00" class="clickable">
                <a-text id="txt-play" value="PLAY" align="center" color="black"></a-text>
            </a-plane>
        </a-entity>

        <a-entity id="rig" position="0 1.6 0">
            <a-camera look-controls="reverseMouseDrag: true" wasd-controls="enabled: false">
                <a-cursor color="#ff9d00" fuse="true" fuse-timeout="1500" raycaster="objects: .clickable"></a-cursor>
            </a-camera>
        </a-entity>

    </a-scene>

    <script>
        // --- THE HELEN ENGINE ---
        let cameraStream = null;
        let cameraMesh = null; // The rectangle that sticks to your face
        let isCamActive = false;

        const dom = {
            video: document.getElementById('cam-feed'),
            debug: document.getElementById('debug-view'),
            status: document.getElementById('status'),
            btnVr: document.getElementById('btn-vr')
        };

        async function startHelenSystem() {
            try {
                // 1. GET STREAM
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                cameraStream = stream;
                
                // 2. ATTACH TO HIDDEN VIDEO & DEBUG
                dom.video.srcObject = stream;
                dom.debug.srcObject = stream;
                dom.debug.style.display = "block";
                
                // 3. WAIT FOR DATA (Crucial Step)
                await new Promise(r => dom.video.onloadedmetadata = r);
                await dom.video.play();
                
                dom.status.innerHTML = "System Ready. Feed Active.";
                dom.status.style.color = "#00ff00";
                dom.btnVr.style.display = "block";
                
                // 4. PREPARE THE 3D MESH (But don't add it yet)
                createCameraPlane();
                
            } catch (e) {
                dom.status.innerHTML = "Error: " + e.name;
                dom.status.style.color = "red";
                alert(e.name);
            }
        }

        function createCameraPlane() {
            // This is pure Three.js (No A-Frame Magic)
            const videoTexture = new THREE.VideoTexture(dom.video);
            videoTexture.colorSpace = THREE.SRGBColorSpace;
            videoTexture.minFilter = THREE.LinearFilter;
            videoTexture.magFilter = THREE.LinearFilter;
            videoTexture.generateMipmaps = false;

            // Create a BIG plane
            const geometry = new THREE.PlaneGeometry(100, 100);
            
            // "depthTest: false" makes it render BEHIND everything else
            const material = new THREE.MeshBasicMaterial({ 
                map: videoTexture, 
                depthTest: false, 
                depthWrite: false,
                side: THREE.DoubleSide
            });

            cameraMesh = new THREE.Mesh(geometry, material);
            // Push it far back
            cameraMesh.position.z = -50; 
            
            // IMPORTANT: We do not add it to the scene yet.
        }

        function activatePassthrough() {
            if (!cameraMesh) return;
            
            // FIND THE REAL CAMERA
            const scene = document.querySelector('a-scene').object3D;
            const camEl = document.querySelector('[camera]');
            const threeCam = camEl.getObject3D('camera');

            // PARENT THE PLANE TO THE CAMERA
            // This makes it move with your head
            threeCam.add(cameraMesh);
            
            // Hide Floor/Fog
            document.getElementById('env-floor').setAttribute('visible', false);
            document.querySelector('a-scene').removeAttribute('fog');
            
            isCamActive = true;
        }

        function deactivatePassthrough() {
            if (!cameraMesh) return;
            
            const camEl = document.querySelector('[camera]');
            const threeCam = camEl.getObject3D('camera');
            
            // Remove it
            threeCam.remove(cameraMesh);
            
            // Restore Floor
            document.getElementById('env-floor').setAttribute('visible', true);
            // We could restore fog here, but keeping it off is cleaner
            
            isCamActive = false;
        }

        function enterVR() {
            document.getElementById('ui-layer').style.display = 'none';
            const scene = document.querySelector('a-scene');
            scene.enterVR();
            
            // Auto-activate cam on entry
            setTimeout(() => {
                activatePassthrough();
                // Re-trigger play for iOS safety
                dom.video.play();
            }, 1000);
        }

        // --- BUTTON LOGIC ---
        document.getElementById('btn-cam').addEventListener('click', () => {
            if (isCamActive) deactivatePassthrough();
            else activatePassthrough();
        });

        // --- STANDARD MEDIA PLAYER LOGIC ---
        document.getElementById('file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                const v = document.getElementById('video-src');
                v.src = url;
                
                // Update Play Button Logic
                const playBtn = document.getElementById('btn-play');
                playBtn.addEventListener('click', () => {
                    if(v.paused) { v.play(); document.getElementById('txt-play').setAttribute('value', 'PAUSE'); }
                    else { v.pause(); document.getElementById('txt-play').setAttribute('value', 'PLAY'); }
                });
                
                dom.status.innerHTML = "Loaded: " + file.name;
            }
        });

    </script>
</body>
</html>
