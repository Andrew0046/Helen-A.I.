<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hub v10.5: Dual Screen</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; background: #050505; font-family: 'Segoe UI', Roboto, sans-serif; color: white; }
        #ui-layer { position: absolute; z-index: 9999; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .hidden { opacity: 0; pointer-events: none; }
        h1 { font-weight: 200; letter-spacing: 8px; text-transform: uppercase; margin-bottom: 30px; }
        .hub-card { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); padding: 40px; border-radius: 16px; width: 450px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .btn-main { background: linear-gradient(135deg, #00d2ff 0%, #0078ff 100%); border: none; padding: 15px 30px; color: white; font-weight: bold; font-size: 16px; letter-spacing: 1px; border-radius: 30px; cursor: pointer; margin-top: 20px; width: 100%; transition: transform 0.2s; }
        .btn-main:hover { transform: translateY(-2px); }
        input[type="text"] { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid #333; padding: 10px; color: white; border-radius: 4px; }
        #cam-status { margin-top: 10px; color: #666; font-size: 0.9em; }
    </style>
</head>
<body>

    <video id="camera-stream" autoplay playsinline muted style="display:none"></video>

    <div id="ui-layer">
        <h1>The <span style="color: #ff9d00">Hub</span> <span style="font-size: 0.5em; vertical-align: super; color: #666">v10.5</span></h1>
        <div class="hub-card">
            <h3 style="margin: 0 0 10px; font-weight: 400;">Dual Screen System</h3>
            
            <button class="btn-main" onclick="startCameraOnFeed()" style="background: #333; margin-top: 0;">1. START CAM</button>
            <div id="cam-status">Status: Standby</div>

            <hr style="border:0; border-top:1px solid #333; margin:20px 0;">

            <p style="color: #888; font-size: 0.9rem;">Select media for Main Screen</p>
            <input type="file" id="file-input" accept="video/*, image/*, .pdf" multiple style="display:none">
            <button class="btn-main" onclick="document.getElementById('file-input').click()">LOAD FILES</button>
            
            <button id="btn-start" class="btn-main" style="display:none; background: #ff9d00; margin-top: 20px;">2. ENTER VR</button>
        </div>
    </div>

    <canvas id="light-canvas" width="32" height="32" style="display:none"></canvas>

    <a-scene background="color: #000" fog="type: exponential; color: #000; density: 0.015">
        
        <a-assets>
            <video id="video-src" src="" playsinline webkit-playsinline loop="false" crossorigin="anonymous"></video>
            <img id="img-src" src="" crossorigin="anonymous">
            <canvas id="pdf-canvas"></canvas>
            <img id="grid-texture" src="https://cdn.aframe.io/a-painter/images/floor.jpg">
        </a-assets>

        <a-plane id="env-floor" position="0 0 -4" rotation="-90 0 0" width="80" height="80" src="#grid-texture" repeat="40 40" color="#1a1a1a" roughness="0.2" metalness="0.8"></a-plane>
        <a-sky color="#050505"></a-sky>
        <a-light type="ambient" color="#222" intensity="0.2"></a-light>
        <a-light id="screen-glow" type="point" position="0 4 -4" distance="20" decay="2" intensity="0.5" color="#fff"></a-light>

        <a-curvedimage id="screen-cinema" src="#video-src" height="12" radius="14" theta-length="90" rotation="0 135 0" position="0 5 0" side="double" visible="true"></a-curvedimage>

        <a-curvedimage id="my-feed" 
            src="#video-src" 
            height="12" 
            radius="14" 
            theta-length="90" 
            rotation="0 135 0" 
            position="0 9 0" 
            side="double" 
            visible="true"
            opacity="0.5"> </a-curvedimage>

        <a-entity id="hub-wrapper" position="0 0.8 -1.8" rotation="-25 0 0">
            <a-box depth="0.02" height="1.0" width="2.8" color="#050505" opacity="0.9" class="clickable"></a-box>
            <a-text id="txt-title" value="Waiting..." position="0 0.42 0.02" align="center" width="2.5" color="white"></a-text>
            <a-plane id="btn-close" position="1.2 0.4 0.03" width="0.25" height="0.15" color="#cc0000" class="clickable btn-hover"><a-text value="X" align="center" width="6"></a-text></a-plane>

            <a-plane id="btn-play" position="0 0.15 0.02" width="0.7" height="0.2" color="#ff9d00" class="clickable btn-hover"><a-text id="txt-play" value="PLAY" align="center" color="black"></a-text></a-plane>
            
            <a-text value="MY FEED (CAM)" position="0 -0.25 0.02" align="center" width="2" color="#666"></a-text>
            <a-plane id="btn-cam-vr" position="0 -0.35 0.02" width="0.5" height="0.15" color="#333" class="clickable btn-hover"><a-text id="txt-cam-vr" value="CAM ON" align="center"></a-text></a-plane>
        </a-entity>

        <a-entity id="rig" position="0 1.6 0">
            <a-camera look-controls="reverseMouseDrag: true" wasd-controls="enabled: false">
                <a-cursor color="#ff9d00" fuse="true" fuse-timeout="1500" raycaster="objects: .clickable"></a-cursor>
            </a-camera>
        </a-entity>
    </a-scene>

    <script>
        // --- HELEN ENGINE: CAMERA INJECTION ---
        let helenStream = null;
        
        async function startCameraOnFeed() {
            const status = document.getElementById('cam-status');
            const videoEl = document.getElementById('camera-stream');
            
            try {
                // 1. Get Stream
                status.innerHTML = "Requesting Access...";
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                
                // 2. Attach to hidden video
                videoEl.srcObject = stream;
                helenStream = stream;
                
                // 3. Wait for data (The Helen Fix)
                await new Promise(r => videoEl.onloadedmetadata = r);
                await videoEl.play();
                
                status.innerHTML = "Status: ACTIVE (Feed Ready)";
                status.style.color = "#00ff00";
                
                // 4. Inject into A-Frame Entity
                applyFeedTexture();
                
                // Unlock VR
                document.getElementById('btn-start').style.display = 'block';
                
            } catch (e) {
                status.innerHTML = "Error: " + e.name;
                status.style.color = "red";
                alert("Cam Error: " + e.name);
            }
        }

        function applyFeedTexture() {
            const feedEntity = document.getElementById('my-feed');
            const videoEl = document.getElementById('camera-stream');
            
            // Create texture manually using Three.js (Bypassing A-Frame loader)
            const texture = new THREE.VideoTexture(videoEl);
            texture.colorSpace = THREE.SRGBColorSpace;
            texture.minFilter = THREE.LinearFilter;
            texture.magFilter = THREE.LinearFilter;
            texture.generateMipmaps = false;
            
            // Apply to the Mesh
            const mesh = feedEntity.getObject3D('mesh');
            if (mesh) {
                if(mesh.material.map) mesh.material.map.dispose(); // Cleanup old
                mesh.material.map = texture;
                mesh.material.needsUpdate = true;
                
                // Make it fully opaque now that we have video
                feedEntity.setAttribute('opacity', '1.0');
                feedEntity.setAttribute('color', '#FFF');
            }
        }

        // --- STANDARD HUB LOGIC ---
        const DOM = {
            media: { video: document.getElementById('video-src') },
            vr: { 
                screens: { cinema: document.getElementById('screen-cinema') },
                btnPlay: document.getElementById('btn-play'),
                btnCam: document.getElementById('btn-cam-vr')
            }
        };

        // File Loader
        document.getElementById('file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(file) {
                const url = URL.createObjectURL(file);
                DOM.media.video.src = url;
                DOM.media.video.play();
                document.getElementById('txt-play').setAttribute('value', 'PAUSE');
                document.getElementById('btn-start').style.display = 'block';
            }
        });

        // VR Entry
        document.getElementById('btn-start').addEventListener('click', () => {
            document.getElementById('ui-layer').style.display = 'none';
            document.querySelector('a-scene').enterVR();
            // Re-apply texture on entry just in case
            if(helenStream) setTimeout(applyFeedTexture, 1000);
        });

        // Play Button
        DOM.vr.btnPlay.addEventListener('click', () => {
            const v = DOM.media.video;
            if(v.paused) { v.play(); document.getElementById('txt-play').setAttribute('value', 'PAUSE'); }
            else { v.pause(); document.getElementById('txt-play').setAttribute('value', 'PLAY'); }
        });

        // VR Cam Toggle
        DOM.vr.btnCam.addEventListener('click', () => {
            const feed = document.getElementById('my-feed');
            const isVis = feed.getAttribute('visible');
            if(isVis) {
                feed.setAttribute('visible', false);
                document.getElementById('txt-cam-vr').setAttribute('value', 'CAM ON');
            } else {
                feed.setAttribute('visible', true);
                document.getElementById('txt-cam-vr').setAttribute('value', 'CAM OFF');
                if(helenStream) applyFeedTexture(); // Refresh
            }
        });

    </script>
</body>
</html>
