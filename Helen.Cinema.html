<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hub v22.0: Fusion</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; background: #050505; font-family: sans-serif; color: white; }
        
        /* UI Layer (2D Menu) */
        #ui-layer { position: absolute; z-index: 9999; top: 0; left: 0; width: 100%; height: 100%; background: #111; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .hidden { opacity: 0; pointer-events: none; }
        
        .btn-main { background: linear-gradient(135deg, #00d2ff 0%, #0078ff 100%); border: none; padding: 15px 40px; color: white; font-weight: bold; font-size: 18px; border-radius: 30px; margin: 10px; cursor: pointer; box-shadow: 0 10px 30px rgba(0,100,255,0.4); }
        .btn-sec { background: #333; border: 1px solid #555; padding: 10px 20px; color: #ccc; border-radius: 5px; cursor: pointer; margin-top: 10px; }
        
        /* Debug Preview (Bottom Left) */
        #debug-panel { position: absolute; bottom: 10px; left: 10px; z-index: 10000; display: flex; gap: 5px; pointer-events: none; opacity: 0.7; }
        #cam-video-hidden { width: 120px; height: 80px; background: #300; object-fit: cover; border: 1px solid red; }
        #cam-canvas-hidden { width: 120px; height: 80px; background: #003; border: 1px solid blue; }
        
        /* WORKER AREA */
        #hidden-assets { display: none; }
    </style>

    <script>
        // --- COMPONENT: FORCE CANVAS UPDATE (The v19 Logic) ---
        AFRAME.registerComponent('canvas-updater', {
            tick: function () {
                var el = this.el;
                var material = el.getObject3D('mesh').material;
                if (material.map) material.map.needsUpdate = true;
            }
        });
    </script>
</head>
<body>

    <div id="ui-layer">
        <h1>THE HUB <span style="color:#00d2ff">v22</span></h1>
        <p style="color:#666">Fusion Engine</p>
        
        <button class="btn-main" id="btn-init" onclick="initSystem()">1. START SYSTEM</button>
        <button class="btn-main" id="btn-vr" style="background: #ff9d00; display:none" onclick="enterVR()">2. ENTER VR</button>
        
        <div style="margin-top: 30px; border-top: 1px solid #333; padding-top: 20px; text-align: center;">
            <button class="btn-sec" onclick="document.getElementById('file-input').click()">LOAD MEDIA FILES</button>
            <div id="status-text" style="color: #444; margin-top: 5px; font-size: 0.8em;">No media loaded</div>
        </div>

        <input type="file" id="file-input" accept="video/*, image/*, .pdf" multiple style="display:none">
    </div>

    <div id="debug-panel">
        <video id="cam-video-hidden" autoplay playsinline muted></video>
        <canvas id="cam-canvas-hidden" width="512" height="512"></canvas>
    </div>

    <a-scene background="color: #000">
        
        <a-assets>
            <video id="video-src" src="" playsinline webkit-playsinline loop="false" crossorigin="anonymous"></video>
            <img id="img-src" src="" crossorigin="anonymous">
            <canvas id="pdf-canvas"></canvas>
            <img id="grid-texture" src="https://cdn.aframe.io/a-painter/images/floor.jpg">
        </a-assets>

        <a-sky id="env-sky" radius="500" color="#050505" material="shader: flat; src: #cam-canvas-hidden" canvas-updater></a-sky>

        <a-plane position="0 0.1 -2" rotation="-45 0 0" width="1" height="0.4" color="#000" opacity="0.8">
            <a-text id="vr-console" value="System Standby..." align="center" width="2" color="#00ff00"></a-text>
        </a-plane>

        <a-curvedimage id="screen-cinema" src="#video-src" height="9" radius="11" theta-length="80" rotation="0 135 0" position="0 4 0" side="double"></a-curvedimage>

        <a-entity id="hub-wrapper" position="0 1.2 -1.5" rotation="-15 0 0">
            <a-box depth="0.01" height="0.8" width="2.4" color="#111" opacity="0.9"></a-box>
            
            <a-plane id="btn-cam" position="-0.9 0.3 0.02" width="0.4" height="0.12" color="#0078ff" class="clickable btn-hover">
                <a-text id="txt-cam" value="CAM: ON" align="center" width="3" font-weight="bold"></a-text>
            </a-plane>

            <a-plane id="btn-close" position="0.9 0.3 0.02" width="0.2" height="0.12" color="#cc0000" class="clickable btn-hover">
                <a-text value="X" align="center" width="4"></a-text>
            </a-plane>

            <a-plane id="btn-play" position="0 0 0.02" width="0.6" height="0.2" color="#ff9d00" class="clickable btn-hover">
                <a-text id="txt-play" value="PLAY" align="center" width="6" color="black"></a-text>
            </a-plane>

            <a-plane id="btn-seek-back" position="-0.5 0 0.02" width="0.2" height="0.15" color="#333" class="clickable btn-hover"><a-text value="-15s" align="center" width="4"></a-text></a-plane>
            <a-plane id="btn-seek-fwd" position="0.5 0 0.02" width="0.2" height="0.15" color="#333" class="clickable btn-hover"><a-text value="+15s" align="center" width="4"></a-text></a-plane>

            <a-plane id="seat-front" position="-0.6 -0.3 0.02" width="0.3" height="0.1" color="#444" class="clickable"><a-text value="FRONT" align="center" width="3"></a-text></a-plane>
            <a-plane id="seat-back" position="0 -0.3 0.02" width="0.3" height="0.1" color="#444" class="clickable"><a-text value="BACK" align="center" width="3"></a-text></a-plane>
            <a-plane id="seat-lay" position="0.6 -0.3 0.02" width="0.3" height="0.1" color="#444" class="clickable"><a-text value="RECLINE" align="center" width="3"></a-text></a-plane>
        </a-entity>

        <a-entity id="rig" position="0 1.6 0">
            <a-camera look-controls="reverseMouseDrag: true" wasd-controls="enabled: false">
                <a-cursor color="#ff9d00" fuse="true" fuse-timeout="1500" raycaster="objects: .clickable"></a-cursor>
            </a-camera>
        </a-entity>
    </a-scene>

    <script>
        const pdfjsLib = window.pdfjsLib;
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        // --- GLOBAL STATE ---
        const sys = {
            cam: { active: false, painting: false, width: 512, height: 512 },
            media: { list: [], index: 0, type: 'none' },
            pdf: { doc: null, page: 1, pending: null }
        };

        const DOM = {
            ui: { layer: document.getElementById('ui-layer'), btnInit: document.getElementById('btn-init'), btnVr: document.getElementById('btn-vr'), status: document.getElementById('status-text') },
            media: { 
                rawVideo: document.getElementById('cam-video-hidden'),
                canvas: document.getElementById('cam-canvas-hidden'),
                ctx: document.getElementById('cam-canvas-hidden').getContext('2d'),
                mainVideo: document.getElementById('video-src'),
                img: document.getElementById('img-src'),
                pdfCanvas: document.getElementById('pdf-canvas')
            },
            vr: {
                sky: document.getElementById('env-sky'),
                console: document.getElementById('vr-console'),
                screen: document.getElementById('screen-cinema'),
                menu: document.getElementById('hub-wrapper'),
                rig: document.getElementById('rig'),
                btnPlay: document.getElementById('txt-play')
            }
        };

        // --- 1. CORE: CAMERA ENGINE (v19 Logic) ---
        async function initSystem() {
            logVR("Initializing...");
            try {
                // Secure Context Check
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    alert("ERROR: HTTPS Required."); return;
                }

                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                }).catch(() => navigator.mediaDevices.getUserMedia({ video: true }));

                DOM.media.rawVideo.srcObject = stream;
                await DOM.media.rawVideo.play();
                
                // Start Loop
                sys.cam.painting = true;
                sys.cam.active = true;
                requestAnimationFrame(paintLoop);

                // Update UI
                DOM.ui.btnInit.style.display = 'none';
                DOM.ui.btnVr.style.display = 'block';
                logVR("Cam Ready. Painting.");
                
            } catch (e) {
                alert("Cam Error: " + e.name);
                logVR("Cam Error: " + e.name);
            }
        }

        function paintLoop() {
            if (sys.cam.painting) {
                if (DOM.media.rawVideo.readyState === 4) {
                    DOM.media.ctx.drawImage(DOM.media.rawVideo, 0, 0, sys.cam.width, sys.cam.height);
                }
                requestAnimationFrame(paintLoop);
            }
        }

        // --- 2. VR & TOGGLES ---
        function enterVR() {
            DOM.ui.layer.style.display = 'none';
            document.querySelector('a-scene').enterVR();
            // Force Camera Sky Default
            setSkyCamera(true);
        }

        function setSkyCamera(active) {
            sys.cam.active = active;
            const sky = DOM.vr.sky;
            const btnText = document.getElementById('txt-cam');
            const btn = document.getElementById('btn-cam');

            if (active) {
                sky.setAttribute('src', '#cam-canvas-hidden');
                sky.setAttribute('color', '#FFF');
                if(btnText) btnText.setAttribute('value', 'CAM: ON');
                if(btn) btn.setAttribute('color', '#0078ff');
                sys.cam.painting = true; // Ensure loop runs
                paintLoop(); 
            } else {
                sky.removeAttribute('src');
                sky.setAttribute('color', '#050505');
                if(btnText) btnText.setAttribute('value', 'CAM: OFF');
                if(btn) btn.setAttribute('color', '#333');
            }
        }

        document.getElementById('btn-cam').addEventListener('click', () => {
            setSkyCamera(!sys.cam.active);
            flash(document.getElementById('btn-cam'));
        });

        // --- 3. MEDIA LOGIC (Safeguarded) ---
        document.getElementById('file-input').addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            // Add to list
            sys.media.list = files.map(f => ({
                src: URL.createObjectURL(f),
                type: f.type.includes('video') ? 'video' : (f.type.includes('pdf') ? 'pdf' : 'image'),
                name: f.name
            }));
            
            DOM.ui.status.innerText = `Loaded ${files.length} files. Ready.`;
            loadTrack(0);
        });

        function loadTrack(i) {
            if (!sys.media.list[i]) return;
            sys.media.index = i;
            const item = sys.media.list[i];
            
            logVR("Loading: " + item.name.substring(0,15));
            
            // Reset Screen
            DOM.vr.screen.setAttribute('visible', true);

            if (item.type === 'video') {
                DOM.media.mainVideo.src = item.src;
                DOM.media.mainVideo.play();
                DOM.vr.screen.setAttribute('src', '#video-src');
                DOM.vr.btnPlay.setAttribute('value', 'PAUSE');
            } else if (item.type === 'image') {
                DOM.media.mainVideo.pause();
                const img = DOM.media.img;
                img.onload = () => { DOM.vr.screen.setAttribute('src', '#img-src'); };
                img.src = item.src;
                DOM.vr.btnPlay.setAttribute('value', 'IMAGE');
            } else if (item.type === 'pdf') {
                DOM.media.mainVideo.pause();
                renderPDF(item.src);
                DOM.vr.btnPlay.setAttribute('value', 'PDF');
            }
        }

        // --- 4. CONTROLS ---
        document.getElementById('btn-play').addEventListener('click', function() {
            const v = DOM.media.mainVideo;
            if(!v.paused) { v.pause(); DOM.vr.btnPlay.setAttribute('value', 'PLAY'); }
            else { v.play(); DOM.vr.btnPlay.setAttribute('value', 'PAUSE'); }
            flash(this);
        });

        document.getElementById('btn-close').addEventListener('click', function() {
            DOM.vr.menu.setAttribute('visible', false);
        });

        document.getElementById('menu-orb').addEventListener('click', function() {
            DOM.vr.menu.setAttribute('visible', true);
        });

        // Seat Logic
        function moveSeat(pos, rot) {
            DOM.vr.rig.setAttribute('animation', `property: position; to: ${pos}; dur: 1000`);
            DOM.vr.menu.setAttribute('rotation', rot);
        }
        document.getElementById('seat-front').addEventListener('click', () => moveSeat("0 1.6 -1", "-15 0 0"));
        document.getElementById('seat-back').addEventListener('click', () => moveSeat("0 1.6 2", "-15 0 0"));
        document.getElementById('seat-lay').addEventListener('click', () => moveSeat("0 0.5 0", "-45 0 0"));

        // Seek
        document.getElementById('btn-seek-fwd').addEventListener('click', () => { DOM.media.mainVideo.currentTime += 15; });
        document.getElementById('btn-seek-back').addEventListener('click', () => { DOM.media.mainVideo.currentTime -= 15; });

        // --- PDF RENDERER (Simplified) ---
        function renderPDF(url) {
            pdfjsLib.getDocument(url).promise.then(pdf => {
                sys.pdf.doc = pdf;
                pdf.getPage(1).then(page => {
                    const viewport = page.getViewport({scale: 2});
                    const canvas = DOM.media.pdfCanvas;
                    const ctx = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    page.render({canvasContext: ctx, viewport: viewport}).promise.then(() => {
                        DOM.vr.screen.setAttribute('src', '#pdf-canvas');
                        // Force update
                        const mesh = DOM.vr.screen.getObject3D('mesh');
                        if(mesh && mesh.material.map) mesh.material.map.needsUpdate = true;
                    });
                });
            });
        }

        // --- UTILS ---
        function logVR(msg) {
            console.log(msg);
            DOM.vr.console.setAttribute('value', msg);
        }
        function flash(el) {
            const old = el.getAttribute('color');
            el.setAttribute('color', 'white');
            setTimeout(() => el.setAttribute('color', old), 150);
        }

    </script>
</body>
</html>
