<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hub v28.0: The Gallery</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; background: #050505; font-family: 'Segoe UI', Roboto, sans-serif; color: white; }
        #ui-layer { position: absolute; z-index: 9999; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .hidden { opacity: 0; pointer-events: none; }
        h1 { font-weight: 200; letter-spacing: 8px; text-transform: uppercase; margin-bottom: 30px; }
        h1 span { font-weight: 700; color: #00d2ff; text-shadow: 0 0 20px rgba(0, 210, 255, 0.5); }
        .hub-card { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); padding: 40px; border-radius: 16px; width: 450px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .btn-main { background: linear-gradient(135deg, #00d2ff 0%, #0078ff 100%); border: none; padding: 15px 30px; color: white; font-weight: bold; font-size: 16px; letter-spacing: 1px; border-radius: 30px; cursor: pointer; margin-top: 20px; width: 100%; transition: transform 0.2s; }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0, 120, 255, 0.4); }
        .url-box { margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; display: flex; gap: 10px; }
        input[type="text"] { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid #333; padding: 10px; color: white; border-radius: 4px; }
        .btn-small { background: #333; border: 1px solid #444; color: #aaa; padding: 0 15px; border-radius: 4px; cursor: pointer; }
        #playlist-ui { margin-top: 20px; max-height: 150px; overflow-y: auto; text-align: left; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; font-size: 0.9rem; color: #aaa; }
        .playlist-item { padding: 5px; border-bottom: 1px solid #333; cursor: pointer; transition: background 0.2s; }
        .playlist-item:hover { color: white; background: rgba(255,255,255,0.1); }
        .playlist-active { color: #ff9d00; font-weight: bold; }
        
        #cam-input { display: none; }
        #drop-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 210, 255, 0.2); border: 5px dashed #00d2ff; z-index: 10000; display: none; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; text-transform: uppercase; pointer-events: none; }
        #light-canvas { display: none; }
    </style>
</head>
<body>

    <div id="drop-overlay">Drop File to Play</div>
    <video id="cam-input" autoplay playsinline webkit-playsinline muted></video>

    <div id="ui-layer">
        <h1>The <span style="color: #ff9d00">Hub</span> <span style="font-size: 0.5em; vertical-align: super; color: #666">v28.0</span></h1>
        <div class="hub-card">
            <h3 style="margin: 0 0 10px; font-weight: 400;">The Gallery</h3>
            <p style="color: #888; font-size: 0.9rem;">Select media (Video, Image, PDF, GLB)</p>
            <input type="file" id="file-input" accept="video/*, image/*, .pdf, .glb" multiple style="display:none">
            <button class="btn-main" onclick="document.getElementById('file-input').click()">LOAD FILES</button>
            <div class="url-box">
                <input type="text" id="url-input" placeholder="Paste stream URL...">
                <button class="btn-small" id="btn-url">GO</button>
            </div>
            <div id="playlist-ui" style="display:none">
                <div style="color:white; font-weight:bold; margin-bottom:5px;">Queue:</div>
                <div id="playlist-list"></div>
            </div>
            <button id="btn-start" class="btn-main" style="display:none; background: #ff9d00; margin-top: 20px;">ENTER VR</button>
        </div>
    </div>

    <canvas id="light-canvas" width="32" height="32"></canvas>

    <a-scene background="color: #000" fog="type: exponential; color: #000; density: 0.015">
        
        <a-assets>
            <video id="video-src" src="" playsinline webkit-playsinline loop="false" crossorigin="anonymous"></video>
            <img id="img-src" src="" crossorigin="anonymous">
            <canvas id="pdf-canvas"></canvas>
            <img id="grid-texture" src="https://cdn.aframe.io/a-painter/images/floor.jpg">
        </a-assets>

        <a-sky id="env-sky" color="#050505"></a-sky>
        <a-plane id="env-floor" position="0 0 -4" rotation="-90 0 0" width="80" height="80" 
                 src="#grid-texture" repeat="40 40" color="#1a1a1a" roughness="0.2" metalness="0.8">
        </a-plane>

        <a-light id="ambi-light" type="ambient" color="#222" intensity="0.2"></a-light>
        <a-light id="spot-light" type="directional" position="-2 4 2" intensity="0" color="#fff"></a-light> 
        <a-light id="screen-glow" type="point" position="0 4 -4" distance="20" decay="2" intensity="0.5" color="#fff"></a-light>

        <a-gltf-model 
            id="model-viewer" 
            src="" 
            position="0 1.2 -3" 
            rotation="0 0 0" 
            scale="1 1 1"
            visible="false"
            animation="property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear; enabled: false">
        </a-gltf-model>

        <a-curvedimage id="screen-cinema" src="#video-src" height="12" radius="14" theta-length="90" rotation="0 135 0" position="0 5 0" side="double" visible="true"></a-curvedimage>
        <a-curvedimage id="screen-cinema-left" src="#video-src" height="12" radius="14" theta-length="90" rotation="0 135 0" position="0 5 0" side="double" visible="false"></a-curvedimage>
        <a-curvedimage id="screen-cinema-right" src="#video-src" height="12" radius="14" theta-length="90" rotation="0 135 0" position="0 5 0" side="double" visible="false"></a-curvedimage>
        
        <a-entity id="screen-180" visible="false"></a-entity>
        <a-videosphere id="screen-360" visible="false"></a-videosphere>

        <a-sphere id="menu-orb" position="0 -1.0 -1.5" radius="0.15" color="#00d2ff" visible="false" class="clickable" animation="property: scale; dir: alternate; dur: 1500; to: 1.1 1.1 1.1; loop: true">
            <a-light type="point" distance="2" color="#00d2ff" intensity="2"></a-light>
            <a-text value="MENU" align="center" position="0 0.25 0" width="3" color="#ffffff"></a-text>
        </a-sphere>

        <a-entity id="hub-wrapper" position="0 0.8 -1.8" rotation="-25 0 0" visible="true">
            <a-box depth="0.01" height="1.0" width="2.8" color="#ffffff" opacity="0.1" class="clickable"></a-box>
            <a-box position="0 0.49 0" depth="0.015" height="0.02" width="2.8" color="#ffffff" opacity="0.8"></a-box>
            <a-text id="txt-title" value="System Ready" position="0 0.42 0.02" align="center" width="2.5" color="#ffffff"></a-text>
            <a-circle id="btn-close" position="1.3 0.4 0.02" radius="0.08" color="#ff4444" opacity="0.8" class="clickable btn-hover"><a-text value="X" align="center" width="6" font-weight="bold" color="white"></a-text></a-circle>
            <a-plane id="btn-feed" position="-1.1 0.4 0.02" width="0.5" height="0.12" color="#ffffff" opacity="0.15" class="clickable btn-hover"><a-text id="txt-feed" value="OPEN HUD" align="center" width="2" color="white"></a-text></a-plane>

            <a-entity id="video-controls">
                <a-text id="time-display" value="00:00 / 00:00" position="0 0.35 0.02" align="center" width="2.5" color="#ccc"></a-text>
                <a-plane position="0 0.28 0.02" width="2.4" height="0.005" color="#ffffff" opacity="0.3" class="clickable btn-hover" id="bar-bg"></a-plane>
                <a-plane id="progress-fill" position="-1.2 0.28 0.03" width="2.4" height="0.01" color="#00d2ff" scale="0 1 1" pivot="center left"></a-plane>
                <a-plane id="btn-seek-back" position="-0.55 0.15 0.02" width="0.25" height="0.15" color="#ffffff" opacity="0.1" class="clickable btn-hover"><a-text id="txt-seek-back" value="-15s" align="center" width="2" color="white"></a-text></a-plane>
                <a-plane id="btn-play" position="0 0.15 0.02" width="0.7" height="0.2" color="#ffffff" opacity="0.9" class="clickable btn-hover"><a-text id="txt-play" value="PLAY" align="center" width="4" color="#000" font-weight="bold"></a-text></a-plane>
                <a-plane id="btn-seek-fwd" position="0.55 0.15 0.02" width="0.25" height="0.15" color="#ffffff" opacity="0.1" class="clickable btn-hover"><a-text id="txt-seek-fwd" value="+15s" align="center" width="2" color="white"></a-text></a-plane>
                <a-plane id="btn-speed" position="1.0 -0.1 0.02" width="0.5" height="0.15" color="#ffffff" opacity="0.1" class="clickable btn-hover"><a-text id="txt-speed" value="1x" align="center" width="2" color="white"></a-text></a-plane>
            </a-entity>

            <a-plane id="btn-prev" position="-0.9 0.15 0.02" width="0.25" height="0.15" color="#ffffff" opacity="0.1" class="clickable btn-hover"><a-text value="|<" align="center" width="3" color="white"></a-text></a-plane>
            <a-plane id="btn-next" position="0.9 0.15 0.02" width="0.25" height="0.15" color="#ffffff" opacity="0.1" class="clickable btn-hover"><a-text value=">|" align="center" width="3" color="white"></a-text></a-plane>
            <a-plane id="btn-mode" position="-1.0 -0.1 0.02" width="0.5" height="0.15" color="#ffffff" opacity="0.15" class="clickable btn-hover"><a-text value="2D VIEW" align="center" width="1.8" color="#00d2ff"></a-text></a-plane>
            <a-plane id="btn-3d" position="-0.4 -0.1 0.02" width="0.5" height="0.15" color="#ffffff" opacity="0.15" class="clickable btn-hover"><a-text id="txt-3d" value="2D MODE" align="center" width="1.8" color="#00d2ff"></a-text></a-plane>
            
            <a-plane id="btn-scale-up" position="0.2 -0.1 0.02" width="0.35" height="0.15" color="#ffffff" opacity="0.1" class="clickable btn-hover"><a-text value="SCALE +" align="center" width="1.8" color="#aaa"></a-text></a-plane>

            <a-plane id="btn-rot-left" position="0.65 -0.1 0.02" width="0.25" height="0.15" color="#ffffff" opacity="0.1" class="clickable btn-hover"><a-text value="<" align="center" width="3" color="white"></a-text></a-plane>
            <a-plane id="btn-reset" position="0.95 -0.1 0.02" width="0.3" height="0.15" color="#ffffff" opacity="0.1" class="clickable btn-hover"><a-text value="RESET" align="center" width="2" color="white"></a-text></a-plane>
            <a-plane id="btn-rot-right" position="1.25 -0.1 0.02" width="0.25" height="0.15" color="#ffffff" opacity="0.1" class="clickable btn-hover"><a-text value=">" align="center" width="3" color="white"></a-text></a-plane>
        </a-entity>

        <a-entity id="rig" position="0 1.6 0">
            <a-camera look-controls="reverseMouseDrag: true" wasd-controls="enabled: false">
                <a-cursor id="cursor" fuse="true" fuse-timeout="2500" color="#00d2ff" raycaster="objects: .clickable"
                    animation__click="property: scale; startEvents: click; from: 0.1 0.1 0.1; to: 1 1 1; dur: 150"
                    animation__fusing="property: scale; startEvents: fusing; from: 1 1 1; to: 0.1 0.1 0.1; dur: 2500"
                    animation__color="property: color; startEvents: fusing; from: #00d2ff; to: #ffffff; dur: 2500">
                </a-cursor>
                <a-plane id="ar-hud" width="6" height="3.37" position="0 0 -4" material="shader: flat; transparent: true; opacity: 1; side: double" visible="false"></a-plane>
            </a-camera>
        </a-entity>
    </a-scene>

    <script>
        const pdfjsLib = window.pdfjsLib;
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        const state = {
            playlist: [], currentTrack: 0, viewMode: 0, is3D: false, isVoid: false, curve: 90, currentObjectURL: null,
            pdf: { doc: null, pageNum: 1, rendering: false, pending: null },
            audio: { ctx: null, source: null, panner: null },
            feed: { active: false, stream: null },
            model: { currentScale: 1 }
        };

        const DOM = {
            ui: { layer: document.getElementById('ui-layer'), fileInput: document.getElementById('file-input'), urlInput: document.getElementById('url-input'), playlist: document.getElementById('playlist-ui'), list: document.getElementById('playlist-list'), btnStart: document.getElementById('btn-start'), dropOverlay: document.getElementById('drop-overlay') },
            media: { video: document.getElementById('video-src'), img: document.getElementById('img-src'), pdfCanvas: document.getElementById('pdf-canvas'), lightCanvas: document.getElementById('light-canvas'), cam: document.getElementById('cam-input') },
            vr: {
                scene: document.querySelector('a-scene'),
                arHud: document.getElementById('ar-hud'),
                modelViewer: document.getElementById('model-viewer'),
                env: { sky: document.getElementById('env-sky'), floor: document.getElementById('env-floor'), ambi: document.getElementById('ambi-light'), spot: document.getElementById('spot-light'), glow: document.getElementById('screen-glow') },
                screens: { cinema: document.getElementById('screen-cinema') }, // Shortened for brevity
                controls: { 
                    wrapper: document.getElementById('hub-wrapper'), videoGroup: document.getElementById('video-controls'), 
                    playText: document.getElementById('txt-play'), timeText: document.getElementById('time-display'), 
                    btnFeed: document.getElementById('btn-feed'), txtFeed: document.getElementById('txt-feed'),
                    btnScale: document.getElementById('btn-scale-up'), modeBtn: document.getElementById('btn-mode'), btn3d: document.getElementById('btn-3d')
                }
            }
        };

        // --- FEED LOGIC (HUD) ---
        DOM.vr.controls.btnFeed.addEventListener('click', async function() {
            if (!state.feed.active) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    state.feed.stream = stream;
                    DOM.media.cam.srcObject = stream;
                    await DOM.media.cam.play();
                    
                    const vidTex = new THREE.VideoTexture(DOM.media.cam);
                    vidTex.colorSpace = THREE.SRGBColorSpace; vidTex.generateMipmaps = false;
                    
                    const mesh = DOM.vr.arHud.getObject3D('mesh');
                    if (mesh) { mesh.material.map = vidTex; mesh.material.needsUpdate = true; mesh.material.color.setHex(0xffffff); }
                    
                    DOM.vr.arHud.setAttribute('visible', true);
                    DOM.vr.controls.txtFeed.setAttribute('value', 'CLOSE HUD');
                    this.setAttribute('opacity', '0.5'); 
                    state.feed.active = true;
                } catch (e) { alert("Cam Error: " + e.name); }
            } else {
                if (state.feed.stream) { state.feed.stream.getTracks().forEach(t => t.stop()); DOM.media.cam.srcObject = null; }
                DOM.vr.arHud.setAttribute('visible', false);
                DOM.vr.controls.txtFeed.setAttribute('value', 'OPEN HUD');
                this.setAttribute('opacity', '0.15');
                state.feed.active = false;
            }
            flash(this);
        });

        // --- NEW: SCALE BUTTON FOR MODELS ---
        DOM.vr.controls.btnScale.addEventListener('click', function() {
            if(state.playlist[state.currentTrack].type === 'model') {
                state.model.currentScale = (state.model.currentScale >= 2) ? 0.5 : state.model.currentScale + 0.5;
                const s = state.model.currentScale;
                DOM.vr.modelViewer.setAttribute('scale', `${s} ${s} ${s}`);
                flash(this);
            }
        });

        /* HANDLE FILES & GLB DETECTION */
        function handleFiles(files) {
            if (files.length > 0) {
                const newItems = Array.from(files).map(f => {
                    let type = 'video';
                    const ext = f.name.split('.').pop().toLowerCase();
                    if (f.type.startsWith('image/') || ['jpg','jpeg','png','gif','webp'].includes(ext)) { type = 'image'; } 
                    else if (f.type === 'application/pdf' || ext === 'pdf') { type = 'pdf'; }
                    else if (ext === 'glb' || ext === 'gltf') { type = 'model'; } // <--- NEW TYPE
                    return { type: type, src: f, name: f.name };
                });
                state.playlist = state.playlist.concat(newItems); updatePlaylistUI();
            }
        }
        DOM.ui.fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        document.body.addEventListener('dragover', (e) => { e.preventDefault(); DOM.ui.dropOverlay.style.display = 'flex'; });
        document.body.addEventListener('dragleave', (e) => { e.preventDefault(); DOM.ui.dropOverlay.style.display = 'none'; });
        document.body.addEventListener('drop', (e) => { e.preventDefault(); DOM.ui.dropOverlay.style.display = 'none'; handleFiles(e.dataTransfer.files); });

        function updatePlaylistUI() {
            DOM.ui.playlist.style.display = 'block'; DOM.ui.btnStart.style.display = 'block'; DOM.ui.list.innerHTML = '';
            state.playlist.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'playlist-item';
                if(index === state.currentTrack && DOM.ui.layer.classList.contains('hidden')) div.classList.add('playlist-active');
                div.innerText = `${index + 1}. [${item.type.toUpperCase()}] ${item.name}`;
                div.onclick = () => { loadTrack(index); highlightActive(); };
                DOM.ui.list.appendChild(div);
            });
        }
        function highlightActive() { Array.from(DOM.ui.list.children).forEach((child, i) => { child.classList.toggle('playlist-active', i === state.currentTrack); }); }

        DOM.ui.btnStart.addEventListener('click', () => { if(state.playlist.length > 0) { DOM.ui.layer.classList.add('hidden'); loadTrack(state.currentTrack); if(DOM.vr.scene.enterVR) DOM.vr.scene.enterVR(); } });

        /* UPDATED: MEDIA LOADER */
        function loadTrack(index) {
            if (index >= 0 && index < state.playlist.length) {
                if (state.currentObjectURL) { URL.revokeObjectURL(state.currentObjectURL); state.currentObjectURL = null; }
                state.currentTrack = index;
                const item = state.playlist[state.currentTrack];
                
                let src = "";
                if(item.src instanceof File) { src = URL.createObjectURL(item.src); state.currentObjectURL = src; } 
                else { src = item.src; }

                DOM.vr.controls.playText.setAttribute('value', 'PLAY');
                
                // Hide All Media First
                DOM.media.video.pause();
                DOM.vr.screens.cinema.setAttribute('visible', false);
                DOM.vr.modelViewer.setAttribute('visible', false);
                DOM.vr.env.spot.setAttribute('intensity', 0); // Lights off
                DOM.vr.env.ambi.setAttribute('intensity', 0.2); // Normal room dim

                if (item.type === 'model') {
                    // --- 3D MODEL MODE ---
                    DOM.vr.modelViewer.setAttribute('src', src);
                    DOM.vr.modelViewer.setAttribute('visible', true);
                    DOM.vr.modelViewer.setAttribute('animation', 'enabled: true'); // Auto spin
                    DOM.vr.controls.playText.setAttribute('value', 'PAUSE SPIN');
                    
                    // Lighting for Art
                    DOM.vr.env.ambi.setAttribute('intensity', 1.0); // Bright room
                    DOM.vr.env.spot.setAttribute('intensity', 0.8); // Spotlight
                    
                    DOM.vr.controls.modeBtn.setAttribute('color', '#555'); 
                    DOM.vr.controls.btn3d.setAttribute('color', '#555');

                } else if (item.type === 'video') {
                    DOM.media.video.src = src;
                    DOM.vr.screens.cinema.setAttribute('visible', true);
                    DOM.media.video.play();
                } else if (item.type === 'image') {
                    DOM.media.img.src = src;
                    DOM.vr.screens.cinema.setAttribute('visible', true);
                }
            }
        }

        // Shared Logic
        function flash(el) { const oldColor = el.getAttribute('color'); el.setAttribute('color', '#fff'); setTimeout(() => { if (el.getAttribute('id') === 'btn-feed' && state.feed.active) return; el.setAttribute('color', oldColor); }, 150); }
        function togglePlay() { 
            if (state.playlist[state.currentTrack].type === 'model') {
                const anim = DOM.vr.modelViewer.getAttribute('animation');
                if (anim.enabled) { 
                    DOM.vr.modelViewer.setAttribute('animation', 'enabled: false'); 
                    DOM.vr.controls.playText.setAttribute('value', 'SPIN');
                } else { 
                    DOM.vr.modelViewer.setAttribute('animation', 'enabled: true'); 
                    DOM.vr.controls.playText.setAttribute('value', 'PAUSE');
                }
            } else {
                if(DOM.media.video.paused) { DOM.media.video.play(); DOM.vr.controls.playText.setAttribute('value', 'PAUSE'); } 
                else { DOM.media.video.pause(); DOM.vr.controls.playText.setAttribute('value', 'PLAY'); } 
            }
        }
        document.getElementById('btn-play').addEventListener('click', function() { togglePlay(); flash(this); });
    </script>
</body>
</html>
