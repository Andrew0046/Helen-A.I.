<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hub v26.0: Dual Screen</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    
    <style>
        /* --- UI LAYER STYLES --- */
        body { margin: 0; overflow: hidden; background: #050505; font-family: 'Segoe UI', Roboto, sans-serif; color: white; }
        #ui-layer { position: absolute; z-index: 9999; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .hidden { opacity: 0; pointer-events: none; }
        h1 { font-weight: 200; letter-spacing: 8px; text-transform: uppercase; margin-bottom: 30px; }
        h1 span { font-weight: 700; color: #00d2ff; text-shadow: 0 0 20px rgba(0, 210, 255, 0.5); }
        .hub-card { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); padding: 40px; border-radius: 16px; width: 450px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .btn-main { background: linear-gradient(135deg, #00d2ff 0%, #0078ff 100%); border: none; padding: 15px 30px; color: white; font-weight: bold; font-size: 16px; letter-spacing: 1px; border-radius: 30px; cursor: pointer; margin-top: 20px; width: 100%; transition: transform 0.2s; }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0, 120, 255, 0.4); }
        .url-box { margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; display: flex; gap: 10px; }
        input[type="text"] { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid #333; padding: 10px; color: white; border-radius: 4px; }
        .btn-small { background: #333; border: 1px solid #444; color: #aaa; padding: 0 15px; border-radius: 4px; cursor: pointer; }
        #playlist-ui { margin-top: 20px; max-height: 150px; overflow-y: auto; text-align: left; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; font-size: 0.9rem; color: #aaa; }
        .playlist-item { padding: 5px; border-bottom: 1px solid #333; cursor: pointer; transition: background 0.2s; }
        .playlist-item:hover { color: white; background: rgba(255,255,255,0.1); }
        .playlist-active { color: #ff9d00; font-weight: bold; }
        
        /* HIDDEN VIDEO FOR CAMERA */
        #cam-input { display: none; }
        #drop-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 210, 255, 0.2); border: 5px dashed #00d2ff; z-index: 10000; display: none; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; text-transform: uppercase; pointer-events: none; }
        #light-canvas { display: none; }
    </style>
</head>
<body>

    <div id="drop-overlay">Drop File to Play</div>
    
    <video id="cam-input" autoplay playsinline webkit-playsinline muted></video>

    <div id="ui-layer">
        <h1>The <span style="color: #ff9d00">Hub</span> <span style="font-size: 0.5em; vertical-align: super; color: #666">v26.0</span></h1>
        <div class="hub-card">
            <h3 style="margin: 0 0 10px; font-weight: 400;">Dual Screen System</h3>
            <p style="color: #888; font-size: 0.9rem;">Select media (Video, Image, PDF)</p>
            <input type="file" id="file-input" accept="video/*, image/*, .pdf" multiple style="display:none">
            <button class="btn-main" onclick="document.getElementById('file-input').click()">LOAD FILES</button>
            <div class="url-box">
                <input type="text" id="url-input" placeholder="Paste stream URL...">
                <button class="btn-small" id="btn-url">GO</button>
            </div>
            <div id="playlist-ui" style="display:none">
                <div style="color:white; font-weight:bold; margin-bottom:5px;">Queue:</div>
                <div id="playlist-list"></div>
            </div>
            <button id="btn-start" class="btn-main" style="display:none; background: #ff9d00; margin-top: 20px;">ENTER VR</button>
        </div>
    </div>

    <canvas id="light-canvas" width="32" height="32"></canvas>

    <a-scene background="color: #000" fog="type: exponential; color: #000; density: 0.015">
        
        <a-assets>
            <video id="video-src" src="" playsinline webkit-playsinline loop="false" crossorigin="anonymous"></video>
            <img id="img-src" src="" crossorigin="anonymous">
            <canvas id="pdf-canvas"></canvas>
            <img id="grid-texture" src="https://cdn.aframe.io/a-painter/images/floor.jpg">
        </a-assets>

        <a-plane id="env-floor" position="0 0 -4" rotation="-90 0 0" width="80" height="80" 
                 src="#grid-texture" repeat="40 40" color="#1a1a1a" roughness="0.2" metalness="0.8">
        </a-plane>
        <a-sky color="#050505"></a-sky>

        <a-light id="ambi-light" type="ambient" color="#222" intensity="0.2"></a-light>
        <a-light id="screen-glow" type="point" position="0 4 -4" distance="20" decay="2" intensity="0.5" color="#fff"></a-light>

        <a-curvedimage id="screen-cinema" src="#video-src" height="12" radius="14" theta-length="90" rotation="0 135 0" position="0 5 0" side="double" visible="true"></a-curvedimage>
        
        <a-curvedimage id="my-feed" 
            height="12" 
            radius="14" 
            theta-length="90" 
            rotation="0 135 0" 
            position="0 9 0" 
            side="double" 
            visible="false"
            material="opacity: 0.8; transparent: true; color: #333">
        </a-curvedimage>

        <a-curvedimage id="screen-cinema-left" src="#video-src" height="12" radius="14" theta-length="90" rotation="0 135 0" position="0 5 0" side="double" visible="false"></a-curvedimage>
        <a-curvedimage id="screen-cinema-right" src="#video-src" height="12" radius="14" theta-length="90" rotation="0 135 0" position="0 5 0" side="double" visible="false"></a-curvedimage>
        <a-entity id="screen-180" geometry="primitive: cylinder; radius: 60; height: 100; thetaLength: 180; openEnded: true; segmentsRadial: 64" material="shader: flat; side: back; src: #video-src; fog: false" rotation="0 -270 0" visible="false"></a-entity>
        <a-entity id="screen-180-left" geometry="primitive: cylinder; radius: 60; height: 100; thetaLength: 180; openEnded: true; segmentsRadial: 64" material="shader: flat; side: back; src: #video-src; fog: false" rotation="0 -270 0" visible="false"></a-entity>
        <a-entity id="screen-180-right" geometry="primitive: cylinder; radius: 60; height: 100; thetaLength: 180; openEnded: true; segmentsRadial: 64" material="shader: flat; side: back; src: #video-src; fog: false" rotation="0 -270 0" visible="false"></a-entity>
        <a-videosphere id="screen-360" src="#video-src" radius="60" rotation="0 -90 0" material="shader: flat; side: back; fog: false" visible="false"></a-videosphere>
        <a-videosphere id="screen-360-left" src="#video-src" radius="60" rotation="0 -90 0" material="shader: flat; side: back; fog: false" visible="false"></a-videosphere>
        <a-videosphere id="screen-360-right" src="#video-src" radius="60" rotation="0 -90 0" material="shader: flat; side: back; fog: false" visible="false"></a-videosphere>

        <a-sphere id="menu-orb" position="0 -1.0 -1.5" radius="0.15" color="#ff9d00" visible="false" class="clickable" animation="property: scale; dir: alternate; dur: 1500; to: 1.1 1.1 1.1; loop: true">
            <a-light type="point" distance="2" color="#ff9d00" intensity="2"></a-light>
            <a-text value="OPEN MENU" align="center" position="0 0.25 0" width="3" color="#ff9d00"></a-text>
        </a-sphere>

        <a-entity id="hub-wrapper" position="0 0.8 -1.8" rotation="-25 0 0" visible="true">
            <a-box depth="0.02" height="1.0" width="2.8" color="#050505" opacity="0.9" class="clickable"></a-box>
            <a-box position="0 0.49 0" depth="0.03" height="0.01" width="2.8" color="#ff9d00" opacity="0.8"></a-box>
            
            <a-text id="txt-title" value="Waiting..." position="0 0.42 0.02" align="center" width="2.5" color="white"></a-text>
            <a-plane id="btn-close" position="1.2 0.4 0.03" width="0.25" height="0.15" color="#cc0000" class="clickable btn-hover"><a-text value="X" align="center" width="6" font-weight="bold"></a-text></a-plane>

            <a-plane id="btn-feed" position="-1.2 0.4 0.03" width="0.45" height="0.15" color="#0078ff" class="clickable btn-hover">
                <a-text id="txt-feed" value="OPEN FEED" align="center" width="2" font-weight="bold"></a-text>
            </a-plane>

            <a-entity id="video-controls">
                <a-text id="time-display" value="00:00 / 00:00" position="0 0.35 0.02" align="center" width="2.5" color="#aaa"></a-text>
                <a-plane position="0 0.28 0.02" width="2.4" height="0.02" color="#333" class="clickable btn-hover" id="bar-bg"></a-plane>
                <a-plane id="progress-fill" position="-1.2 0.28 0.03" width="2.4" height="0.02" color="#ff9d00" scale="0 1 1" pivot="center left"></a-plane>
                
                <a-plane id="btn-seek-back" position="-0.55 0.15 0.02" width="0.25" height="0.15" color="#222" class="clickable btn-hover"><a-text id="txt-seek-back" value="-15s" align="center" width="2"></a-text></a-plane>
                <a-plane id="btn-play" position="0 0.15 0.02" width="0.7" height="0.2" color="#ff9d00" class="clickable btn-hover"><a-text id="txt-play" value="PLAY" align="center" width="4" color="black" font-weight="bold"></a-text></a-plane>
                <a-plane id="btn-seek-fwd" position="0.55 0.15 0.02" width="0.25" height="0.15" color="#222" class="clickable btn-hover"><a-text id="txt-seek-fwd" value="+15s" align="center" width="2"></a-text></a-plane>
                <a-plane id="btn-speed" position="1.0 -0.1 0.02" width="0.5" height="0.15" color="#222" class="clickable btn-hover"><a-text id="txt-speed" value="1x" align="center" width="2"></a-text></a-plane>
            </a-entity>

            <a-plane id="btn-prev" position="-0.9 0.15 0.02" width="0.25" height="0.15" color="#222" class="clickable btn-hover"><a-text value="|<<" align="center" width="3"></a-text></a-plane>
            <a-plane id="btn-next" position="0.9 0.15 0.02" width="0.25" height="0.15" color="#222" class="clickable btn-hover"><a-text value=">>|" align="center" width="3"></a-text></a-plane>

            <a-plane id="btn-mode" position="-1.0 -0.1 0.02" width="0.5" height="0.15" color="#222" class="clickable btn-hover"><a-text value="2D VIEW" align="center" width="1.8"></a-text></a-plane>
            <a-plane id="btn-3d" position="-0.4 -0.1 0.02" width="0.5" height="0.15" color="#222" class="clickable btn-hover"><a-text id="txt-3d" value="2D MODE" align="center" width="1.8"></a-text></a-plane>
            <a-plane id="btn-void" position="0.2 -0.1 0.02" width="0.35" height="0.15" color="#222" class="clickable btn-hover"><a-text value="VOID" align="center" width="1.8"></a-text></a-plane>

            <a-plane id="btn-rot-left" position="0.65 -0.1 0.02" width="0.25" height="0.15" color="#222" class="clickable btn-hover"><a-text value="< TURN" align="center" width="2"></a-text></a-plane>
            <a-plane id="btn-reset" position="0.95 -0.1 0.02" width="0.3" height="0.15" color="#222" class="clickable btn-hover"><a-text value="RESET" align="center" width="2"></a-text></a-plane>
            <a-plane id="btn-rot-right" position="1.25 -0.1 0.02" width="0.25" height="0.15" color="#222" class="clickable btn-hover"><a-text value="TURN >" align="center" width="2"></a-text></a-plane>

            <a-text value="SEAT POSITION" position="-0.8 -0.28 0.02" width="1.5" align="center" color="#666"></a-text>
            <a-text value="SCREEN CURVE" position="0.8 -0.28 0.02" width="1.5" align="center" color="#666"></a-text>
            <a-plane id="seat-front" position="-1.1 -0.35 0.02" width="0.25" height="0.1" color="#333" class="clickable btn-hover"><a-text value="FRONT" align="center" width="1.5" scale="0.8 0.8 1"></a-text></a-plane>
            <a-plane id="seat-back" position="-0.8 -0.35 0.02" width="0.25" height="0.1" color="#333" class="clickable btn-hover"><a-text value="BACK" align="center" width="1.5" scale="0.8 0.8 1"></a-text></a-plane>
            <a-plane id="seat-lay" position="-0.5 -0.35 0.02" width="0.25" height="0.1" color="#333" class="clickable btn-hover"><a-text value="RECLINE" align="center" width="1.5" scale="0.8 0.8 1"></a-text></a-plane>
            <a-plane id="curve-less" position="0.6 -0.35 0.02" width="0.25" height="0.1" color="#333" class="clickable btn-hover"><a-text value="FLAT" align="center" width="1.5" scale="0.8 0.8 1"></a-text></a-plane>
            <a-plane id="curve-more" position="1.0 -0.35 0.02" width="0.25" height="0.1" color="#333" class="clickable btn-hover"><a-text value="CURVE" align="center" width="1.5" scale="0.8 0.8 1"></a-text></a-plane>
        </a-entity>

        <a-entity id="rig" position="0 1.6 0">
            <a-camera look-controls="reverseMouseDrag: true" wasd-controls="enabled: false">
                <a-cursor id="cursor" fuse="true" fuse-timeout="2500" color="#ff9d00" raycaster="objects: .clickable"
                    animation__click="property: scale; startEvents: click; from: 0.1 0.1 0.1; to: 1 1 1; dur: 150"
                    animation__fusing="property: scale; startEvents: fusing; from: 1 1 1; to: 0.1 0.1 0.1; dur: 2500"
                    animation__color="property: color; startEvents: fusing; from: #ff9d00; to: #ff0000; dur: 2500">
                </a-cursor>
            </a-camera>
        </a-entity>
    </a-scene>

    <script>
        const pdfjsLib = window.pdfjsLib;
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        const state = {
            playlist: [], currentTrack: 0, viewMode: 0, is3D: false, isVoid: false, curve: 90, currentObjectURL: null,
            pdf: { doc: null, pageNum: 1, rendering: false, pending: null },
            audio: { ctx: null, source: null, panner: null },
            feed: { active: false, stream: null }
        };

        const DOM = {
            ui: { layer: document.getElementById('ui-layer'), fileInput: document.getElementById('file-input'), urlInput: document.getElementById('url-input'), playlist: document.getElementById('playlist-ui'), list: document.getElementById('playlist-list'), btnStart: document.getElementById('btn-start'), dropOverlay: document.getElementById('drop-overlay') },
            media: { video: document.getElementById('video-src'), img: document.getElementById('img-src'), pdfCanvas: document.getElementById('pdf-canvas'), lightCanvas: document.getElementById('light-canvas'), cam: document.getElementById('cam-input') },
            vr: {
                scene: document.querySelector('a-scene'),
                feedScreen: document.getElementById('my-feed'),
                screens: { 
                    cinema: document.getElementById('screen-cinema'), cyl: document.getElementById('screen-180'), sphere: document.getElementById('screen-360'),
                    cinemaL: document.getElementById('screen-cinema-left'), cylL: document.getElementById('screen-180-left'), sphereL: document.getElementById('screen-360-left'),
                    cinemaR: document.getElementById('screen-cinema-right'), cylR: document.getElementById('screen-180-right'), sphereR: document.getElementById('screen-360-right')
                },
                controls: { 
                    wrapper: document.getElementById('hub-wrapper'), videoGroup: document.getElementById('video-controls'), orb: document.getElementById('menu-orb'),
                    playText: document.getElementById('txt-play'), timeText: document.getElementById('time-display'), progress: document.getElementById('progress-fill'), title: document.getElementById('txt-title'),
                    seekBack: document.getElementById('txt-seek-back'), seekFwd: document.getElementById('txt-seek-fwd'), modeBtn: document.getElementById('btn-mode'), btn3d: document.getElementById('btn-3d'), txt3d: document.getElementById('txt-3d'), speedText: document.getElementById('txt-speed'),
                    btnFeed: document.getElementById('btn-feed'), txtFeed: document.getElementById('txt-feed')
                },
                env: { floor: document.getElementById('env-floor'), ambi: document.getElementById('ambi-light'), glow: document.getElementById('screen-glow'), rig: document.getElementById('rig') }
            }
        };

        // --- NEW: FEED TOGGLE LOGIC (HELEN STYLE) ---
        DOM.vr.controls.btnFeed.addEventListener('click', async function() {
            if (!state.feed.active) {
                // START CAM
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    state.feed.stream = stream;
                    DOM.media.cam.srcObject = stream;
                    await DOM.media.cam.play();
                    
                    // Manually Create ThreeJS Texture (Helen Method)
                    const vidTex = new THREE.VideoTexture(DOM.media.cam);
                    vidTex.colorSpace = THREE.SRGBColorSpace;
                    vidTex.generateMipmaps = false;
                    
                    // Apply to Screen
                    const mesh = DOM.vr.feedScreen.getObject3D('mesh');
                    if (mesh) {
                        mesh.material.map = vidTex;
                        mesh.material.needsUpdate = true;
                        mesh.material.color.setHex(0xffffff);
                    }
                    
                    DOM.vr.feedScreen.setAttribute('visible', true);
                    DOM.vr.controls.txtFeed.setAttribute('value', 'CLOSE FEED');
                    this.setAttribute('color', '#00ff00');
                    state.feed.active = true;
                    
                } catch (e) {
                    alert("Cam Error: " + e.name);
                }
            } else {
                // STOP CAM
                if (state.feed.stream) {
                    state.feed.stream.getTracks().forEach(t => t.stop());
                    DOM.media.cam.srcObject = null;
                }
                DOM.vr.feedScreen.setAttribute('visible', false);
                DOM.vr.controls.txtFeed.setAttribute('value', 'OPEN FEED');
                this.setAttribute('color', '#0078ff');
                state.feed.active = false;
            }
            flash(this);
        });

        /* 1. STEREOSCOPIC LAYERS */
        function configureStereoLayers() {
            const setLayer = (el, layerIndex) => {
                if(!el) return;
                const mesh = el.getObject3D('mesh');
                if(mesh) { mesh.layers.set(layerIndex); } 
                else {
                    el.addEventListener('model-loaded', () => { el.getObject3D('mesh').layers.set(layerIndex); });
                    el.addEventListener('loaded', () => { if(el.getObject3D('mesh')) el.getObject3D('mesh').layers.set(layerIndex); });
                }
            };
            setLayer(DOM.vr.screens.cinemaL, 1); setLayer(DOM.vr.screens.cylL, 1); setLayer(DOM.vr.screens.sphereL, 1);
            setLayer(DOM.vr.screens.cinemaR, 2); setLayer(DOM.vr.screens.cylR, 2); setLayer(DOM.vr.screens.sphereR, 2);
            setLayer(DOM.vr.screens.cinema, 0); setLayer(DOM.vr.screens.cyl, 0); setLayer(DOM.vr.screens.sphere, 0);
        }
        if (DOM.vr.scene.hasLoaded) { configureStereoLayers(); } else { DOM.vr.scene.addEventListener('loaded', configureStereoLayers); }

        /* 2. TEXTURE MAPPING LOGIC */
        function enforceStereoMapping() {
            const setLeft = (el) => {
                const mesh = el.getObject3D('mesh');
                if (!mesh || !mesh.material || !mesh.material.map) return;
                mesh.material.map.repeat.set(0.5, 1);
                mesh.material.map.offset.set(0, 0);
                mesh.material.map.needsUpdate = true;
            };
            const setRight = (el) => {
                const mesh = el.getObject3D('mesh');
                if (!mesh || !mesh.material || !mesh.material.map) return;
                if (!mesh.material.map.isClonedForStereo) {
                    mesh.material.map = mesh.material.map.clone();
                    mesh.material.map.needsUpdate = true;
                    mesh.material.map.isClonedForStereo = true;
                }
                mesh.material.map.repeat.set(0.5, 1);
                mesh.material.map.offset.set(0.5, 0);
            };
            [DOM.vr.screens.cinemaL, DOM.vr.screens.cylL, DOM.vr.screens.sphereL].forEach(setLeft);
            [DOM.vr.screens.cinemaR, DOM.vr.screens.cylR, DOM.vr.screens.sphereR].forEach(setRight);
        }

        function resetStereoMapping() {
            const reset = (el) => {
                const mesh = el.getObject3D('mesh');
                if (!mesh || !mesh.material || !mesh.material.map) return;
                mesh.material.map.repeat.set(1, 1);
                mesh.material.map.offset.set(0, 0);
                mesh.material.map.needsUpdate = true;
            };
            Object.values(DOM.vr.screens).forEach(reset);
        }

        /* 3. FILE HANDLING */
        function handleFiles(files) {
            if (files.length > 0) {
                const newItems = Array.from(files).map(f => {
                    let type = 'video';
                    const ext = f.name.split('.').pop().toLowerCase();
                    if (f.type.startsWith('image/') || ['jpg','jpeg','png','gif','webp'].includes(ext)) { type = 'image'; } 
                    else if (f.type === 'application/pdf' || ext === 'pdf') { type = 'pdf'; }
                    return { type: type, src: f, name: f.name };
                });
                state.playlist = state.playlist.concat(newItems); updatePlaylistUI();
            }
        }
        DOM.ui.fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        document.body.addEventListener('dragover', (e) => { e.preventDefault(); DOM.ui.dropOverlay.style.display = 'flex'; });
        document.body.addEventListener('dragleave', (e) => { e.preventDefault(); DOM.ui.dropOverlay.style.display = 'none'; });
        document.body.addEventListener('drop', (e) => { e.preventDefault(); DOM.ui.dropOverlay.style.display = 'none'; handleFiles(e.dataTransfer.files); });

        document.getElementById('btn-url').addEventListener('click', () => {
            const url = DOM.ui.urlInput.value.trim();
            if(url) {
                const ext = url.split('.').pop().toLowerCase();
                let type = 'video';
                if(['jpg','jpeg','png','gif'].includes(ext)) type = 'image';
                if(ext === 'pdf') type = 'pdf';
                state.playlist.push({ type: type, src: url, name: "Web Stream" });
                DOM.ui.urlInput.value = ""; updatePlaylistUI();
            }
        });

        function updatePlaylistUI() {
            DOM.ui.playlist.style.display = 'block'; DOM.ui.btnStart.style.display = 'block'; DOM.ui.list.innerHTML = '';
            state.playlist.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'playlist-item';
                if(index === state.currentTrack && DOM.ui.layer.classList.contains('hidden')) div.classList.add('playlist-active');
                div.innerText = `${index + 1}. [${item.type.toUpperCase()}] ${item.name}`;
                div.onclick = () => { loadTrack(index); highlightActive(); };
                DOM.ui.list.appendChild(div);
            });
        }
        function highlightActive() { Array.from(DOM.ui.list.children).forEach((child, i) => { child.classList.toggle('playlist-active', i === state.currentTrack); }); }

        DOM.ui.btnStart.addEventListener('click', () => {
            if(state.playlist.length > 0) {
                DOM.ui.layer.classList.add('hidden');
                loadTrack(state.currentTrack);
                if(DOM.vr.scene.enterVR) DOM.vr.scene.enterVR();
            }
        });

        /* 4. MEDIA LOADER */
        function loadTrack(index) {
            if (index >= 0 && index < state.playlist.length) {
                if (state.currentObjectURL) { URL.revokeObjectURL(state.currentObjectURL); state.currentObjectURL = null; }
                state.currentTrack = index;
                const item = state.playlist[state.currentTrack];
                
                let src = "";
                if(item.src instanceof File) { src = URL.createObjectURL(item.src); state.currentObjectURL = src; } 
                else { src = item.src; }

                let displayName = item.name.length > 25 ? item.name.substring(0, 22) + "..." : item.name;
                DOM.vr.controls.title.setAttribute('value', `${state.currentTrack + 1}/${state.playlist.length}: ${displayName}`);

                DOM.vr.controls.seekBack.setAttribute('value', '-15s'); DOM.vr.controls.seekFwd.setAttribute('value', '+15s');
                DOM.vr.controls.playText.setAttribute('value', 'PLAY'); DOM.vr.controls.videoGroup.setAttribute('visible', true);
                DOM.vr.controls.modeBtn.setAttribute('color', '#222'); DOM.vr.controls.btn3d.setAttribute('color', '#222'); DOM.vr.controls.btn3d.classList.add('clickable');

                if (item.type === 'pdf') {
                    DOM.media.video.pause(); force2DMode(); 
                    DOM.vr.controls.modeBtn.setAttribute('color', '#555'); DOM.vr.controls.btn3d.setAttribute('color', '#555'); DOM.vr.controls.btn3d.classList.remove('clickable');
                    DOM.vr.controls.seekBack.setAttribute('value', 'PREV PG'); DOM.vr.controls.seekFwd.setAttribute('value', 'NEXT PG'); DOM.vr.controls.playText.setAttribute('value', 'LOADING..');
                    const loadingTask = pdfjsLib.getDocument(src);
                    loadingTask.promise.then(pdf => {
                        state.pdf.doc = pdf; state.pdf.pageNum = 1; DOM.vr.controls.playText.setAttribute('value', 'PDF VIEW'); renderPDFPage(state.pdf.pageNum);
                    }).catch(error => { DOM.vr.controls.playText.setAttribute('value', 'ERROR'); });
                } else if (item.type === 'image') {
                    DOM.media.video.pause(); DOM.vr.controls.videoGroup.setAttribute('visible', false);
                    updateTexture('#img-src'); 
                    DOM.media.img.onload = function() { 
                        refreshTextureMesh(); drawAmbilight(DOM.media.img); 
                        if(state.is3D) enforceStereoMapping(); else resetStereoMapping();
                    }; 
                    DOM.media.img.src = src;
                } else {
                    DOM.media.video.src = src; updateTexture('#video-src'); initAudio();
                    DOM.media.video.play().then(() => { 
                        DOM.vr.controls.playText.setAttribute('value', 'PAUSE'); 
                        setTimeout(() => { if(state.is3D) enforceStereoMapping(); else resetStereoMapping(); }, 200); 
                    }).catch(e => DOM.vr.controls.playText.setAttribute('value', 'PLAY'));
                    requestAnimationFrame(updateAmbilight);
                }
            }
        }

        /* 5. TEXTURE & HELPERS */
        function updateTexture(sourceId) {
            Object.values(DOM.vr.screens).forEach(s => {
                if(s.tagName.toLowerCase() === 'a-curvedimage' || s.tagName.toLowerCase() === 'a-videosphere') s.setAttribute('src', sourceId);
                else s.setAttribute('material', 'src', sourceId);
            });
            configureStereoLayers();
        }
        function refreshTextureMesh() { Object.values(DOM.vr.screens).forEach(el => { const mesh = el.getObject3D('mesh'); if (mesh && mesh.material.map) mesh.material.map.needsUpdate = true; }); }

        function updateVisibility() {
            Object.values(DOM.vr.screens).forEach(s => s.setAttribute('visible', false));
            DOM.vr.env.floor.setAttribute('visible', !state.isVoid);
            
            if (state.viewMode === 0) {
                if (state.is3D) { DOM.vr.screens.cinemaL.setAttribute('visible', true); DOM.vr.screens.cinemaR.setAttribute('visible', true); configureStereoLayers(); enforceStereoMapping(); } 
                else { DOM.vr.screens.cinema.setAttribute('visible', true); resetStereoMapping(); }
                const modeText = DOM.vr.controls.modeBtn.querySelector('a-text'); if(modeText) modeText.setAttribute('value', '2D VIEW');
                if(!state.isVoid) DOM.vr.scene.setAttribute('fog', 'type: exponential; color: #000; density: 0.015'); else DOM.vr.scene.removeAttribute('fog');
            } else if (state.viewMode === 1) {
                if (state.is3D) { DOM.vr.screens.cylL.setAttribute('visible', true); DOM.vr.screens.cylR.setAttribute('visible', true); configureStereoLayers(); enforceStereoMapping(); } 
                else { DOM.vr.screens.cyl.setAttribute('visible', true); resetStereoMapping(); }
                DOM.vr.controls.modeBtn.querySelector('a-text').setAttribute('value', '180 IMAX'); DOM.vr.scene.removeAttribute('fog');
            } else {
                if (state.is3D) { DOM.vr.screens.sphereL.setAttribute('visible', true); DOM.vr.screens.sphereR.setAttribute('visible', true); configureStereoLayers(); enforceStereoMapping(); } 
                else { DOM.vr.screens.sphere.setAttribute('visible', true); resetStereoMapping(); }
                DOM.vr.controls.modeBtn.querySelector('a-text').setAttribute('value', '360 FULL'); DOM.vr.scene.removeAttribute('fog');
            }
            DOM.vr.controls.txt3d.setAttribute('value', state.is3D ? "3D SBS" : "2D MODE"); DOM.vr.controls.btn3d.setAttribute('color', state.is3D ? "#ff9d00" : "#222");
        }
        function force2DMode() { state.viewMode = 0; state.is3D = false; updateVisibility(); }

        /* 6. BUTTON ACTIONS */
        DOM.vr.controls.modeBtn.addEventListener('click', function() { state.viewMode = (state.viewMode + 1) % 3; updateVisibility(); flash(this); });
        DOM.vr.controls.btn3d.addEventListener('click', function() { if(state.playlist[state.currentTrack] && state.playlist[state.currentTrack].type === 'pdf') return; state.is3D = !state.is3D; updateVisibility(); flash(this); });
        
        document.getElementById('btn-close').addEventListener('click', function() { toggleMenu(false); flash(this); });
        document.getElementById('menu-orb').addEventListener('click', function() { toggleMenu(true); flash(this); });
        document.getElementById('btn-play').addEventListener('click', function() { if(state.playlist[state.currentTrack].type === 'video') togglePlay(); flash(this); });
        document.getElementById('btn-prev').addEventListener('click', function() { if(state.currentTrack > 0) loadTrack(state.currentTrack - 1); flash(this); });
        document.getElementById('btn-next').addEventListener('click', function() { if(state.currentTrack < state.playlist.length - 1) loadTrack(state.currentTrack + 1); flash(this); });
        document.getElementById('btn-seek-back').addEventListener('click', function() { if(state.playlist[state.currentTrack].type === 'pdf') onPrevPage(); else DOM.media.video.currentTime = Math.max(0, DOM.media.video.currentTime - 15); flash(this); });
        document.getElementById('btn-seek-fwd').addEventListener('click', function() { if(state.playlist[state.currentTrack].type === 'pdf') onNextPage(); else DOM.media.video.currentTime = Math.min(DOM.media.video.duration, DOM.media.video.currentTime + 15); flash(this); });
        document.getElementById('btn-void').addEventListener('click', function() { state.isVoid = !state.isVoid; updateVisibility(); flash(this); });
        document.getElementById('btn-speed').addEventListener('click', function() { const speeds = [1, 1.25, 1.5, 2, 0.5, 0.75]; const v = DOM.media.video; v.playbackRate = speeds[(speeds.indexOf(v.playbackRate) + 1) % speeds.length]; DOM.vr.controls.speedText.setAttribute('value', v.playbackRate + 'x'); flash(this); });

        document.getElementById('btn-rot-left').addEventListener('click', function() { DOM.vr.env.rig.object3D.rotation.y += (Math.PI / 12); flash(this); });
        document.getElementById('btn-rot-right').addEventListener('click', function() { DOM.vr.env.rig.object3D.rotation.y -= (Math.PI / 12); flash(this); });
        document.getElementById('btn-reset').addEventListener('click', function() {
            const rig = DOM.vr.env.rig.object3D; const cam = document.querySelector('[camera]').object3D;
            rig.rotation.y += cam.rotation.y; 
            rig.rotation.x = 0; rig.rotation.z = 0; rig.position.set(0, 1.6, 0);
            DOM.vr.controls.wrapper.setAttribute('rotation', '-25 0 0');
            flash(this);
        });

        /* 7. ANIMATION */
        function animateSeat(targetPos, targetRot) {
            DOM.vr.env.rig.removeAttribute('animation');
            DOM.vr.env.rig.setAttribute('animation', { property: 'position', to: targetPos, dur: 1000, easing: 'easeInOutQuad' });
            DOM.vr.controls.wrapper.setAttribute('rotation', targetRot);
        }
        const seats = { front: { pos: "0 1.6 -1", rot: "-25 0 0" }, back: { pos: "0 2.5 2", rot: "-25 0 0" }, recline: { pos: "0 0.5 0", rot: "-45 0 0" } };
        document.getElementById('seat-front').addEventListener('click', function() { animateSeat(seats.front.pos, seats.front.rot); flash(this); });
        document.getElementById('seat-back').addEventListener('click', function() { animateSeat(seats.back.pos, seats.back.rot); flash(this); });
        document.getElementById('seat-lay').addEventListener('click', function() { animateSeat(seats.recline.pos, seats.recline.rot); flash(this); });

        function updateScreenCurve() {
            const screens = [DOM.vr.screens.cinema, DOM.vr.screens.cinemaL, DOM.vr.screens.cinemaR];
            const rot = 180 - (state.curve / 2);
            screens.forEach(s => { s.setAttribute('theta-length', state.curve); s.setAttribute('rotation', `0 ${rot} 0`); });
        }
        document.getElementById('curve-more').addEventListener('click', function() { if(state.curve < 160) { state.curve += 10; updateScreenCurve(); flash(this); }});
        document.getElementById('curve-less').addEventListener('click', function() { if(state.curve > 30) { state.curve -= 10; updateScreenCurve(); flash(this); }});

        /* 8. LOOP */
        setInterval(() => {
            const currentItem = state.playlist[state.currentTrack]; const v = DOM.media.video;
            if(currentItem && currentItem.type === 'video' && v.duration) {
                const pct = v.currentTime / v.duration; DOM.vr.controls.progress.object3D.scale.x = pct; DOM.vr.controls.progress.object3D.position.x = -1.2 + (2.4 * pct / 2);
                const m = Math.floor(v.currentTime/60); const sec = Math.floor(v.currentTime%60); const dm = Math.floor(v.duration/60); const dsec = Math.floor(v.duration%60);
                DOM.vr.controls.timeText.setAttribute('value', `${m}:${sec<10?'0'+sec:sec} / ${dm}:${dsec<10?'0'+dsec:dsec}`);
            }
        }, 500);
        const ctx = DOM.media.lightCanvas.getContext('2d');
        function updateAmbilight() { if(state.playlist[state.currentTrack] && state.playlist[state.currentTrack].type === 'video' && !DOM.media.video.paused) { drawAmbilight(DOM.media.video); requestAnimationFrame(updateAmbilight); } }
        function drawAmbilight(source) { try { ctx.drawImage(source, 0, 0, 32, 32); const p = ctx.getImageData(16,16,1,1).data; const hex = "#" + ((1<<24)+(p[0]<<16)+(p[1]<<8)+p[2]).toString(16).slice(1); if(state.viewMode === 0 && !state.isVoid) DOM.vr.env.ambi.setAttribute('color', hex); DOM.vr.env.glow.setAttribute('color', hex); } catch(e) { } }
        DOM.media.video.addEventListener('ended', () => { if (state.currentTrack < state.playlist.length - 1) loadTrack(state.currentTrack + 1); });
        window.addEventListener('keydown', (e) => { if(DOM.ui.layer.classList.contains('hidden')) { const isPdf = state.playlist[state.currentTrack] && state.playlist[state.currentTrack].type === 'pdf'; switch(e.code) { case 'Space': e.preventDefault(); if(!isPdf) togglePlay(); break; case 'ArrowRight': if(isPdf) onNextPage(); else DOM.media.video.currentTime += 15; break; case 'ArrowLeft': if(isPdf) onPrevPage(); else DOM.media.video.currentTime -= 15; break; } } });
        function renderPDFPage(num) { state.pdf.rendering = true; state.pdf.doc.getPage(num).then(page => { const viewport = page.getViewport({scale: 2.0}); const canvas = DOM.media.pdfCanvas; const ctx = canvas.getContext('2d'); canvas.height = viewport.height; canvas.width = viewport.width; const renderContext = { canvasContext: ctx, viewport: viewport }; page.render(renderContext).promise.then(() => { state.pdf.rendering = false; updateTexture('#pdf-canvas'); refreshTextureMesh(); drawAmbilight(canvas); const pct = num / state.pdf.doc.numPages; DOM.vr.controls.progress.object3D.scale.x = pct; DOM.vr.controls.progress.object3D.position.x = -1.2 + (2.4 * pct / 2); DOM.vr.controls.timeText.setAttribute('value', `Page ${num} / ${state.pdf.doc.numPages}`); if (state.pdf.pending !== null) { renderPDFPage(state.pdf.pending); state.pdf.pending = null; } }); }); }
        function queueRenderPage(num) { if (state.pdf.rendering) state.pdf.pending = num; else renderPDFPage(num); }
        function onPrevPage() { if (state.pdf.pageNum <= 1) return; state.pdf.pageNum--; queueRenderPage(state.pdf.pageNum); }
        function onNextPage() { if (state.pdf.pageNum >= state.pdf.doc.numPages) return; state.pdf.pageNum++; queueRenderPage(state.pdf.pageNum); }
        function toggleMenu(show) { DOM.vr.controls.wrapper.setAttribute('visible', show); if(show) { DOM.vr.controls.wrapper.setAttribute('scale', '1 1 1'); DOM.vr.controls.orb.setAttribute('visible', false); } else { DOM.vr.controls.wrapper.setAttribute('scale', '0 0 0'); DOM.vr.controls.orb.setAttribute('visible', true); } }
        function flash(el) { const oldColor = el.getAttribute('color'); el.setAttribute('color', '#fff'); setTimeout(() => el.setAttribute('color', oldColor), 150); }
        function togglePlay() { if(state.audio.ctx && state.audio.ctx.state === 'suspended') state.audio.ctx.resume(); if(DOM.media.video.paused) { DOM.media.video.play(); DOM.vr.controls.playText.setAttribute('value', 'PAUSE'); } else { DOM.media.video.pause(); DOM.vr.controls.playText.setAttribute('value', 'PLAY'); } }
        function initAudio() { if(!state.audio.ctx) { state.audio.ctx = new (window.AudioContext || window.webkitAudioContext)(); } if (!state.audio.source) { state.audio.source = state.audio.ctx.createMediaElementSource(DOM.media.video); const gainNode = state.audio.ctx.createGain(); gainNode.gain.value = 3.0; state.audio.panner = state.audio.ctx.createPanner(); state.audio.panner.panningModel = 'HRTF'; state.audio.panner.distanceModel = 'inverse'; state.audio.panner.setPosition(0, 4.5, -5); state.audio.source.connect(gainNode); gainNode.connect(state.audio.panner); state.audio.panner.connect(state.audio.ctx.destination); } if(state.audio.ctx.state === 'suspended') state.audio.ctx.resume(); }
    </script>
</body>
</html>
