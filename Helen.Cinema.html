<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hub v19.0: Canvas Bypass</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; background: #050505; font-family: sans-serif; color: white; }
        #ui-layer { position: absolute; z-index: 9999; top: 0; left: 0; width: 100%; height: 100%; background: #111; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn-main { background: #00d2ff; border: none; padding: 15px 30px; color: black; font-weight: bold; border-radius: 30px; margin: 10px; cursor: pointer; }
        
        /* DEBUG: Show the raw video and canvas tiny in the corner so we know they work */
        #debug-panel { position: absolute; bottom: 10px; left: 10px; z-index: 10000; display: flex; gap: 5px; }
        #cam-video-hidden { width: 100px; height: 60px; background: red; object-fit: cover; }
        #cam-canvas-hidden { width: 100px; height: 60px; background: blue; }
    </style>

    <script>
        // --- COMPONENT: FORCE CANVAS UPDATE ---
        AFRAME.registerComponent('canvas-updater', {
            tick: function () {
                var el = this.el;
                var material = el.getObject3D('mesh').material;
                if (material.map) {
                    material.map.needsUpdate = true;
                }
            }
        });
    </script>
</head>
<body>

    <div id="ui-layer">
        <h1>v19.0 CANVAS BYPASS</h1>
        <p>1. Allow Camera. 2. Verify small video below is moving.</p>
        <button class="btn-main" onclick="startCameraSystem()">1. START CAMERA</button>
        <button id="btn-enter-vr" class="btn-main" style="background: #ff9d00; display:none" onclick="enterVR()">2. ENTER VR</button>
        
        <input type="file" id="file-input" style="display:none" multiple>
    </div>

    <div id="debug-panel">
        <video id="cam-video-hidden" autoplay playsinline muted></video>
        <canvas id="cam-canvas-hidden" width="512" height="512"></canvas>
    </div>

    <a-scene background="color: #000">
        
        <a-assets>
            <video id="video-src" src="" playsinline webkit-playsinline loop="false" crossorigin="anonymous"></video>
            <img id="grid-texture" src="https://cdn.aframe.io/a-painter/images/floor.jpg">
        </a-assets>

        <a-sky id="env-sky" radius="500" color="#050505" material="shader: flat; src: #cam-canvas-hidden" canvas-updater></a-sky>

        <a-plane position="0 2 -3" width="2" height="0.5" color="#000" opacity="0.8">
            <a-text id="vr-debug" value="Waiting for Cam..." align="center" width="4" color="#00ff00"></a-text>
        </a-plane>

        <a-curvedimage id="screen-cinema" src="#video-src" height="12" radius="14" theta-length="90" rotation="0 135 0" position="0 5 0" side="double"></a-curvedimage>

        <a-entity id="hub-wrapper" position="0 0.8 -1.8" rotation="-25 0 0">
            <a-box depth="0.02" height="1.0" width="2.8" color="#050505" opacity="0.9" class="clickable"></a-box>
            
            <a-plane id="btn-cam" position="-1.2 0.4 0.03" width="0.4" height="0.15" color="#0078ff" class="clickable btn-hover">
                <a-text id="txt-cam" value="CAM ON" align="center" width="2" font-weight="bold"></a-text>
            </a-plane>

            <a-plane id="btn-play" position="0 0.15 0.02" width="0.7" height="0.2" color="#ff9d00" class="clickable btn-hover">
                <a-text id="txt-play" value="PLAY MOVIE" align="center" width="4" color="black" font-weight="bold"></a-text>
            </a-plane>

             <a-plane id="btn-close" position="1.2 0.4 0.03" width="0.25" height="0.15" color="#cc0000" class="clickable btn-hover">
                <a-text value="X" align="center" width="6" font-weight="bold"></a-text>
            </a-plane>
        </a-entity>

        <a-entity id="rig" position="0 1.6 0">
            <a-camera look-controls="reverseMouseDrag: true" wasd-controls="enabled: false">
                <a-cursor color="#ff9d00" fuse="true" fuse-timeout="1500"></a-cursor>
            </a-camera>
        </a-entity>
    </a-scene>

    <script>
        const DOM = {
            ui: { layer: document.getElementById('ui-layer'), btnEnter: document.getElementById('btn-enter-vr') },
            media: { 
                video: document.getElementById('cam-video-hidden'), // The raw video
                canvas: document.getElementById('cam-canvas-hidden'), // The painter
                ctx: document.getElementById('cam-canvas-hidden').getContext('2d')
            },
            vr: { 
                sky: document.getElementById('env-sky'),
                debug: document.getElementById('vr-debug'),
                btnCam: document.getElementById('btn-cam'),
                txtCam: document.getElementById('txt-cam'),
                menu: document.getElementById('hub-wrapper')
            }
        };

        let isPainting = false;

        // --- 1. START CAMERA & CANVAS LOOP ---
        async function startCameraSystem() {
            try {
                // Get Stream
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                }).catch(() => navigator.mediaDevices.getUserMedia({ video: true }));

                // Attach to Video Element
                DOM.media.video.srcObject = stream;
                await DOM.media.video.play();
                
                // Start The Painting Loop
                isPainting = true;
                paintCanvas();
                
                // Unlock VR Button
                DOM.ui.btnEnter.style.display = 'block';
                DOM.vr.debug.setAttribute('value', 'Cam Ready. Painting...');
                
            } catch (e) {
                alert("Error: " + e.name);
            }
        }

        // --- 2. THE PAINTER (Runs 60fps) ---
        function paintCanvas() {
            if (!isPainting) return;
            
            // Copy Video Frame -> Canvas
            if (DOM.media.video.readyState === DOM.media.video.HAVE_ENOUGH_DATA) {
                DOM.media.ctx.drawImage(DOM.media.video, 0, 0, 512, 512);
            }
            requestAnimationFrame(paintCanvas);
        }

        // --- 3. VR LOGIC ---
        function enterVR() {
            DOM.ui.layer.style.display = 'none';
            document.querySelector('a-scene').enterVR();
        }

        // --- 4. TOGGLE IN VR ---
        let showCamInVR = false;
        
        DOM.vr.btnCam.addEventListener('click', () => {
            showCamInVR = !showCamInVR;
            
            if (showCamInVR) {
                // Switch Sky to Canvas
                DOM.vr.sky.setAttribute('src', '#cam-canvas-hidden');
                DOM.vr.sky.setAttribute('color', '#FFF');
                DOM.vr.txtCam.setAttribute('value', 'CAM OFF');
                DOM.vr.debug.setAttribute('value', 'Sky: Canvas Texture');
            } else {
                // Switch Sky to Black
                DOM.vr.sky.removeAttribute('src');
                DOM.vr.sky.setAttribute('color', '#050505');
                DOM.vr.txtCam.setAttribute('value', 'CAM ON');
                DOM.vr.debug.setAttribute('value', 'Sky: Black');
            }
        });

        // Close Menu
        document.getElementById('btn-close').addEventListener('click', () => {
             DOM.vr.menu.setAttribute('visible', false);
        });
        
        // Load Movie Logic
        document.getElementById('btn-play').addEventListener('click', () => {
             document.getElementById('file-input').click();
        });
        document.getElementById('file-input').addEventListener('change', (e) => {
             const file = e.target.files[0];
             if(file) {
                 const url = URL.createObjectURL(file);
                 const v = document.getElementById('video-src');
                 v.src = url;
                 v.play();
             }
        });

    </script>
</body>
</html>
