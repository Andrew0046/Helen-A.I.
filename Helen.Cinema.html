<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hub v18.0: Nuclear Fix</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; background: #050505; font-family: sans-serif; color: white; }
        #ui-layer { position: absolute; z-index: 9999; top: 0; left: 0; width: 100%; height: 100%; background: #111; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .hidden { opacity: 0; pointer-events: none; }
        .btn-main { background: #00d2ff; border: none; padding: 15px 30px; color: black; font-weight: bold; border-radius: 30px; margin: 10px; cursor: pointer; }
        #cam-preview { width: 300px; height: 200px; background: #000; border: 2px solid #555; margin-bottom: 20px; }
    </style>

    <script>
        // --- CUSTOM COMPONENT: THE NUCLEAR UPDATER ---
        // This runs every single frame to force the texture to refresh
        AFRAME.registerComponent('cam-updater', {
            tick: function () {
                var el = this.el;
                var mesh = el.getObject3D('mesh');
                if (mesh && mesh.material.map) {
                    // Tell Three.js the video frame changed
                    mesh.material.map.needsUpdate = true;
                }
            }
        });
    </script>
</head>
<body>

    <div id="ui-layer">
        <h1>v18.0 DIAGNOSTICS</h1>
        <video id="cam-preview" autoplay playsinline muted></video>
        <button class="btn-main" onclick="toggleCamera()">1. TEST CAM HERE</button>
        <button id="btn-start" class="btn-main" style="background: #ff9d00;" onclick="enterVR()">2. ENTER VR</button>
        <p>If you don't see yourself above, VR won't work.</p>
        
        <input type="file" id="file-input" style="display:none" multiple>
    </div>

    <canvas id="light-canvas" width="32" height="32" style="display:none"></canvas>

    <a-scene background="color: #000">
        
        <a-assets>
            <video id="video-src" src="" playsinline webkit-playsinline loop="false" crossorigin="anonymous"></video>
            <video id="cam-src" autoplay playsinline webkit-playsinline muted crossorigin="anonymous"></video>
            <img id="grid-texture" src="https://cdn.aframe.io/a-painter/images/floor.jpg">
        </a-assets>

        <a-videosphere id="env-sky" radius="500" rotation="0 -90 0" color="#050505" side="back" cam-updater></a-videosphere>

        <a-plane position="0 2 -3" width="2" height="1" color="#000" opacity="0.7">
            <a-text id="debug-log" value="System Ready" align="center" width="4" color="#00ff00"></a-text>
        </a-plane>

        <a-light type="ambient" color="#222"></a-light>
        <a-light id="screen-glow" type="point" position="0 4 -4" distance="20" intensity="0.5" color="#fff"></a-light>

        <a-curvedimage id="screen-cinema" src="#video-src" height="12" radius="14" theta-length="90" rotation="0 135 0" position="0 5 0" side="double"></a-curvedimage>

        <a-entity id="hub-wrapper" position="0 0.8 -1.8" rotation="-25 0 0">
            <a-box depth="0.02" height="1.0" width="2.8" color="#050505" opacity="0.9" class="clickable"></a-box>
            
            <a-plane id="btn-cam" position="-1.2 0.4 0.03" width="0.4" height="0.15" color="#0078ff" class="clickable btn-hover">
                <a-text id="txt-cam" value="CAM ON" align="center" width="2" font-weight="bold"></a-text>
            </a-plane>

            <a-plane id="btn-play" position="0 0.15 0.02" width="0.7" height="0.2" color="#ff9d00" class="clickable btn-hover">
                <a-text id="txt-play" value="PLAY MOVIE" align="center" width="4" color="black" font-weight="bold"></a-text>
            </a-plane>

            <a-plane id="btn-close" position="1.2 0.4 0.03" width="0.25" height="0.15" color="#cc0000" class="clickable btn-hover">
                <a-text value="X" align="center" width="6" font-weight="bold"></a-text>
            </a-plane>
        </a-entity>

        <a-entity id="rig" position="0 1.6 0">
            <a-camera look-controls="reverseMouseDrag: true" wasd-controls="enabled: false">
                <a-cursor color="#ff9d00" fuse="true" fuse-timeout="1500"></a-cursor>
            </a-camera>
        </a-entity>
    </a-scene>

    <script>
        const DOM = {
            ui: { layer: document.getElementById('ui-layer'), preview: document.getElementById('cam-preview') },
            vr: { 
                sky: document.getElementById('env-sky'),
                debug: document.getElementById('debug-log'),
                btnCam: document.getElementById('btn-cam'),
                txtCam: document.getElementById('txt-cam'),
                menu: document.getElementById('hub-wrapper')
            },
            media: { cam: document.getElementById('cam-src'), video: document.getElementById('video-src') }
        };

        const state = { camActive: false, stream: null };

        function log(msg) {
            console.log(msg);
            if(DOM.vr.debug) DOM.vr.debug.setAttribute('value', msg);
        }

        // --- 1. ROBUST CAMERA TOGGLE ---
        async function toggleCamera() {
            if (state.camActive) {
                // STOP
                if (state.stream) state.stream.getTracks().forEach(t => t.stop());
                DOM.media.cam.srcObject = null;
                DOM.ui.preview.srcObject = null;
                state.camActive = false;
                
                // Reset VR
                DOM.vr.sky.removeAttribute('src');
                DOM.vr.sky.setAttribute('color', '#050505');
                DOM.vr.txtCam.setAttribute('value', 'CAM ON');
                log("Camera Stopped");
                return;
            }

            // START
            log("Requesting Camera...");
            try {
                // Ask for ANY video
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                }).catch(() => navigator.mediaDevices.getUserMedia({ video: true }));

                state.stream = stream;
                
                // 1. Attach to HIDDEN video element (for VR)
                DOM.media.cam.srcObject = stream;
                await DOM.media.cam.play();

                // 2. Attach to PREVIEW video (for 2D check)
                DOM.ui.preview.srcObject = stream;
                DOM.ui.preview.play();

                state.camActive = true;
                log("Stream Active: " + stream.id);

                // 3. APPLY TO VR SKY
                DOM.vr.sky.setAttribute('color', '#FFF'); 
                DOM.vr.sky.setAttribute('src', '#cam-src');
                DOM.vr.txtCam.setAttribute('value', 'CAM OFF');

            } catch (e) {
                log("Error: " + e.name);
                alert("Cam Error: " + e.name);
            }
        }

        // --- 2. VR ENTRY ---
        function enterVR() {
            DOM.ui.layer.style.display = 'none';
            const scene = document.querySelector('a-scene');
            if(scene.enterVR) scene.enterVR();
            
            // Re-trigger play on VR entry (iOS fix)
            if(state.camActive) {
                DOM.media.cam.play();
                log("Re-triggering Cam for VR...");
            }
        }

        // --- 3. EVENT LISTENERS ---
        DOM.vr.btnCam.addEventListener('click', () => toggleCamera());
        
        document.getElementById('btn-close').addEventListener('click', () => {
             DOM.vr.menu.setAttribute('visible', false);
        });

        // Basic Playlist Logic (Simplified for Debugging)
        document.getElementById('btn-play').addEventListener('click', () => {
             document.getElementById('file-input').click();
        });
        document.getElementById('file-input').addEventListener('change', (e) => {
             const file = e.target.files[0];
             if(file) {
                 const url = URL.createObjectURL(file);
                 DOM.media.video.src = url;
                 DOM.media.video.play();
                 log("Playing Video File");
             }
        });

    </script>
</body>
</html>
