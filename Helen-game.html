<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Helen AR: Full Controller</title>
    <style>
        /* --- CORE STYLES --- */
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', monospace; touch-action: none; }
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #050505; color: #00ffff; display: flex; 
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 9999;
        }
        h1 { text-shadow: 0 0 10px #00ffff; letter-spacing: 2px; }
        button {
            padding: 15px 30px; font-size: 18px; margin-top: 20px;
            background: transparent; color: #00ffff; border: 2px solid #00ffff; 
            font-weight: bold; cursor: pointer; transition: all 0.3s;
            box-shadow: 0 0 15px rgba(0,255,255,0.2);
        }
        button:hover { background: #00ffff; color: #000; box-shadow: 0 0 30px rgba(0,255,255,0.6); }

        #vr-container { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .vr-eye { position: absolute; top: 0; width: 50%; height: 100%; overflow: hidden; border-right: 2px solid #000; box-sizing: border-box; }
        #eye-left { left: 0; } #eye-right { left: 50%; }
        .lens-vignette {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 60%, rgba(0,0,0,0.9) 90%, black 100%);
            z-index: 30; pointer-events: none;
        }
        .camera-feed {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; transform: scale(1.0); z-index: 0; will-change: transform; 
        }
        .hud-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; pointer-events: none; }
        .reticle { 
            position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; 
            border: 2px solid #00ffff; border-radius: 50%; transform: translate(-50%, -50%); 
            opacity: 0.6; box-shadow: 0 0 5px #00ffff; transition: all 0.2s;
        }
        .reticle.grab { border-color: #00ff00; background: rgba(0,255,0,0.2); width: 30px; height: 30px; }
        .hud-text { position: absolute; top: 20px; left: 20px; color: #00ffff; text-shadow: 0 0 5px #00ffff; font-size: 14px; font-weight: bold; }
        #status-msg {
            position: absolute; bottom: 100px; left: 0; width: 100%; text-align: center;
            color: #00ff00; font-size: 16px; font-weight: bold; display: none; text-shadow: 0 0 5px #00ff00;
        }
        .window-container { backface-visibility: hidden; transform-style: preserve-3d; will-change: transform; }
        .browser-bar { display: flex; padding: 5px; background: #222; border-bottom: 1px solid #00ffff; }
        .browser-input { flex: 1; background: #000; color: #fff; border: 1px solid #555; padding: 5px; font-family: monospace; font-size: 14px; }
        .browser-btn { background: #00ffff; color: #000; border: none; padding: 0 15px; font-weight: bold; cursor: pointer; margin-left: 5px; }
        .file-upload-btn { background: #00ffff; color: #000; padding: 15px; text-align: center; font-weight: bold; cursor: pointer; margin: 20px; border: 2px dashed #00ffff; }
    </style>
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.162.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.162.0/examples/jsm/" } }
    </script>
</head>
<body>
    <div id="start-screen">
        <h1>HELEN AR: FULL CONTROL</h1>
        <p>BUTTONS MAPPED</p>
        <div style="text-align:left; font-size:14px; color:#aaa; margin-top:20px; line-height:1.6;">
            ‚ùå(A): GRAB &bull; ‚≠ï(B): CLOSE<br>
            üü•(X): BROWSER &bull; üî∫(Y): YOUTUBE<br>
            L1: TERMINAL &bull; R1: UPLOAD
        </div>
        <button id="init-btn">ENTER VR</button>
    </div>
    <div id="vr-container">
        <div id="eye-left" class="vr-eye">
            <video id="vid-left" class="camera-feed" autoplay muted playsinline></video>
            <div class="lens-vignette"></div>
            <div class="hud-overlay"><div class="reticle" id="ret-l"></div><div class="hud-text">L_EYE // SYSTEM READY</div><div id="status-msg"></div></div>
        </div>
        <div id="eye-right" class="vr-eye">
            <video id="vid-right" class="camera-feed" autoplay muted playsinline></video>
            <div class="lens-vignette"></div>
            <div class="hud-overlay"><div class="reticle" id="ret-r"></div><div class="hud-text">R_EYE // SYSTEM READY</div></div>
        </div>
    </div>
    <script type="module">
        import * as THREE from 'three';
        import { CSS3DRenderer, CSS3DObject } from 'three/addons/renderers/CSS3DRenderer.js';

        let camera, rendererL, rendererR, cssL, cssR, sceneCommon, sceneL, sceneR; 
        const IPD = 0.064; 
        const player = { pos: new THREE.Vector3(0, 1.6, 5), rotY: 0, rotX: 0 }; 
        const keys = {};
        let windows = []; 
        let windowCounter = 0;
        let grabbedWindow = null; 

        // TRACK BUTTON STATES TO PREVENT RAPID FIRING
        const buttonState = {}; 

        const btn = document.getElementById('init-btn');
        btn.addEventListener('click', async () => {
            try { if ('wakeLock' in navigator) await navigator.wakeLock.request('screen'); } catch(e){}
            try { if (document.documentElement.requestFullscreen) await document.documentElement.requestFullscreen(); } catch(e){}
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('vr-container').style.display = 'block';
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: {ideal: 1280}, height: {ideal: 720} }, audio: false });
                document.getElementById('vid-left').srcObject = stream;
                document.getElementById('vid-right').srcObject = stream;
                document.getElementById('vid-left').play(); document.getElementById('vid-right').play();
            } catch (e) { alert("Camera Error"); }
            init3D();
            loadWorld(); 
        });

        // --- NEW INPUT ENGINE ---
        function updateInputs() {
            const moveSpeed = 0.05;
            const lookSpeed = 0.03;
            
            // KEYBOARD FALLBACK
            if(keys['KeyW']) { player.pos.x -= Math.sin(player.rotY) * moveSpeed; player.pos.z -= Math.cos(player.rotY) * moveSpeed; }
            if(keys['KeyS']) { player.pos.x += Math.sin(player.rotY) * moveSpeed; player.pos.z += Math.cos(player.rotY) * moveSpeed; }
            if(keys['KeyA']) { player.pos.x -= Math.cos(player.rotY) * moveSpeed; player.pos.z += Math.sin(player.rotY) * moveSpeed; }
            if(keys['KeyD']) { player.pos.x += Math.cos(player.rotY) * moveSpeed; player.pos.z -= Math.sin(player.rotY) * moveSpeed; }
            if(keys['ArrowLeft']) player.rotY += lookSpeed;
            if(keys['ArrowRight']) player.rotY -= lookSpeed;
            if(keys['ArrowUp']) player.rotX += lookSpeed;
            if(keys['ArrowDown']) player.rotX -= lookSpeed;

            // GAMEPAD LOGIC
            const gamepads = navigator.getGamepads();
            if (gamepads[0]) {
                const gp = gamepads[0];
                const deadzone = 0.1;

                // STICKS
                if (Math.abs(gp.axes[0]) > deadzone) { player.pos.x += Math.cos(player.rotY) * gp.axes[0] * moveSpeed; player.pos.z -= Math.sin(player.rotY) * gp.axes[0] * moveSpeed; }
                if (Math.abs(gp.axes[1]) > deadzone) { player.pos.x += Math.sin(player.rotY) * gp.axes[1] * moveSpeed; player.pos.z += Math.cos(player.rotY) * gp.axes[1] * moveSpeed; }
                if (Math.abs(gp.axes[2]) > deadzone) { player.rotY -= gp.axes[2] * lookSpeed; }
                if (Math.abs(gp.axes[3]) > deadzone) { player.rotX -= gp.axes[3] * lookSpeed; }

                // --- BUTTON MAPPING ---
                // Helper to detect "Single Press"
                const checkBtn = (index, action) => {
                    if (gp.buttons[index].pressed) {
                        if (!buttonState[index]) {
                            action();
                            buttonState[index] = true; // Lock it
                        }
                    } else {
                        buttonState[index] = false; // Release lock
                    }
                };

                const coords = getSpawnPos();

                // BTN 0: CROSS (A) -> GRAB
                checkBtn(0, () => toggleGrab());

                // BTN 1: CIRCLE (B) -> CLOSE WINDOW
                checkBtn(1, () => removeLastWindow());

                // BTN 2: SQUARE (X) -> BROWSER
                checkBtn(2, () => spawnWindow('browser', coords[0], coords[1], coords[2], player.rotY, "https://en.wikipedia.org/wiki/Main_Page"));

                // BTN 3: TRIANGLE (Y) -> YOUTUBE
                checkBtn(3, () => spawnWindow('youtube', coords[0], coords[1], coords[2], player.rotY, "dQw4w9WgXcQ"));

                // BTN 4: L1 -> TEXT TERMINAL
                checkBtn(4, () => spawnWindow('text', coords[0], coords[1], coords[2], player.rotY));

                // BTN 5: R1 -> UPLOAD
                checkBtn(5, () => spawnWindow('upload', coords[0], coords[1], coords[2], player.rotY));
            }
            
            player.rotX = Math.max(-1.5, Math.min(1.5, player.rotX));
        }

        // --- HELPERS ---
        function getSpawnPos() {
            const dist = 2.5;
            const x = player.pos.x - Math.sin(player.rotY) * dist;
            const z = player.pos.z - Math.cos(player.rotY) * dist;
            return [x, 1.6, z];
        }

        // --- STANDARD FUNCTIONS (Simplified for length) ---
        function syncWindows() { /* Kept same as before */
             const updates = [];
             windows.forEach(w => {
                if(!w.domL) return;
                const cL = w.domL.querySelector('.win-content');
                if(cL) updates.push({ domR: w.domR, t: cL.scrollTop, l: cL.scrollLeft });
             });
             updates.forEach(u => {
                 const cR = u.domR.querySelector('.win-content');
                 if(cR) { cR.scrollTop = u.t; cR.scrollLeft = u.l; }
             });
        }
        window.navigateBrowser = function(id, eye) {
            const win = windows.find(w => w.id === id); if(!win) return;
            const val = win.domL.querySelector('.browser-input').value;
            const url = val.startsWith('http') ? val : 'https://' + val;
            win.domL.querySelector('iframe').src = url; win.domR.querySelector('iframe').src = url;
            win.url = url; saveWorld();
        }
        window.handleUpload = function(id, el) {
             if(el.files[0]) {
                 const r = new FileReader();
                 r.onload = e => {
                     const img = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:contain;">`;
                     windows.find(w=>w.id===id).domL.querySelector('.win-content').innerHTML = img;
                     windows.find(w=>w.id===id).domR.querySelector('.win-content').innerHTML = img;
                     showStatus("UPLOADED");
                 }; r.readAsDataURL(el.files[0]);
             }
        }
        function saveWorld() {
            const data = windows.filter(w=>w.type!=='upload').map(w=>({id:w.id,type:w.type,url:w.url,x:w.objL.position.x,y:w.objL.position.y,z:w.objL.position.z,rotY:w.objL.rotation.y}));
            localStorage.setItem('helen_world_data', JSON.stringify(data));
        }
        function loadWorld() {
            const d = localStorage.getItem('helen_world_data'); if(!d) return;
            JSON.parse(d).forEach(w=>spawnWindow(w.type,w.x,w.y,w.z,w.rotY,w.url,false));
            showStatus("LOADED");
        }
        function toggleGrab() {
            if(grabbedWindow) { grabbedWindow=null; showStatus("DROPPED"); saveWorld(); }
            else {
                let min=Infinity, t=null; windows.forEach(w=>{const d=w.objL.position.distanceTo(player.pos); if(d<min){min=d;t=w;}});
                if(t && min<2.0) { grabbedWindow=t.win?t.win:t; showStatus("GRABBED"); }
            }
        }
        function updateGrabbedWindow() {
            if(!grabbedWindow) return;
            const dist=2.0;
            const x = player.pos.x - Math.sin(player.rotY)*Math.cos(player.rotX)*dist;
            const y = player.pos.y + Math.sin(player.rotX)*dist;
            const z = player.pos.z - Math.cos(player.rotY)*Math.cos(player.rotX)*dist;
            grabbedWindow.objL.position.set(x,y,z); grabbedWindow.objL.rotation.set(player.rotX, player.rotY, 0, 'YXZ');
            grabbedWindow.objR.position.set(x,y,z); grabbedWindow.objR.rotation.set(player.rotX, player.rotY, 0, 'YXZ');
        }
        function showStatus(t) { const e=document.getElementById('status-msg'); e.innerText=t; e.style.display='block'; setTimeout(()=>e.style.display='none',2000); }
        function removeLastWindow() { if(windows.length){const w=windows.pop(); sceneL.remove(w.objL); sceneR.remove(w.objR); saveWorld(); showStatus("CLOSED");} }

        function init3D() {
            sceneCommon = new THREE.Scene(); sceneL=new THREE.Scene(); sceneR=new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth/2/window.innerHeight, 0.1, 100);
            camera.rotation.order = 'YXZ';
            const l=new THREE.DirectionalLight(0xffffff,2); l.position.set(0,5,5); sceneCommon.add(l); sceneCommon.add(new THREE.AmbientLight(0xffffff,0.5));
            rendererL=createWebGL('vid-left'); rendererR=createWebGL('vid-right'); // Attach to video containers for sizing
            cssL=createCSS('vid-left'); cssR=createCSS('vid-right');
            window.addEventListener('resize', onResize); document.addEventListener('keydown', handleInput); document.addEventListener('keyup', e=>keys[e.code]=false);
            animate();
        }
        function createWebGL(id) { const p=document.getElementById(id).parentNode; const r=new THREE.WebGLRenderer({alpha:true}); r.setSize(p.clientWidth,p.clientHeight); p.appendChild(r.domElement); r.domElement.className='ar-overlay'; return r; }
        function createCSS(id) { const p=document.getElementById(id).parentNode; const r=new CSS3DRenderer(); r.setSize(p.clientWidth,p.clientHeight); p.appendChild(r.domElement); r.domElement.style.position='absolute'; r.domElement.style.top='0'; r.domElement.style.zIndex='1'; return r; }
        function onResize() { camera.aspect=window.innerWidth/2/window.innerHeight; camera.updateProjectionMatrix(); rendererL.setSize(window.innerWidth/2,window.innerHeight); rendererR.setSize(window.innerWidth/2,window.innerHeight); cssL.setSize(window.innerWidth/2,window.innerHeight); cssR.setSize(window.innerWidth/2,window.innerHeight); }
        function handleInput(e) { keys[e.code]=true; if(['1','2','3','4','5','6'].includes(e.key)) { /* Keyboard spawn logic fallback */ } }
        
        function spawnWindow(type,x,y,z,ry,url="",save=true) {
            windowCounter++; const id=windowCounter;
            const dL=createDOM(id,type,"LEFT",url); const dR=createDOM(id,type,"RIGHT",url);
            const oL=new CSS3DObject(dL); oL.scale.set(0.002,0.002,0.002); oL.position.set(x,y,z); oL.rotation.y=ry; sceneL.add(oL);
            const oR=new CSS3DObject(dR); oR.scale.set(0.002,0.002,0.002); oR.position.set(x,y,z); oR.rotation.y=ry; sceneR.add(oR);
            windows.push({id,type,url,objL:oL,objR:oR,domL:dL,domR:dR});
            if(save) saveWorld();
            showStatus(type.toUpperCase() + " OPENED");
        }
        function createDOM(id,type,eye,url) {
            const d=document.createElement('div'); d.className='window-container'; 
            d.style.cssText=`width:600px;height:400px;background:rgba(0,10,20,0.95);border:2px solid #00ffff;box-shadow:0 0 30px rgba(0,255,255,0.3);display:flex;flex-direction:column;color:#00ffff;font-family:monospace;`;
            if(type==='browser'){ d.innerHTML=`<div class="browser-bar"><input type="text" class="browser-input" value="${url}"><button class="browser-btn" onclick="window.navigateBrowser(${id},'${eye}')">GO</button></div>`; }
            else { d.innerHTML=`<div style="padding:10px;background:rgba(0,255,255,0.2);font-weight:bold;">HELEN_OS // ${type}</div>`; }
            const c=document.createElement('div'); c.className='win-content'; c.style.cssText='flex:1;overflow:auto;position:relative;';
            if(type==='text') c.innerHTML='<p style="padding:20px;font-size:24px;">> SYSTEM ONLINE.</p>';
            else if(type==='browser') c.innerHTML=`<iframe width="100%" height="100%" src="${url}" frameborder="0" style="background:#fff;"></iframe>`;
            else if(type==='youtube') c.innerHTML=`<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${url}" frameborder="0" allow="autoplay"></iframe>`;
            else if(type==='upload') c.innerHTML=`<div style="height:100%;display:flex;align-items:center;justify-content:center;"><input type="file" onchange="window.handleUpload(${id},this)" style="display:none;" id="f-${id}-${eye}"><label for="f-${id}-${eye}" class="file-upload-btn">SELECT FILE</label></div>`;
            d.appendChild(c); return d;
        }

        function animate() {
            requestAnimationFrame(animate);
            updateInputs(); updateGrabbedWindow(); syncWindows();
            const h=IPD/2;
            camera.position.copy(player.pos); camera.rotation.set(player.rotX,player.rotY,0,'YXZ');
            camera.translateX(-h); camera.updateMatrixWorld(); rendererL.render(sceneCommon,camera); cssL.render(sceneL,camera);
            camera.position.copy(player.pos); camera.rotation.set(player.rotX,player.rotY,0,'YXZ');
            camera.translateX(h); camera.updateMatrixWorld(); rendererR.render(sceneCommon,camera); cssR.render(sceneR,camera);
        }
    </script>
</body>
</html>
