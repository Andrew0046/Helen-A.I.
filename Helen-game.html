<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Helen AR: Media Center</title>
    <style>
        /* --- CORE STYLES --- */
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', monospace; }

        /* START SCREEN */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #050505; color: #00ffff; display: flex; 
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 9999;
        }
        h1 { text-shadow: 0 0 10px #00ffff; letter-spacing: 2px; }
        button {
            padding: 20px 40px; font-size: 20px; margin-top: 30px;
            background: transparent; color: #00ffff; border: 2px solid #00ffff; 
            font-weight: bold; cursor: pointer; transition: all 0.3s;
            box-shadow: 0 0 15px rgba(0,255,255,0.2);
        }
        button:hover { background: #00ffff; color: #000; box-shadow: 0 0 30px rgba(0,255,255,0.6); }

        /* VR CONTAINER */
        #vr-container { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* EYES */
        .vr-eye { position: absolute; top: 0; width: 50%; height: 100%; overflow: hidden; border-right: 2px solid #111; box-sizing: border-box; }
        #eye-left { left: 0; } #eye-right { left: 50%; }

        /* CAMERA FEED (Fixed: Not Mirrored, Zoomed to fill) */
        .camera-feed {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; transform: scale(1.2); z-index: 0;
        }

        /* LAYERS */
        .ar-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        
        .hud-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 20; pointer-events: none;
            box-shadow: inset 0 0 80px rgba(0,0,0,0.9); /* Vignette */
        }
        
        /* HUD ELEMENTS */
        .reticle { 
            position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; 
            border: 2px solid #00ffff; border-radius: 50%; transform: translate(-50%, -50%); 
            opacity: 0.6; box-shadow: 0 0 5px #00ffff;
        }
        .hud-text { 
            position: absolute; top: 20px; left: 20px; 
            color: #00ffff; text-shadow: 0 0 5px #00ffff; font-size: 14px; font-weight: bold; 
        }
    </style>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.162.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.162.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="start-screen">
        <h1>HELEN AR OS</h1>
        <p>MEDIA CENTER // ONLINE</p>
        <div style="text-align:left; font-size:14px; color:#aaa; margin-top:20px; line-height:1.6;">
            [1] TEXT TERMINAL<br>
            [2] PHOTO VIEWER (URL)<br>
            [3] VIDEO PLAYER (MP4)<br>
            [4] YOUTUBE PLAYER (ID)<br>
            [X] CLOSE WINDOW<br>
            [WASD] MOVEMENT
        </div>
        <button onclick="startAR()">INITIALIZE SYSTEM</button>
    </div>

    <div id="vr-container">
        <div id="eye-left" class="vr-eye">
            <video id="vid-left" class="camera-feed" autoplay muted playsinline></video>
            <div id="render-left" class="ar-overlay"></div>
            <div class="hud-overlay">
                <div class="reticle"></div>
                <div class="hud-text">L_EYE // ACTIVE</div>
            </div>
        </div>

        <div id="eye-right" class="vr-eye">
            <video id="vid-right" class="camera-feed" autoplay muted playsinline></video>
            <div id="render-right" class="ar-overlay"></div>
            <div class="hud-overlay">
                <div class="reticle"></div>
                <div class="hud-text">R_EYE // ACTIVE</div>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { CSS3DRenderer, CSS3DObject } from 'three/addons/renderers/CSS3DRenderer.js';

        // --- GLOBAL VARIABLES ---
        let camera;
        let rendererL, rendererR, cssL, cssR;
        let sceneCommon, sceneL, sceneR; // Dual Scenes

        const IPD = 0.064; 
        const player = { pos: new THREE.Vector3(0, 1.6, 5), rotY: 0 };
        const keys = {};
        
        let windows = []; 
        let windowCounter = 0;

        // --- STARTUP ---
        window.startAR = async function() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('vr-container').style.display = 'block';

            // Start Camera
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: {ideal: 1280}, height: {ideal: 720} },
                    audio: false 
                });
                const vl = document.getElementById('vid-left');
                const vr = document.getElementById('vid-right');
                vl.srcObject = stream; vr.srcObject = stream;
                vl.play(); vr.play();
            } catch (e) {
                alert("Camera Access Denied. Background will be black.");
            }

            init3D();
        };

        function init3D() {
            // 1. Setup Scenes
            sceneCommon = new THREE.Scene();
            sceneL = new THREE.Scene();
            sceneR = new THREE.Scene();

            // 2. Camera
            const aspect = (window.innerWidth / 2) / window.innerHeight;
            camera = new THREE.PerspectiveCamera(70, aspect, 0.1, 100);

            // 3. Lights
            const light = new THREE.DirectionalLight(0xffffff, 2);
            light.position.set(0, 5, 5);
            sceneCommon.add(light);
            sceneCommon.add(new THREE.AmbientLight(0xffffff, 0.5));

            // 4. Renderers
            rendererL = createWebGL('render-left'); rendererR = createWebGL('render-right');
            cssL = createCSS('render-left'); cssR = createCSS('render-right');

            // 5. Inputs
            window.addEventListener('resize', onResize);
            document.addEventListener('keydown', handleInput);
            document.addEventListener('keyup', e => keys[e.code] = false);

            // 6. Spawn Default
            spawnWindow('text', 0, 1.6, 0); 

            animate();
        }

        // --- INPUT & SPAWNING ---
        function handleInput(e) {
            keys[e.code] = true;
            
            // Calculate spawn position (2m in front)
            const dist = 2.0;
            const x = player.pos.x - Math.sin(player.rotY) * dist;
            const z = player.pos.z - Math.cos(player.rotY) * dist;

            // [1] TERMINAL (Default)
            if (e.key === '1') {
                spawnWindow('text', x, 1.6, z, player.rotY);
            }

            // [2] PHOTO (Asks for Link)
            if (e.key === '2') {
                const url = prompt("Enter Image URL:", "https://upload.wikimedia.org/wikipedia/commons/e/ec/Mona_Lisa%2C_by_Leonardo_da_Vinci%2C_from_C2RMF_retouched.jpg");
                if(url) spawnWindow('image', x, 1.6, z, player.rotY, url);
            }

            // [3] VIDEO (Asks for Link)
            if (e.key === '3') {
                const url = prompt("Enter Video URL (.mp4):", "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4");
                if(url) spawnWindow('video', x, 1.6, z, player.rotY, url);
            }

            // [4] YOUTUBE (Asks for ID)
            if (e.key === '4') {
                let url = prompt("Enter YouTube Video ID (e.g. dQw4w9WgXcQ):", "dQw4w9WgXcQ");
                if(url) spawnWindow('youtube', x, 1.6, z, player.rotY, url);
            }

            // [X] CLOSE
            if (e.key.toLowerCase() === 'x') removeLastWindow();
        }

        function spawnWindow(type, x, y, z, rotationY = 0, customUrl = "") {
            windowCounter++;
            const id = windowCounter;

            // Add to Left Scene
            const objL = createMediaObject(id, type, "LEFT", customUrl);
            objL.position.set(x, y, z);
            objL.rotation.y = rotationY;
            sceneL.add(objL);

            // Add to Right Scene
            const objR = createMediaObject(id, type, "RIGHT", customUrl);
            objR.position.set(x, y, z);
            objR.rotation.y = rotationY;
            sceneR.add(objR);

            windows.push({ id, objL, objR });
        }

        function createMediaObject(id, type, eyeLabel, url) {
            const div = document.createElement('div');
            div.style.width = '600px'; 
            div.style.height = '400px';
            div.style.background = 'rgba(0, 10, 20, 0.9)'; 
            div.style.border = '2px solid #00ffff';
            div.style.boxShadow = '0 0 40px rgba(0,255,255,0.2)';
            div.style.fontFamily = 'monospace';
            div.style.color = '#00ffff';
            div.style.overflow = 'hidden';
            div.style.display = 'flex'; div.style.flexDirection = 'column';

            // Header
            const header = document.createElement('div');
            header.innerHTML = `HELEN_OS // ${type.toUpperCase()} // ${id}`;
            header.style.padding = "10px";
            header.style.background = "rgba(0,255,255,0.2)";
            header.style.fontWeight = "bold";
            div.appendChild(header);

            // Content
            const content = document.createElement('div');
            content.style.flex = "1";
            content.style.position = "relative";

            if (type === 'text') {
                content.style.padding = "20px";
                content.style.fontSize = "24px";
                content.innerHTML = `
                    <p>> SYSTEM: ONLINE</p>
                    <p>> MODE: ${eyeLabel}</p>
                    <p>> USER: ADMIN</p>
                    <p style="margin-top:20px; color:#fff; animation: blink 1s infinite;">_AWAITING INPUT</p>
                    <style>@keyframes blink { 50% { opacity: 0; } }</style>
                `;
            } 
            else if (type === 'image') {
                content.innerHTML = `<img src="${url}" style="width:100%; height:100%; object-fit:cover;">`;
            }
            else if (type === 'video') {
                content.innerHTML = `<video src="${url}" autoplay loop muted controls style="width:100%; height:100%; object-fit:cover;"></video>`;
            }
            else if (type === 'youtube') {
                content.innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${url}?autoplay=1&mute=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
            }

            div.appendChild(content);

            const obj = new CSS3DObject(div);
            obj.scale.set(0.002, 0.002, 0.002);
            return obj;
        }

        function removeLastWindow() {
            if (windows.length === 0) return;
            const win = windows.pop();
            sceneL.remove(win.objL);
            sceneR.remove(win.objR);
        }

        // --- HELPERS ---
        function createWebGL(id) {
            const c = document.getElementById(id);
            const r = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            r.setSize(c.clientWidth, c.clientHeight);
            r.domElement.style.position = 'absolute'; r.domElement.style.top = '0'; r.domElement.style.zIndex = '2'; 
            c.appendChild(r.domElement);
            return r;
        }
        function createCSS(id) {
            const c = document.getElementById(id);
            const r = new CSS3DRenderer();
            r.setSize(c.clientWidth, c.clientHeight);
            r.domElement.style.position = 'absolute'; r.domElement.style.top = '0'; r.domElement.style.zIndex = '1';
            c.appendChild(r.domElement);
            return r;
        }

        function updatePhysics() {
            const speed = 0.05;
            if(keys['KeyW']) player.pos.z -= speed;
            if(keys['KeyS']) player.pos.z += speed;
            if(keys['KeyA']) player.rotY += 0.03;
            if(keys['KeyD']) player.rotY -= 0.03;
        }

        function onResize() {
            const halfW = window.innerWidth / 2;
            const h = window.innerHeight;
            camera.aspect = halfW / h;
            camera.updateProjectionMatrix();
            rendererL.setSize(halfW, h); rendererR.setSize(halfW, h);
            cssL.setSize(halfW, h); cssR.setSize(halfW, h);
        }

        function animate() {
            requestAnimationFrame(animate);
            updatePhysics();
            const halfIPD = IPD / 2;
            
            // LEFT EYE
            camera.position.copy(player.pos);
            camera.rotation.set(0, player.rotY, 0);
            camera.translateX(-halfIPD);
            camera.updateMatrixWorld();
            rendererL.render(sceneCommon, camera); 
            cssL.render(sceneL, camera);

            // RIGHT EYE
            camera.position.copy(player.pos);
            camera.rotation.set(0, player.rotY, 0);
            camera.translateX(halfIPD);
            camera.updateMatrixWorld();
            rendererR.render(sceneCommon, camera); 
            cssR.render(sceneR, camera);
        }
    </script>
</body>
</html>
