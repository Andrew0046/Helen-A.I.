<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HELEN AR: OMEGA</title>
    <style>
        /* --- CORE STYLES --- */
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', monospace; touch-action: none; }

        /* LOADING / START SCREEN */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #050505 0%, #1a1a1a 100%);
            color: #00ffff; display: flex; 
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 9999;
        }
        h1 { 
            font-size: 2rem; text-shadow: 0 0 15px #00ffff; letter-spacing: 4px; margin-bottom: 10px;
            border-bottom: 2px solid #00ffff; padding-bottom: 10px;
        }
        p { color: #aaa; font-size: 0.9rem; max-width: 80%; text-align: center; }
        
        .btn-main {
            margin-top: 30px; padding: 15px 40px; font-size: 16px; letter-spacing: 2px;
            background: rgba(0, 255, 255, 0.1); color: #00ffff; border: 1px solid #00ffff; 
            cursor: pointer; transition: 0.3s; box-shadow: 0 0 10px rgba(0,255,255,0.2);
        }
        .btn-main:hover { background: #00ffff; color: #000; box-shadow: 0 0 30px rgba(0,255,255,0.8); }

        /* VR CONTAINER */
        #vr-container { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* EYES */
        .vr-eye { position: absolute; top: 0; width: 50%; height: 100%; overflow: hidden; border-right: 1px solid #333; box-sizing: border-box; }
        #eye-left { left: 0; } #eye-right { left: 50%; border-right: none; }

        .camera-feed {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: 0; opacity: 0.5; /* Dim camera for better AR contrast */
        }

        .ar-render-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        
        /* HUD & RETICLE */
        .hud-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; pointer-events: none; }
        
        .reticle-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            display: flex; align-items: center; justify-content: center;
        }
        .reticle { 
            width: 10px; height: 10px; background: #fff; border-radius: 50%;
            box-shadow: 0 0 5px #fff; transition: transform 0.2s;
        }
        .reticle-ring {
            position: absolute; width: 30px; height: 30px;
            border: 2px solid transparent; border-radius: 50%;
            border-top-color: #00ffff; border-right-color: #00ffff;
            animation: spin 2s linear infinite; opacity: 0; transition: opacity 0.2s;
        }
        .reticle.loading + .reticle-ring { opacity: 1; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .hud-text { 
            position: absolute; top: 20px; left: 20px; 
            color: rgba(0,255,255,0.7); font-size: 10px; font-weight: bold; letter-spacing: 1px;
        }
        #sys-msg {
            position: absolute; bottom: 30%; left: 0; width: 100%; text-align: center;
            color: #00ff00; font-size: 18px; font-weight: bold; text-shadow: 0 0 10px #00ff00;
            opacity: 0; transition: opacity 0.5s;
        }

        /* VIGNETTE */
        .vignette {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: radial-gradient(circle, transparent 50%, #000 95%);
            z-index: 30; pointer-events: none;
        }
    </style>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.162.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.162.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="start-screen">
        <h1>HELEN AR: OMEGA</h1>
        <p>SYSTEM READY // FUELING CREATIVE SPARKS</p>
        <p style="margin-top:10px; font-size: 0.8rem;">[Requires Mobile Device + Sensors]</p>
        <button id="init-btn" class="btn-main">INITIALIZE NEURAL LINK</button>
    </div>

    <div id="vr-container">
        <div id="eye-left" class="vr-eye">
            <video id="vid-left" class="camera-feed" autoplay muted playsinline></video>
            <div id="render-left" class="ar-render-layer"></div>
            <div class="vignette"></div>
            <div class="hud-overlay">
                <div class="reticle-container">
                    <div class="reticle" id="ret-l"></div>
                    <div class="reticle-ring" id="ring-l"></div>
                </div>
                <div class="hud-text">L_OPTIC // ONLINE</div>
                <div id="sys-msg">SYSTEM LOADED</div>
            </div>
        </div>

        <div id="eye-right" class="vr-eye">
            <video id="vid-right" class="camera-feed" autoplay muted playsinline></video>
            <div id="render-right" class="ar-render-layer"></div>
            <div class="vignette"></div>
            <div class="hud-overlay">
                <div class="reticle-container">
                    <div class="reticle" id="ret-r"></div>
                    <div class="reticle-ring" id="ring-r"></div>
                </div>
                <div class="hud-text">R_OPTIC // ONLINE</div>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { CSS3DRenderer, CSS3DObject } from 'three/addons/renderers/CSS3DRenderer.js';
        import { DeviceOrientationControls } from 'three/addons/controls/DeviceOrientationControls.js';

        // --- GLOBAL CONFIG ---
        const CONFIG = {
            ipd: 0.064,
            walkSpeed: 0.05,
            gazeTime: 1500, // Time to trigger button
            fov: 75
        };

        // --- STATE ---
        let camera, rendererL, rendererR, cssL, cssR;
        let sceneCommon, sceneL, sceneR; // Common holds 3D, L/R hold CSS
        let controls;
        let raycaster, centerPointer;
        let gazeTarget = null;
        let gazeStartTime = 0;
        
        let windows = []; 
        let menuGroup = null;
        let isMenuOpen = true;

        const player = { pos: new THREE.Vector3(0, 1.6, 0) }; // Player position offset

        // --- INITIALIZATION ---
        const btn = document.getElementById('init-btn');
        btn.addEventListener('click', async () => {
            // iOS 13+ requires permission for sensors
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                try {
                    const response = await DeviceMotionEvent.requestPermission();
                    if (response !== 'granted') return alert('Sensors required for Head Tracking.');
                } catch (e) { console.error(e); }
            }

            // Fullscreen & Wake Lock
            try { if ('wakeLock' in navigator) await navigator.wakeLock.request('screen'); } catch(e){}
            try { document.documentElement.requestFullscreen(); } catch(e){}

            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('vr-container').style.display = 'block';

            // Camera Access
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: {ideal: 1280}, height: {ideal: 720} },
                    audio: false 
                });
                document.getElementById('vid-left').srcObject = stream;
                document.getElementById('vid-right').srcObject = stream;
                document.getElementById('vid-left').play();
                document.getElementById('vid-right').play();
            } catch (e) { console.log("Camera failed, fallback to VR only"); }

            init3D();
        });

        function init3D() {
            // 1. Scene Setup
            sceneCommon = new THREE.Scene();
            sceneCommon.fog = new THREE.FogExp2(0x000000, 0.03); // Deep fog
            
            sceneL = new THREE.Scene();
            sceneR = new THREE.Scene();

            const aspect = (window.innerWidth / 2) / window.innerHeight;
            camera = new THREE.PerspectiveCamera(CONFIG.fov, aspect, 0.1, 100);

            // 2. Lighting & Environment
            const ambient = new THREE.AmbientLight(0xffffff, 0.6);
            sceneCommon.add(ambient);
            const dirLight = new THREE.DirectionalLight(0x00ffff, 1.5);
            dirLight.position.set(0, 10, 5);
            sceneCommon.add(dirLight);

            // Cyberpunk Floor Grid
            const gridHelper = new THREE.GridHelper(100, 100, 0x00ffff, 0x111111);
            gridHelper.position.y = -1.6; // Floor level relative to eyes
            sceneCommon.add(gridHelper);

            // Floating Dust Particles
            const particlesGeom = new THREE.BufferGeometry();
            const particleCount = 500;
            const posArray = new Float32Array(particleCount * 3);
            for(let i=0; i<particleCount*3; i++) {
                posArray[i] = (Math.random() - 0.5) * 40;
            }
            particlesGeom.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            const particlesMat = new THREE.PointsMaterial({ size: 0.05, color: 0x00ffff, transparent: true, opacity: 0.6 });
            const particles = new THREE.Points(particlesGeom, particlesMat);
            sceneCommon.add(particles);

            // 3. Renderers
            rendererL = createWebGL('render-left');
            rendererR = createWebGL('render-right');
            cssL = createCSS('render-left');
            cssR = createCSS('render-right');

            // 4. Controls
            controls = new DeviceOrientationControls(camera);
            
            // 5. Interaction
            raycaster = new THREE.Raycaster();
            centerPointer = new THREE.Vector2(0, 0); // Center of screen

            // 6. Spawn Menu
            createFloatingMenu();

            window.addEventListener('resize', onResize);
            animate();
            
            showMessage("HELEN OS // INITIALIZED");
        }

        // --- MENU SYSTEM ---
        function createFloatingMenu() {
            menuGroup = new THREE.Group();
            
            const buttons = [
                { name: "TEXT", type: "text", color: 0x00ff00 },
                { name: "IMAGE", type: "image", color: 0xff00ff },
                { name: "VIDEO", type: "video", color: 0x00ffff },
                { name: "WEB", type: "browser", color: 0xffff00 },
                { name: "CLEAR", type: "clear", color: 0xff0000 }
            ];

            buttons.forEach((btn, i) => {
                const geo = new THREE.PlaneGeometry(0.8, 0.3);
                const mat = new THREE.MeshBasicMaterial({ color: 0x000000, side: THREE.DoubleSide, opacity: 0.8, transparent: true });
                const mesh = new THREE.Mesh(geo, mat);
                
                // Add border
                const edges = new THREE.EdgesGeometry(geo);
                const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial( { color: btn.color } ) );
                mesh.add(line);

                // Add Text Label (Canvas Texture)
                const canvas = document.createElement('canvas');
                canvas.width = 256; canvas.height = 128;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = "#ffffff";
                ctx.font = "Bold 60px Courier New";
                ctx.textAlign = "center";
                ctx.fillText(btn.name, 128, 80);
                
                const tex = new THREE.CanvasTexture(canvas);
                const labelGeo = new THREE.PlaneGeometry(0.8, 0.4);
                const labelMat = new THREE.MeshBasicMaterial({ map: tex, transparent: true });
                const label = new THREE.Mesh(labelGeo, labelMat);
                label.position.z = 0.02;
                mesh.add(label);

                // Position in semi-circle
                const angle = ((i - 2) * 20) * (Math.PI / 180);
                mesh.position.set(Math.sin(angle) * 2, 0, -Math.cos(angle) * 2);
                mesh.lookAt(0, 0, 0);
                mesh.userData = { isButton: true, type: btn.type };
                
                menuGroup.add(mesh);
            });

            menuGroup.position.set(0, 0, 0);
            sceneCommon.add(menuGroup);
        }

        function handleInteraction() {
            // Update Raycaster
            raycaster.setFromCamera(centerPointer, camera);
            const intersects = raycaster.intersectObjects(menuGroup.children, false);

            if (intersects.length > 0) {
                const target = intersects[0].object;
                if (target !== gazeTarget) {
                    gazeTarget = target;
                    gazeStartTime = Date.now();
                    document.getElementById('ret-l').classList.add('loading');
                    document.getElementById('ret-r').classList.add('loading');
                } else {
                    // Check if gaze time met
                    const elapsed = Date.now() - gazeStartTime;
                    if (elapsed > CONFIG.gazeTime) {
                        triggerAction(target.userData.type);
                        gazeTarget = null; // Reset
                        document.getElementById('ret-l').classList.remove('loading');
                        document.getElementById('ret-r').classList.remove('loading');
                    }
                }
            } else {
                gazeTarget = null;
                document.getElementById('ret-l').classList.remove('loading');
                document.getElementById('ret-r').classList.remove('loading');
            }
        }

        function triggerAction(type) {
            const spawnPos = getSpawnPos();
            
            if (type === 'clear') {
                windows.forEach(w => { sceneL.remove(w.objL); sceneR.remove(w.objR); });
                windows = [];
                showMessage("MEMORY PURGED");
                return;
            }

            showMessage("SPAWNING: " + type.toUpperCase());
            
            let url = "";
            if (type === 'image') url = "https://upload.wikimedia.org/wikipedia/commons/e/ec/Mona_Lisa%2C_by_Leonardo_da_Vinci%2C_from_C2RMF_retouched.jpg";
            if (type === 'video') url = "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4";
            if (type === 'browser') url = "https://en.wikipedia.org/wiki/Augmented_reality";

            spawnWindow(type, spawnPos.x, spawnPos.y, spawnPos.z, spawnPos.rotY, url);
        }

        function spawnWindow(type, x, y, z, rotY, url) {
            const id = Date.now();
            const winData = { id, type, objL: null, objR: null };
            
            winData.objL = createMediaObject(id, type, url);
            winData.objL.position.set(x, y, z);
            winData.objL.rotation.y = rotY;
            sceneL.add(winData.objL);

            winData.objR = createMediaObject(id, type, url);
            winData.objR.position.set(x, y, z);
            winData.objR.rotation.y = rotY;
            sceneR.add(winData.objR);

            windows.push(winData);
        }

        function createMediaObject(id, type, url) {
            const div = document.createElement('div');
            div.style.width = '600px'; div.style.height = '400px';
            div.style.background = 'rgba(0, 0, 0, 0.85)'; 
            div.style.border = '2px solid #00ffff';
            div.style.boxShadow = '0 0 30px rgba(0,255,255,0.3)';
            div.style.color = '#fff'; div.style.display = 'flex'; div.style.flexDirection = 'column';

            const header = document.createElement('div');
            header.innerHTML = `HELEN_OS // ${type} [${id.toString().substr(-4)}]`;
            header.style.padding = "10px"; header.style.background = "#00ffff"; header.style.color="#000"; header.style.fontWeight = "bold";
            div.appendChild(header);

            const content = document.createElement('div');
            content.style.flex = "1"; content.style.position = "relative";
            
            if (type === 'text') {
                content.style.padding = "20px"; content.style.fontFamily = "Courier New"; content.style.fontSize="20px";
                content.innerHTML = `<p>> SYSTEM: STABLE</p><p>> WORLD: PERSISTENT</p><p>> FANTASY_MODE: ACTIVE</p>`;
            } 
            else if (type === 'image') content.innerHTML = `<img src="${url}" style="width:100%; height:100%; object-fit:cover;">`;
            else if (type === 'video') content.innerHTML = `<video src="${url}" autoplay loop muted style="width:100%; height:100%; object-fit:cover;"></video>`;
            else if (type === 'browser') content.innerHTML = `<iframe width="100%" height="100%" src="${url}" frameborder="0" style="background:#fff;"></iframe>`;

            div.appendChild(content);
            const obj = new CSS3DObject(div);
            obj.scale.set(0.002, 0.002, 0.002);
            return obj;
        }

        function getSpawnPos() {
            // Spawn 3 meters in front of where player is looking
            const dir = new THREE.Vector3();
            camera.getWorldDirection(dir);
            dir.multiplyScalar(3);
            return {
                x: camera.position.x + dir.x,
                y: camera.position.y, // Keep level
                z: camera.position.z + dir.z,
                rotY: Math.atan2(dir.x, dir.z) // Face the player
            };
        }

        function showMessage(text) {
            const el = document.getElementById('sys-msg');
            el.innerText = text; el.style.opacity = 1;
            setTimeout(() => { el.style.opacity = 0; }, 2500);
        }

        // --- RENDER LOOP ---
        function animate() {
            requestAnimationFrame(animate);
            controls.update(); // Update camera rotation from sensors

            // Move menu to follow player but stay in front (HUD style or floating anchor)
            // Here we keep it at 0,0,0 but you can make it follow
            
            handleInteraction();

            // Render Left Eye
            const halfIPD = CONFIG.ipd / 2;
            camera.translateX(-halfIPD); 
            rendererL.render(sceneCommon, camera); cssL.render(sceneL, camera);
            
            // Render Right Eye
            camera.translateX(CONFIG.ipd); // Move back + offset
            rendererR.render(sceneCommon, camera); cssR.render(sceneR, camera);
            
            // Reset camera for next frame calculations
            camera.translateX(-halfIPD); 
        }

        function createWebGL(id) {
            const c = document.getElementById(id);
            const r = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            r.setSize(c.clientWidth, c.clientHeight);
            r.domElement.style.position = 'absolute'; r.domElement.style.top = '0';
            c.appendChild(r.domElement);
            return r;
        }
        function createCSS(id) {
            const c = document.getElementById(id);
            const r = new CSS3DRenderer();
            r.setSize(c.clientWidth, c.clientHeight);
            r.domElement.style.position = 'absolute'; r.domElement.style.top = '0';
            c.appendChild(r.domElement);
            return r;
        }
        function onResize() {
            const halfW = window.innerWidth / 2;
            const h = window.innerHeight;
            camera.aspect = halfW / h; camera.updateProjectionMatrix();
            rendererL.setSize(halfW, h); rendererR.setSize(halfW, h);
            cssL.setSize(halfW, h); cssR.setSize(halfW, h);
        }
    </script>
</body>
</html>
