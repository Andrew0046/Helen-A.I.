<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Helen AR: Turbo Optimized</title>
    <style>
        /* --- CORE STYLES --- */
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', monospace; touch-action: none; }

        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #050505; color: #00ffff; display: flex; 
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 9999;
        }
        h1 { text-shadow: 0 0 10px #00ffff; letter-spacing: 2px; }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        button {
            padding: 15px 30px; font-size: 18px;
            background: transparent; color: #00ffff; border: 2px solid #00ffff; 
            font-weight: bold; cursor: pointer; transition: all 0.3s;
            box-shadow: 0 0 15px rgba(0,255,255,0.2);
        }
        button:hover { background: #00ffff; color: #000; box-shadow: 0 0 30px rgba(0,255,255,0.6); }

        #vr-container { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .vr-eye { position: absolute; top: 0; width: 50%; height: 100%; overflow: hidden; border-right: 2px solid #000; box-sizing: border-box; }
        #eye-left { left: 0; } #eye-right { left: 50%; }

        .lens-vignette {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 60%, rgba(0,0,0,0.9) 90%, black 100%);
            z-index: 30; pointer-events: none;
        }

        .camera-feed {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; transform: scale(1.0); z-index: 0;
            will-change: transform; /* GPU Hint */
        }

        .ar-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .hud-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; pointer-events: none; }
        
        .reticle { 
            position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; 
            border: 2px solid #00ffff; border-radius: 50%; transform: translate(-50%, -50%); 
            opacity: 0.6; box-shadow: 0 0 5px #00ffff; transition: all 0.2s;
        }
        .reticle.grab { border-color: #00ff00; background: rgba(0,255,0,0.2); width: 30px; height: 30px; }
        
        .hud-text { 
            position: absolute; top: 20px; left: 20px; 
            color: #00ffff; text-shadow: 0 0 5px #00ffff; font-size: 14px; font-weight: bold; 
        }
        
        #status-msg {
            position: absolute; bottom: 100px; left: 0; width: 100%; text-align: center;
            color: #00ff00; font-size: 16px; font-weight: bold; display: none; text-shadow: 0 0 5px #00ff00;
        }

        /* --- OPTIMIZED WINDOW STYLES --- */
        .window-container {
            /* Hardware Acceleration Hints */
            backface-visibility: hidden;
            transform-style: preserve-3d;
            will-change: transform; 
        }

        .browser-bar { display: flex; padding: 5px; background: #222; border-bottom: 1px solid #00ffff; }
        .browser-input { flex: 1; background: #000; color: #fff; border: 1px solid #555; padding: 5px; font-family: monospace; font-size: 14px; }
        .browser-btn { background: #00ffff; color: #000; border: none; padding: 0 15px; font-weight: bold; cursor: pointer; margin-left: 5px; }
        
        .file-upload-btn {
            background: #00ffff; color: #000; padding: 15px; text-align: center; 
            font-weight: bold; cursor: pointer; margin: 20px; border: 2px dashed #00ffff;
        }
    </style>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.162.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.162.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="start-screen">
        <h1>HELEN AR: TURBO</h1>
        <p>OPTIMIZED RENDERING ACTIVE</p>
        <div style="text-align:left; font-size:14px; color:#aaa; margin-top:20px; line-height:1.6;">
            [1-4] MEDIA &bull; [5] BROWSER &bull; [6] UPLOAD<br>
            [G] GRAB &bull; [K] SAVE &bull; [X] CLOSE
        </div>
        <div class="btn-group">
            <button id="init-btn">ENTER VR</button>
            <button onclick="localStorage.clear(); alert('Memory Wiped');">RESET MEMORY</button>
        </div>
    </div>

    <div id="vr-container">
        <div id="eye-left" class="vr-eye">
            <video id="vid-left" class="camera-feed" autoplay muted playsinline></video>
            <div id="render-left" class="ar-overlay"></div>
            <div class="lens-vignette"></div>
            <div class="hud-overlay"><div class="reticle" id="ret-l"></div><div class="hud-text">L_EYE // 60FPS</div><div id="status-msg">WORLD SAVED</div></div>
        </div>
        <div id="eye-right" class="vr-eye">
            <video id="vid-right" class="camera-feed" autoplay muted playsinline></video>
            <div id="render-right" class="ar-overlay"></div>
            <div class="lens-vignette"></div>
            <div class="hud-overlay"><div class="reticle" id="ret-r"></div><div class="hud-text">R_EYE // 60FPS</div></div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { CSS3DRenderer, CSS3DObject } from 'three/addons/renderers/CSS3DRenderer.js';

        let camera, rendererL, rendererR, cssL, cssR;
        let sceneCommon, sceneL, sceneR; 
        const IPD = 0.064; 
        const player = { pos: new THREE.Vector3(0, 1.6, 5), rotY: 0 };
        const keys = {};
        let windows = []; 
        let windowCounter = 0;
        let grabbedWindow = null; 

        // --- INIT ---
        const btn = document.getElementById('init-btn');
        btn.addEventListener('click', async () => {
            try { if ('wakeLock' in navigator) await navigator.wakeLock.request('screen'); } catch(e){}
            try { if (document.documentElement.requestFullscreen) await document.documentElement.requestFullscreen(); } catch(e){}

            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('vr-container').style.display = 'block';

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: {ideal: 1280}, height: {ideal: 720} },
                    audio: false 
                });
                const vl = document.getElementById('vid-left');
                const vr = document.getElementById('vid-right');
                vl.srcObject = stream; vr.srcObject = stream;
                vl.play(); vr.play();
            } catch (e) { alert("Camera Error"); }

            init3D();
            loadWorld(); 
        });

        // --- OPTIMIZED SYNC ENGINE ---
        // Reads all values first, THEN writes them. Prevents Layout Thrashing.
        function syncWindows() {
            const updates = [];

            // 1. READ PHASE (Fast)
            windows.forEach(w => {
                if (!w.domL || !w.domR) return;
                
                const contentL = w.domL.querySelector('.win-content');
                const inputL = w.domL.querySelector('.browser-input');
                
                // Store the values we need to sync
                if (contentL) {
                    updates.push({ 
                        domR: w.domR, 
                        scrollTop: contentL.scrollTop, 
                        scrollLeft: contentL.scrollLeft 
                    });
                }
                
                if (inputL) {
                     const inputR = w.domR.querySelector('.browser-input');
                     if(inputR && inputL.value !== inputR.value) {
                         updates.push({ inputR: inputR, val: inputL.value, type: 'input' });
                     }
                }
            });

            // 2. WRITE PHASE (Fast)
            updates.forEach(u => {
                if(u.type === 'input') {
                    u.inputR.value = u.val;
                } else {
                    const contentR = u.domR.querySelector('.win-content');
                    if(contentR) {
                        if(contentR.scrollTop !== u.scrollTop) contentR.scrollTop = u.scrollTop;
                        if(contentR.scrollLeft !== u.scrollLeft) contentR.scrollLeft = u.scrollLeft;
                    }
                }
            });
        }

        // --- HANDLERS ---
        window.navigateBrowser = function(id, eye) {
            const win = windows.find(w => w.id === id);
            if (!win) return;
            const input = win.domL.querySelector('.browser-input');
            let url = input.value;
            if (!url.startsWith('http')) url = 'https://' + url;
            
            const iframeL = win.domL.querySelector('iframe');
            const iframeR = win.domR.querySelector('iframe');
            if(iframeL) iframeL.src = url;
            if(iframeR) iframeR.src = url;
            win.url = url; 
            saveWorld();
        }

        window.handleUpload = function(id, inputElement) {
            if (inputElement.files && inputElement.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const result = e.target.result; 
                    const win = windows.find(w => w.id === id);
                    if (!win) return;
                    const injectImage = (dom) => {
                        const content = dom.querySelector('.win-content');
                        content.innerHTML = `<img src="${result}" style="width:100%; height:100%; object-fit:contain;">`;
                    };
                    injectImage(win.domL); injectImage(win.domR);
                    showStatus("IMAGE LOADED");
                };
                reader.readAsDataURL(inputElement.files[0]);
            }
        }

        // --- CORE LOGIC ---
        function saveWorld() {
            const data = windows.filter(w => w.type !== 'upload').map(w => ({
                id: w.id, type: w.type, url: w.url,
                x: w.objL.position.x, y: w.objL.position.y, z: w.objL.position.z, rotY: w.objL.rotation.y
            }));
            localStorage.setItem('helen_world_data', JSON.stringify(data));
            showStatus("WORLD SAVED");
        }

        function loadWorld() {
            const data = localStorage.getItem('helen_world_data');
            if (!data) return;
            try {
                const savedWindows = JSON.parse(data);
                savedWindows.forEach(w => {
                    spawnWindow(w.type, w.x, w.y, w.z, w.rotY, w.url, false);
                });
                showStatus("WORLD LOADED");
            } catch(e) {}
        }

        function toggleGrab() {
            if (grabbedWindow) {
                grabbedWindow = null;
                document.getElementById('ret-l').classList.remove('grab');
                document.getElementById('ret-r').classList.remove('grab');
                showStatus("WINDOW DROPPED");
                saveWorld();
            } else {
                const closest = findClosestWindow();
                if (closest && closest.dist < 1.5) {
                    grabbedWindow = closest.win;
                    document.getElementById('ret-l').classList.add('grab');
                    document.getElementById('ret-r').classList.add('grab');
                    showStatus("WINDOW GRABBED");
                }
            }
        }

        function findClosestWindow() {
            let minDist = Infinity;
            let target = null;
            const camPos = player.pos.clone(); 
            windows.forEach(w => {
                const dist = w.objL.position.distanceTo(camPos);
                if (dist < minDist) { minDist = dist; target = w; }
            });
            return target ? { win: target, dist: minDist } : null;
        }

        function updateGrabbedWindow() {
            if (!grabbedWindow) return;
            const dist = 2.0;
            const x = player.pos.x - Math.sin(player.rotY) * dist;
            const z = player.pos.z - Math.cos(player.rotY) * dist;
            
            // Move both eyes' objects
            grabbedWindow.objL.position.set(x, 1.6, z);
            grabbedWindow.objL.rotation.y = player.rotY;
            grabbedWindow.objR.position.set(x, 1.6, z);
            grabbedWindow.objR.rotation.y = player.rotY;
        }

        function showStatus(text) {
            const el = document.getElementById('status-msg');
            el.innerText = text; el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 2000);
        }

        function init3D() {
            sceneCommon = new THREE.Scene(); sceneL = new THREE.Scene(); sceneR = new THREE.Scene();
            const aspect = (window.innerWidth / 2) / window.innerHeight;
            camera = new THREE.PerspectiveCamera(70, aspect, 0.1, 100);
            const light = new THREE.DirectionalLight(0xffffff, 2);
            light.position.set(0, 5, 5);
            sceneCommon.add(light); sceneCommon.add(new THREE.AmbientLight(0xffffff, 0.5));
            
            // --- OPTIMIZATION: CAP RESOLUTION ---
            rendererL = createWebGL('render-left'); 
            rendererR = createWebGL('render-right');
            // Cap Pixel Ratio to 2 (Prevents 4k rendering on phones)
            rendererL.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            rendererR.setPixelRatio(Math.min(window.devicePixelRatio, 2));

            cssL = createCSS('render-left'); cssR = createCSS('render-right');
            
            window.addEventListener('resize', onResize);
            document.addEventListener('keydown', handleInput);
            document.addEventListener('keyup', e => keys[e.code] = false);
            if (windows.length === 0) spawnWindow('text', 0, 1.6, 0); 
            animate();
        }

        function handleInput(e) {
            keys[e.code] = true;
            const coords = getSpawnPos();

            if (e.key === '1') spawnWindow('text', ...coords);
            if (e.key === '2') spawnWindow('image', coords[0], coords[1], coords[2], coords[3], "https://upload.wikimedia.org/wikipedia/commons/e/ec/Mona_Lisa%2C_by_Leonardo_da_Vinci%2C_from_C2RMF_retouched.jpg");
            if (e.key === '3') spawnWindow('video', coords[0], coords[1], coords[2], coords[3], "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4");
            if (e.key === '4') spawnWindow('youtube', coords[0], coords[1], coords[2], coords[3], "dQw4w9WgXcQ");
            if (e.key === '5') spawnWindow('browser', coords[0], coords[1], coords[2], coords[3], "https://en.wikipedia.org/wiki/Main_Page");
            if (e.key === '6') spawnWindow('upload', ...coords);

            if (e.key.toLowerCase() === 'x') removeLastWindow();
            if (e.key.toLowerCase() === 'g') toggleGrab();
            if (e.key.toLowerCase() === 'k') saveWorld();
            if (e.key.toLowerCase() === 'l') { localStorage.clear(); showStatus("MEMORY CLEARED"); }
        }

        function spawnWindow(type, x, y, z, rotationY = 0, customUrl = "", shouldSave = true) {
            windowCounter++;
            const id = windowCounter;
            
            const domL = createDOM(id, type, "LEFT", customUrl);
            const domR = createDOM(id, type, "RIGHT", customUrl);

            const objL = new CSS3DObject(domL); 
            objL.scale.set(0.002, 0.002, 0.002);
            objL.position.set(x, y, z); objL.rotation.y = rotationY;
            sceneL.add(objL);

            const objR = new CSS3DObject(domR); 
            objR.scale.set(0.002, 0.002, 0.002);
            objR.position.set(x, y, z); objR.rotation.y = rotationY;
            sceneR.add(objR);

            windows.push({ id, type, url: customUrl, objL, objR, domL, domR });
            if(shouldSave) saveWorld();
        }

        function createDOM(id, type, eyeLabel, url) {
            const div = document.createElement('div');
            // Add Optimization Class
            div.className = 'window-container'; 
            
            div.style.width = '600px'; div.style.height = '400px';
            div.style.background = 'rgba(0, 10, 20, 0.95)'; 
            div.style.border = '2px solid #00ffff';
            div.style.boxShadow = '0 0 40px rgba(0,255,255,0.2)';
            div.style.fontFamily = 'monospace'; div.style.color = '#00ffff';
            div.style.display = 'flex'; div.style.flexDirection = 'column';

            if (type === 'browser') {
                const bar = document.createElement('div');
                bar.className = 'browser-bar';
                bar.innerHTML = `<input type="text" class="browser-input" value="${url}" onkeydown="if(event.key === 'Enter') window.navigateBrowser(${id}, '${eyeLabel}')"><button class="browser-btn" onclick="window.navigateBrowser(${id}, '${eyeLabel}')">GO</button>`;
                div.appendChild(bar);
            } else {
                const header = document.createElement('div');
                header.innerHTML = `HELEN_OS // ${type.toUpperCase()} // ${id}`;
                header.style.padding = "10px"; header.style.background = "rgba(0,255,255,0.2)"; header.style.fontWeight = "bold";
                div.appendChild(header);
            }

            const content = document.createElement('div');
            content.className = 'win-content';
            content.style.flex = "1"; content.style.position = "relative";
            content.style.overflowY = 'auto'; content.style.pointerEvents = "auto"; 

            if (type === 'text') {
                content.style.padding = "20px"; content.style.fontSize = "24px";
                content.innerHTML = "<p>> SYSTEM READY.</p>";
            } 
            else if (type === 'image') content.innerHTML = `<img src="${url}" style="width:100%; height:100%; object-fit:contain;">`;
            else if (type === 'video') content.innerHTML = `<video src="${url}" autoplay loop muted controls style="width:100%; height:100%; object-fit:cover;"></video>`;
            else if (type === 'youtube') content.innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${url}?autoplay=1&mute=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
            else if (type === 'browser') content.innerHTML = `<iframe width="100%" height="100%" src="${url}" frameborder="0" style="background:#fff;"></iframe>`;
            
            else if (type === 'upload') {
                content.innerHTML = `
                    <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%;">
                        <p>SELECT LOCAL MEDIA</p>
                        <input type="file" id="file-${id}-${eyeLabel}" style="display:none;" onchange="window.handleUpload(${id}, this)">
                        <label for="file-${id}-${eyeLabel}" class="file-upload-btn">CHOOSE FILE</label>
                    </div>`;
            }

            div.appendChild(content);
            return div;
        }

        function getSpawnPos() {
            const dist = 2.0;
            const x = player.pos.x - Math.sin(player.rotY) * dist;
            const z = player.pos.z - Math.cos(player.rotY) * dist;
            return [x, 1.6, z, player.rotY];
        }

        function removeLastWindow() {
            if (windows.length === 0) return;
            const win = windows.pop();
            sceneL.remove(win.objL); sceneR.remove(win.objR);
            saveWorld();
        }

        function createWebGL(id) {
            const c = document.getElementById(id);
            const r = new THREE.WebGLRenderer({ alpha: true, antialias: false }); // No Antialias = Faster
            r.setSize(c.clientWidth, c.clientHeight);
            r.domElement.style.position = 'absolute'; r.domElement.style.top = '0'; r.domElement.style.zIndex = '2'; 
            c.appendChild(r.domElement);
            return r;
        }
        function createCSS(id) {
            const c = document.getElementById(id);
            const r = new CSS3DRenderer();
            r.setSize(c.clientWidth, c.clientHeight);
            r.domElement.style.position = 'absolute'; r.domElement.style.top = '0'; r.domElement.style.zIndex = '1';
            c.appendChild(r.domElement);
            return r;
        }

        function onResize() {
            const halfW = window.innerWidth / 2;
            const h = window.innerHeight;
            camera.aspect = halfW / h; camera.updateProjectionMatrix();
            rendererL.setSize(halfW, h); rendererR.setSize(halfW, h);
            cssL.setSize(halfW, h); cssR.setSize(halfW, h);
        }

        function animate() {
            requestAnimationFrame(animate);
            const speed = 0.05;
            if(keys['KeyW']) player.pos.z -= speed;
            if(keys['KeyS']) player.pos.z += speed;
            if(keys['KeyA']) player.rotY += 0.03;
            if(keys['KeyD']) player.rotY -= 0.03;
            
            updateGrabbedWindow(); 
            syncWindows(); 

            const halfIPD = IPD / 2;
            camera.position.copy(player.pos);
            camera.rotation.set(0, player.rotY, 0);
            camera.translateX(-halfIPD);
            camera.updateMatrixWorld();
            rendererL.render(sceneCommon, camera); cssL.render(sceneL, camera);

            camera.position.copy(player.pos);
            camera.rotation.set(0, player.rotY, 0);
            camera.translateX(halfIPD);
            camera.updateMatrixWorld();
            rendererR.render(sceneCommon, camera); cssR.render(sceneR, camera);
        }
    </script>
</body>
</html>
