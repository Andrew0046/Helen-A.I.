<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>HELEN AR • Media Nexus 2.1</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: 'Courier New', monospace;
            color: #0ff;
            image-rendering: pixelated;
        }

        /* ── START SCREEN ──────────────────────────────────────── */
        #start-screen {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.96);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            text-shadow: 0 0 12px #0ff;
        }

        h1 {
            font-size: 3.8rem;
            letter-spacing: 8px;
            margin: 0.2em 0;
            animation: glow 3s infinite alternate;
        }

        button {
            padding: 1.2rem 3.8rem;
            font-size: 1.5rem;
            background: transparent;
            color: #0ff;
            border: 3px solid #0ff;
            cursor: pointer;
            transition: all 0.25s;
            box-shadow: 0 0 25px #0ff4;
        }

        button:hover {
            background: #0ff;
            color: #000;
            box-shadow: 0 0 60px #0ff8;
        }

        .cheatsheet {
            margin-top: 2rem;
            font-size: 1.1rem;
            color: #0f8;
            text-align: left;
            line-height: 1.7;
            user-select: none;
        }

        /* ── VR/AR CONTAINER ───────────────────────────────────── */
        #vr-container {
            display: none;
            position: fixed;
            inset: 0;
        }

        .eye {
            position: absolute;
            top: 0; height: 100%;
            width: 50%;
            overflow: hidden;
        }
        #eye-l { left:0; border-right:1px solid #111; }
        #eye-r { left:50%; }

        .camera-feed {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scale(1.25);
            filter: brightness(0.9) contrast(1.15);
        }

        .hud {
            position: absolute;
            inset: 0;
            pointer-events: none;
            background: radial-gradient(circle at center, transparent 30%, rgba(0,0,0,0.7) 80%);
            box-shadow: inset 0 0 120px #000c;
        }

        .reticle {
            position: absolute;
            inset: 50%;
            width: 28px; height: 28px;
            border: 2px solid #0ff8;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 12px #0ff;
            pointer-events: none;
        }

        .scanline {
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(
                to bottom,
                transparent 0,
                transparent 2px,
                rgba(0,255,255,0.04) 2px,
                rgba(0,255,255,0.04) 4px
            );
            pointer-events: none;
            animation: scan 8s linear infinite;
        }

        @keyframes glow { 0%,100%{text-shadow:0 0 12px #0ff} 50%{text-shadow:0 0 30px #0ff} }
        @keyframes scan  { 0%{transform:translateY(-100%)} 100%{transform:translateY(100%)} }

        .window-close {
            position: absolute;
            top: 8px; right: 12px;
            color: #f44;
            font-size: 1.4rem;
            cursor: pointer;
            pointer-events: all;
            text-shadow: 0 0 6px #f448;
        }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.168.0/build/three.module.js?module",
            "three/addons/": "https://unpkg.com/three@0.168.0/examples/jsm/"
        }
    }
    </script>
</head>
<body>

<div id="start-screen">
    <h1>HELEN NEXUS</h1>
    <p style="font-size:1.6rem; margin:0.4em 0; opacity:0.8">MEDIA LAYER • ONLINE</p>

    <div class="cheatsheet">
        [1] — Terminal<br>
        [2] — Image   (url)<br>
        [3] — Video   (.mp4)<br>
        [4] — YouTube (id)<br>
        [X] — Close focused / last<br>
        [WASD / Arrow] Move • [Mouse drag] Look
    </div>

    <button onclick="initAR()">ENTER NEXUS</button>
</div>

<div id="vr-container">
    <div id="eye-l" class="eye">
        <video id="vid-l" class="camera-feed" autoplay muted playsinline></video>
        <div id="render-l" class="ar-overlay"></div>
        <div class="hud"><div class="reticle"></div><div class="scanline"></div></div>
    </div>
    <div id="eye-r" class="eye">
        <video id="vid-r" class="camera-feed" autoplay muted playsinline></video>
        <div id="render-r" class="ar-overlay"></div>
        <div class="hud"><div class="reticle"></div><div class="scanline"></div></div>
    </div>
</div>

<script type="module">
import * as THREE from 'three';
import { CSS3DRenderer, CSS3DObject } from 'three/addons/renderers/CSS3DRenderer.js';

let camera, sceneCommon, sceneL, sceneR;
let rendererL, rendererR, cssL, cssR;

const IPD = 0.064;               // average human interpupillary distance
const CONVERGENCE = 3;           // meters — where eyes converge (comfort)

const player = {
    position: new THREE.Vector3(0, 1.62, 3),
    rotationY: 0,
    velocity: new THREE.Vector3()
};

const keys = {};
let windows = [];
let windowId = 0;

let lookActive = false;
let prevMouse = {x:0, y:0};

// ── INIT ────────────────────────────────────────────────────────
window.initAR = async () => {
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('vr-container').style.display = 'block';

    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment', width: {ideal:1280}, height:{ideal:720} }
        });
        const vl = document.getElementById('vid-l');
        const vr = document.getElementById('vid-r');
        vl.srcObject = vr.srcObject = stream;
    } catch (e) {
        console.warn("Camera blocked → black background", e);
    }

    initThree();
    animate();
};

function initThree() {
    sceneCommon = new THREE.Scene();
    sceneL = new THREE.Scene();
    sceneR = new THREE.Scene();

    camera = new THREE.PerspectiveCamera(72, 1, 0.08, 200);

    sceneCommon.add(new THREE.AmbientLight(0xffffff, 0.7));
    sceneCommon.add(new THREE.DirectionalLight(0xffffff, 2.2).position.set(5,12,8));

    rendererL = createGL('render-l');
    rendererR = createGL('render-r');
    cssL      = createCSS('render-l');
    cssR      = createCSS('render-r');

    window.addEventListener('resize', resize);
    document.addEventListener('keydown', onKeyDown);
    document.addEventListener('keyup',   e => keys[e.code] = false);

    // Mouse look
    document.addEventListener('pointerdown', e => {
        if (e.isPrimary) lookActive = true;
    });
    document.addEventListener('pointerup',   e => {
        if (e.isPrimary) lookActive = false;
    });
    document.addEventListener('pointermove', onPointerMove);

    // Spawn starter terminal
    spawnWindow('text', 0, 1.6, -2.5, 0);
}

function createGL(containerId) {
    const el = document.getElementById(containerId);
    const r = new THREE.WebGLRenderer({alpha:true, antialias:true});
    r.setSize(el.clientWidth, el.clientHeight);
    r.domElement.style.position = 'absolute';
    r.domElement.style.inset = '0';
    el.appendChild(r.domElement);
    return r;
}

function createCSS(containerId) {
    const el = document.getElementById(containerId);
    const r = new CSS3DRenderer();
    r.setSize(el.clientWidth, el.clientHeight);
    r.domElement.style.position = 'absolute';
    r.domElement.style.inset = '0';
    r.domElement.style.pointerEvents = 'none';
    el.appendChild(r.domElement);
    return r;
}

// ── INPUT ───────────────────────────────────────────────────────
function onKeyDown(e) {
    keys[e.code] = true;
    e.preventDefault();

    const spawnDist = 2.8;
    const dir = new THREE.Vector3(
        -Math.sin(player.rotationY),
        0,
        -Math.cos(player.rotationY)
    );

    const pos = player.position.clone().addScaledVector(dir, spawnDist);

    switch(e.key) {
        case '1': spawnWindow('text',    pos.x, pos.y, pos.z, player.rotationY); break;
        case '2': {
            const url = prompt("Image URL", "https://picsum.photos/1200/900?r="+Date.now());
            if(url) spawnWindow('image', pos.x, pos.y, pos.z, player.rotationY, url);
            break;
        }
        case '3': {
            const url = prompt("MP4 URL", "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4");
            if(url) spawnWindow('video', pos.x, pos.y, pos.z, player.rotationY, url);
            break;
        }
        case '4': {
            const id = prompt("YouTube ID", "dQw4w9WgXcQ");
            if(id) spawnWindow('youtube', pos.x, pos.y, pos.z, player.rotationY, id);
            break;
        }
        case 'x':
        case 'X': removeLastWindow(); break;
    }
}

function onPointerMove(e) {
    if (!lookActive) return;
    const dx = e.clientX - prevMouse.x;
    const dy = e.clientY - prevMouse.y;

    player.rotationY -= dx * 0.0035;
    // Optional: pitch if you want (commented for now)
    // player.pitch = THREE.MathUtils.clamp(player.pitch - dy * 0.003, -1.2, 1.2);

    prevMouse.x = e.clientX;
    prevMouse.y = e.clientY;
}

// ── WINDOWS ──────────────────────────────────────────────────────
function spawnWindow(type, x, y, z, rotY = 0, url = "") {
    windowId++;

    const div = document.createElement('div');
    div.style.width = '720px';
    div.style.height = '480px';
    div.style.background = 'rgba(4, 18, 32, 0.92)';
    div.style.border = '2px solid #0ff8';
    div.style.boxShadow = '0 0 50px #0ff4, inset 0 0 30px #0ff2';
    div.style.color = '#0ff';
    div.style.overflow = 'hidden';
    div.style.position = 'relative';
    div.style.fontSize = '18px';

    // Header
    const hdr = document.createElement('div');
    hdr.innerHTML = `HELEN_NEXUS • ${type.toUpperCase()} #${windowId}`;
    hdr.style.padding = '10px 14px';
    hdr.style.background = 'rgba(0,255,255,0.15)';
    hdr.style.fontWeight = 'bold';
    hdr.style.display = 'flex';
    hdr.style.justifyContent = 'space-between';
    div.appendChild(hdr);

    // Close button
    const closeBtn = document.createElement('span');
    closeBtn.className = 'window-close';
    closeBtn.textContent = '×';
    closeBtn.onclick = () => {
        sceneL.remove(objL);
        sceneR.remove(objR);
        windows = windows.filter(w => w.id !== id);
    };
    hdr.appendChild(closeBtn);

    // Content area
    const cont = document.createElement('div');
    cont.style.flex = '1';
    cont.style.position = 'relative';
    cont.style.overflow = 'hidden';

    if (type === 'text') {
        cont.style.padding = '1.4rem';
        cont.innerHTML = `
            <p>> STATUS ........ ONLINE</p>
            <p>> EYE ........... ${Math.random()>0.5?'LEFT':'RIGHT'}</p>
            <p>> ACCESS ....... ADMIN</p>
            <p style="margin-top:2rem;color:#fff;animation:blink 1.2s infinite;">_</p>
            <style>@keyframes blink{50%{opacity:0}}</style>
        `;
    } else if (type === 'image') {
        cont.innerHTML = `<img src="${url}" style="width:100%;height:100%;object-fit:cover;">`;
    } else if (type === 'video') {
        cont.innerHTML = `<video src="${url}" autoplay loop muted controls style="width:100%;height:100%;object-fit:cover;"></video>`;
    } else if (type === 'youtube') {
        cont.innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${url}?autoplay=1&mute=1&rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
    }

    div.appendChild(cont);

    const obj = new CSS3DObject(div);
    obj.scale.setScalar(0.0022);
    obj.position.set(x, y, z);
    obj.rotation.y = rotY;

    const objL = obj.clone();
    const objR = obj.clone();

    sceneL.add(objL);
    sceneR.add(objR);

    windows.push({id:windowId, objL, objR, element:div});
}

function removeLastWindow() {
    if (windows.length === 0) return;
    const w = windows.pop();
    sceneL.remove(w.objL);
    sceneR.remove(w.objR);
}

// ── LOOP ─────────────────────────────────────────────────────────
function resize() {
    const w = window.innerWidth / 2;
    const h = window.innerHeight;
    camera.aspect = w / h;
    camera.updateProjectionMatrix();

    [rendererL, rendererR, cssL, cssR].forEach(r => r.setSize(w, h));
}

function updateMovement() {
    const speed = 0.08;
    const rotSpeed = 0.035;

    if (keys['KeyA'] || keys['ArrowLeft'])  player.rotationY += rotSpeed;
    if (keys['KeyD'] || keys['ArrowRight']) player.rotationY -= rotSpeed;

    const forward = new THREE.Vector3(
        -Math.sin(player.rotationY),
        0,
        -Math.cos(player.rotationY)
    );

    const right = new THREE.Vector3(
        Math.cos(player.rotationY),
        0,
        -Math.sin(player.rotationY)
    );

    player.velocity.set(0,0,0);

    if (keys['KeyW'] || keys['ArrowUp'])    player.velocity.addScaledVector(forward, speed);
    if (keys['KeyS'] || keys['ArrowDown'])  player.velocity.addScaledVector(forward, -speed * 0.7);
    if (keys['KeyQ'])                       player.velocity.y += speed;
    if (keys['KeyE'])                       player.velocity.y -= speed;

    player.position.add(player.velocity);
}

function animate() {
    requestAnimationFrame(animate);

    updateMovement();

    const halfIPD = IPD / 2;

    // LEFT eye
    camera.position.copy(player.position);
    camera.rotation.set(0, player.rotationY, 0);
    camera.translateX(-halfIPD);
    camera.lookAt(player.position.clone().add(new THREE.Vector3(0,0,-CONVERGENCE)));
    camera.updateMatrixWorld();

    rendererL.render(sceneCommon, camera);
    cssL.render(sceneL, camera);

    // RIGHT eye
    camera.position.copy(player.position);
    camera.rotation.set(0, player.rotationY, 0);
    camera.translateX( halfIPD);
    camera.lookAt(player.position.clone().add(new THREE.Vector3(0,0,-CONVERGENCE)));
    camera.updateMatrixWorld();

    rendererR.render(sceneCommon, camera);
    cssR.render(sceneR, camera);
}
</script>
</body>
</html>
