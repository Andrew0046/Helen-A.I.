<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>HELEN: OPTIMIZED V2.6</title>
    <style>
        body { margin:0; overflow:hidden; background:#000; font-family:'Courier New', monospace; touch-action: none; }
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); color: #00ffff;
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100;
        }
        h1 { font-size: 40px; text-shadow: 0 0 10px #00ffff; margin-bottom: 10px; }
        .status { margin-top: 10px; font-size: 14px; color: #aaa; text-align: center; line-height: 1.5; white-space: pre-wrap;}
        #api-container { margin: 20px 0; display: flex; flex-direction: column; gap: 10px; width: 80%; max-width: 400px; }
        input { background: rgba(0,20,20,0.8); border: 1px solid #00ffff; color: #00ffff; padding: 10px; font-family: 'Courier New'; text-align: center; letter-spacing: 2px; }
        input:focus { outline: none; box-shadow: 0 0 15px #00ffff; }
        .btn-group { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; width: 80%; max-width: 300px; }
        button { padding: 15px; font-size: 16px; font-weight: bold; font-family: 'Courier New', monospace; background: transparent; color: #00ffff; border: 2px solid #00ffff; cursor: pointer; text-transform: uppercase; transition: 0.2s; }
        button:hover { background: #00ffff; color: #000; }
        .danger-btn { border-color: #ff0055; color: #ff0055; margin-top: 20px;}
        .danger-btn:hover { background: #ff0055; color: #fff; }
        .controls-hint { font-size: 11px; color: #666; margin-top: 20px; text-align: left; width: 100%; }
        #flash { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fff; opacity: 0; pointer-events: none; z-index: 200; transition: opacity 0.1s; }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>

    <script type="importmap">
        { "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "webxr-polyfill": "https://cdn.jsdelivr.net/npm/webxr-polyfill@latest/build/webxr-polyfill.module.js",
            "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }}
    </script>
</head>
<body>

<video id="camera-feed" autoplay muted playsinline style="display:none;"></video>
<canvas id="vision-canvas" style="display:none;"></canvas>
<div id="flash"></div>
<input type="file" id="intel-input" multiple accept="*/*" style="display:none">

<div id="overlay">
    <h1>HELEN OS</h1>
    <div class="status" id="system-status">[ COCKPIT MK.IV OPTIMIZED ]<br>System Ready.</div>
    <div id="api-container">
        <input type="password" id="gemini-key" placeholder="PASTE GEMINI API KEY">
        <button onclick="saveKey()" id="init-btn">INITIALIZE SYSTEM</button>
        <button onclick="resetSystem()" class="danger-btn">[ RESET SYSTEM ]</button>
    </div>
    <div class="btn-group" id="main-controls" style="display:none;">
        <button onclick="document.getElementById('intel-input').click()">ðŸ“‚ LOAD INTEL</button>
        <div id="vr-btn-container"></div>
        <div class="controls-hint">[GAZE] LOOK TO INTERACT / [VR] TRIGGER TO SELECT</div>
    </div>
</div>

<script type="module">
    import * as THREE from 'three';
    import { VRButton } from 'three/addons/webxr/VRButton.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';
    import { GoogleGenerativeAI } from "@google/generative-ai";

    // --- CORE VARIABLES ---
    let scene, camera, renderer, dolly, raycaster = new THREE.Raycaster();
    let hudTexture, hudContext, camMaterial;
    let targets = [], cockpitPanels = [], cockpitGroup, reticle;
    let menuGroup, menuMesh, menuCtx, menuTexture;
    
    // --- STATE & SETTINGS ---
    let GEMINI_KEY = localStorage.getItem('helen_gemini_key');
    let genAI, model, recognition, synth = window.speechSynthesis;
    let isListening = false, isSpeaking = false, aiStatus = "STANDBY"; 
    let chatHistory = JSON.parse(localStorage.getItem('helen_chat_history') || "[]");
    
    let CUSTOM_DATABASE = [], DEFAULT_DATABASE = [{ type: 'image', src: 'https://upload.wikimedia.org/wikipedia/commons/e/ec/Mona_Lisa%2C_by_Leonardo_da_Vinci%2C_from_C2RMF_retouched.jpg', label: 'DEFAULT.JPG' }];
    
    // --- INPUT STATE ---
    let isMenuOpen = false, hoveredFileIndex = -1, menuScrollIndex = 0;
    let activeObject = null, grabbedObject = null;
    let menuSelectionTimer = 0, gazeProgress = 0, lastMenuToggle = 0;
    let currentSpeed = 0, targetSpeed = 0, currentRot = 0, targetRot = 0;
    let isMouseDown = false, prevMouse = { x: 0, y: 0 };
    let visionMode = 0;
    
    // --- CONSTANTS ---
    const MAX_MENU_VISIBLE = 9;
    const VR_WALK_SPEED = 0.05, MOVE_SPEED = 0.05, ROT_SPEED = 0.04;
    const GAZE_TIME = 1500; // Time to trigger selection (ms)
    
    // --- INIT ---
    window.saveKey = function() {
        const key = document.getElementById('gemini-key').value.trim(); 
        if(key.length > 10) { localStorage.setItem('helen_gemini_key', key); GEMINI_KEY = key; checkAuth(); }
    };
    window.resetSystem = function() { localStorage.clear(); location.reload(); }

    function checkAuth() {
        if (GEMINI_KEY) {
            document.getElementById('api-container').style.display = 'none';
            document.getElementById('main-controls').style.display = 'flex';
            try {
                genAI = new GoogleGenerativeAI(GEMINI_KEY);
                model = genAI.getGenerativeModel({ model: "gemini-1.5-flash", systemInstruction: "You are HELEN, a tactical AI." });
                initVoice();
            } catch(e) { console.error(e); }
        }
    }

    function initVoice() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.onstart = () => { isListening = true; aiStatus = "LISTENING"; updateHUD(); };
            recognition.onend = () => { isListening = false; aiStatus = "PROCESSING"; updateHUD(); };
            recognition.onresult = (e) => askGemini(e.results[0][0].transcript);
        }
    }

    async function scanCameras() {
        try {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const cams = devices.filter(d => d.kind === 'videoinput' && !d.label.toLowerCase().includes('front'));
            const id = cams.length > 0 ? cams[0].deviceId : undefined;
            const stream = await navigator.mediaDevices.getUserMedia({ video: id ? { deviceId: { exact: id } } : { facingMode: 'environment' } });
            document.getElementById('camera-feed').srcObject = stream;
            init3D(stream);
        } catch(e) { init3D(null); }
    }

    // --- 3D SETUP ---
    function init3D(stream) {
        scene = new THREE.Scene();
        dolly = new THREE.Group(); dolly.position.set(0, 0, 5); scene.add(dolly);
        camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 100); dolly.add(camera);

        // Vision Shader
        const vidTex = stream ? new THREE.VideoTexture(document.getElementById('camera-feed')) : null;
        if(vidTex) { vidTex.colorSpace = THREE.SRGBColorSpace; vidTex.generateMipmaps = false; }
        
        const frag = `
        uniform sampler2D tDiffuse; uniform float uMode; varying vec2 vUv;
        void main() {
            vec4 c = texture2D(tDiffuse, vUv);
            if(uMode > 1.5) gl_FragColor = vec4(0.0,0.0,0.0,1.0); // VOID
            else if(uMode > 0.5) { // CYBER EDGE
                float d = 0.002;
                vec4 h = -texture2D(tDiffuse, vUv+vec2(-d,0)) + texture2D(tDiffuse, vUv+vec2(d,0));
                vec4 v = -texture2D(tDiffuse, vUv+vec2(0,-d)) + texture2D(tDiffuse, vUv+vec2(0,d));
                float val = length(vec2(length(h.rgb), length(v.rgb)));
                gl_FragColor = val > 0.1 ? vec4(0.0,1.0,1.0,1.0)*val*2.0 : vec4(0.0,0.05,0.1,1.0);
            } else gl_FragColor = c;
        }`;
        
        camMaterial = new THREE.ShaderMaterial({
            uniforms: { tDiffuse: { value: vidTex }, uMode: { value: 0.0 } },
            vertexShader: `varying vec2 vUv; void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 ); }`,
            fragmentShader: frag, depthTest: false, depthWrite: false
        });
        const camPlane = new THREE.Mesh(new THREE.PlaneGeometry(50, 30), camMaterial); camPlane.position.z = -20; camera.add(camPlane); 

        // HUD
        const hC = document.createElement('canvas'); hC.width=1024; hC.height=1024;
        hudContext = hC.getContext('2d'); hudTexture = new THREE.CanvasTexture(hC);
        const hudMesh = new THREE.Mesh(new THREE.PlaneGeometry(1.5, 1.5), new THREE.MeshBasicMaterial({ map: hudTexture, transparent: true, opacity: 0.9, depthTest: false }));
        hudMesh.position.set(0, 0, -1.5); camera.add(hudMesh);

        // Scene
        scene.add(new THREE.GridHelper(40, 40, 0x00ffff, 0x111111));
        const l = new THREE.DirectionalLight(0xffffff, 2); l.position.set(0, 5, 5); scene.add(l); scene.add(new THREE.AmbientLight(0xffffff, 1));
        
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true }); 
        renderer.setPixelRatio(1); renderer.setSize(window.innerWidth, window.innerHeight); renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);
        
        createCockpit(); 
        createMenuSystem();
        initControls();

        const btn = VRButton.createButton(renderer); 
        document.getElementById('vr-btn-container').appendChild(btn);
        renderer.xr.addEventListener('sessionstart', () => { document.getElementById('overlay').style.display = 'none'; });

        if(localStorage.getItem('helen_layout_ai')) loadMission();
        animate();
    }

    // --- SYSTEMS ---
    function createCockpit() {
        cockpitGroup = new THREE.Group(); cockpitGroup.position.set(0, -1.6, -1.0); cockpitGroup.rotation.x = -1.37; dolly.add(cockpitGroup);
        const mkChev = (c, rZ, x, act) => {
            const s = new THREE.Shape(); s.moveTo(0,0.3); s.lineTo(0.3,-0.2); s.lineTo(0,-0.1); s.lineTo(-0.3,-0.2);
            const m = new THREE.Mesh(new THREE.ShapeGeometry(s), new THREE.MeshBasicMaterial({ color:c, transparent:true, opacity:0.5, side:2 }));
            m.rotation.z = rZ; m.position.x = x; m.userData = { action: act, baseScale: 1.5 }; m.scale.setScalar(1.5);
            cockpitGroup.add(m); cockpitPanels.push(m);
        };
        mkChev(0x00ff00, 0, 0, "FWD"); mkChev(0x00ffff, 1.57, -0.6, "LEFT"); mkChev(0x00ffff, -1.57, 0.6, "RIGHT");
        
        // Menu Button
        const mb = new THREE.Mesh(new THREE.PlaneGeometry(0.3,0.3), new THREE.MeshBasicMaterial({ color:0xff0055, transparent:true, opacity:0.5 }));
        mb.position.set(0, -0.4, 0); mb.userData = { action: "MENU", baseScale: 1 };
        mb.add(new THREE.LineSegments(new THREE.EdgesGeometry(mb.geometry), new THREE.LineBasicMaterial({color:0xff0055})));
        cockpitGroup.add(mb); cockpitPanels.push(mb);
        
        // Reticle
        reticle = new THREE.Mesh(new THREE.RingGeometry(0.015, 0.02, 32), new THREE.MeshBasicMaterial({ color: 0xffffff, depthTest: false }));
        reticle.position.z = -1; camera.add(reticle);
    }

    function createMenuSystem() {
        const c = document.createElement('canvas'); c.width=1024; c.height=1024;
        menuCtx = c.getContext('2d'); menuTexture = new THREE.CanvasTexture(c);
        menuMesh = new THREE.Mesh(new THREE.PlaneGeometry(2,2), new THREE.MeshBasicMaterial({ map: menuTexture, transparent: true, side: 2 }));
        menuGroup = new THREE.Group(); menuGroup.add(menuMesh); 
        menuGroup.add(new THREE.LineSegments(new THREE.EdgesGeometry(menuMesh.geometry), new THREE.LineBasicMaterial({color:0x00ffff})));
        scene.add(menuGroup); menuGroup.visible = false;
    }

    // --- UNIFIED INPUT LOGIC (THE OPTIMIZATION) ---
    function handleInput() {
        const dt = 16; 
        // 1. VR/Mouse Walk
        if ((renderer.xr.isPresenting && isMouseDown) || Math.abs(currentSpeed) > 0.001) {
            const dir = new THREE.Vector3(); camera.getWorldDirection(dir); dir.y=0; dir.normalize();
            dolly.position.addScaledVector(dir, Math.max(currentSpeed, isMouseDown && renderer.xr.isPresenting ? VR_WALK_SPEED : 0));
        }
        if (Math.abs(currentRot) > 0.001) dolly.rotation.y += currentRot;

        // 2. UNIFIED RAYCASTER (Menu + World + Cockpit)
        raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
        
        // Pickable objects depend on state
        let pickables = [...cockpitPanels];
        if(isMenuOpen) pickables.push(menuMesh);
        else pickables = pickables.concat(targets);

        const hits = raycaster.intersectObjects(pickables, true);
        gazeProgress = 0; // Reset
        let hitSomething = false;

        if (hits.length > 0) {
            let hit = hits[0].object;
            hitSomething = true;

            // CASE A: MENU INTERACTION
            if (isMenuOpen && hit === menuMesh) {
                const uvY = hits[0].uv.y;
                if (uvY < 0.82) {
                    const vIdx = Math.floor((0.82 - uvY) / 0.068);
                    const rIdx = vIdx + menuScrollIndex;
                    const db = CUSTOM_DATABASE.concat(DEFAULT_DATABASE); // simplified logic
                    if (vIdx >= 0 && vIdx < MAX_MENU_VISIBLE) {
                         processGaze(rIdx, () => {
                             spawnItem(rIdx < 6 ? rIdx : rIdx, rIdx >= 6 ? db[rIdx-6] : null);
                             hoveredFileIndex = -1;
                         });
                         hoveredFileIndex = rIdx;
                    }
                }
            } 
            // CASE B: COCKPIT BUTTONS
            else if (hit.parent === cockpitGroup) {
                hit.scale.setScalar(hit.userData.baseScale * 1.2);
                if(hit.userData.action === "FWD") currentSpeed = 0.08;
                else if(hit.userData.action === "LEFT") currentRot = 0.04;
                else if(hit.userData.action === "RIGHT") currentRot = -0.04;
                else if(hit.userData.action === "MENU") {
                    if(Date.now() - lastMenuToggle > 1500) {
                        isMenuOpen = !isMenuOpen; menuGroup.visible = isMenuOpen;
                        if(isMenuOpen) updateMenuPos();
                        lastMenuToggle = Date.now();
                    }
                }
            }
            // CASE C: PDF BUTTONS / OBJECTS
            else {
                // Reset Cockpit movement if looking away
                currentSpeed *= 0.9; currentRot *= 0.9;

                if (hit.userData.isButton) { // PDF Arrow
                    processGaze(hit.uuid, () => {
                        const s = hit.parent;
                        const d = hit.userData.action === 'NEXT' ? 1 : -1;
                        if(s.userData.type === 'pdf') renderPDF(s, s.userData.pageNum + d);
                    });
                } else {
                    // Just highlighting object
                    while(hit.parent && !hit.userData.isScreen && hit !== scene) hit = hit.parent;
                    if(hit.userData.isScreen || hit.userData.isModel) {
                        activeObject = hit;
                        if(!grabbedObject) menuSelectionTimer = 0; // Don't trigger click on pure objects yet
                    }
                }
            }
        } else {
            // Looking at nothing -> damp movement
            currentSpeed *= 0.9; currentRot *= 0.9;
            activeObject = null;
            hoveredFileIndex = -1;
            menuSelectionTimer = 0;
        }

        // Gamepad (Simplified)
        const pads = navigator.getGamepads();
        const pad = pads[0] || pads[1];
        if (pad) {
            // Add joystick logic if needed, kept stripped for "why" demo
            if(pad.buttons[0].pressed && activeObject) grabbedObject = activeObject;
            else grabbedObject = null;
            
            if(grabbedObject) {
                 // Simple tether logic
                 const d = new THREE.Vector3(); camera.getWorldDirection(d);
                 grabbedObject.position.copy(camera.position).add(d.multiplyScalar(3));
            }
        }
    }

    // Helper for Gaze Timer
    let lastGazeTarget = null;
    function processGaze(targetId, callback) {
        if (lastGazeTarget !== targetId) {
            lastGazeTarget = targetId;
            menuSelectionTimer = Date.now();
        } else {
            const el = Date.now() - menuSelectionTimer;
            gazeProgress = Math.min(el / GAZE_TIME, 1.0);
            if (el > GAZE_TIME) {
                callback();
                menuSelectionTimer = Date.now() + 2000; // Cooldown
            }
        }
    }

    // --- SPAWNING & RENDER ---
    function spawnItem(idx, data) {
        if (idx < 6) { // System Commands
            if(idx===0) saveMission(); else if(idx===1) loadMission(); else if(idx===2) { targets.forEach(t=>scene.remove(t)); targets=[]; }
            else if(idx===3 && recognition) recognition.start(); else if(idx===4) performVisualScan(); else if(idx===5) { localStorage.clear(); location.reload(); }
        } else { // Spawn Data
            const dir = new THREE.Vector3(); camera.getWorldDirection(dir);
            const pos = camera.position.clone().add(dir.multiplyScalar(3));
            
            // TACTICAL FIX: Floor vs Eye Level
            const isMod = (data.type==='fbx'||data.type==='glb');
            pos.y = isMod ? 0 : 1.6;
            
            if(isMod) spawnModel(pos, data); else spawnScreen(pos, data);
            isMenuOpen = false; menuGroup.visible = false;
        }
    }

    // ... (Model/Screen loaders kept similar but compressed for space) ...
    async function spawnScreen(pos, data) {
        const g = new THREE.PlaneGeometry(1,1);
        const m = new THREE.Mesh(g, new THREE.MeshBasicMaterial({side:2, transparent:true, opacity:0.9}));
        m.position.copy(pos); m.lookAt(camera.position.x, pos.y, camera.position.z);
        m.userData = { isScreen:true, type:data.type, label:data.label };
        
        // Ghost Border
        const b = new THREE.LineSegments(new THREE.EdgesGeometry(g), new THREE.LineBasicMaterial({color:0xffff00}));
        b.raycast = ()=>{}; m.add(b);

        if(data.type === 'pdf') {
            const pdf = await pdfjsLib.getDocument(data.buffer.slice(0)).promise;
            m.userData.pdfDoc=pdf; m.userData.pageNum=1; m.userData.totalPages=pdf.numPages;
            renderPDF(m, 1);
            // Arrows
            const mkArr = (d) => {
                const bM = new THREE.Mesh(new THREE.PlaneGeometry(0.2,0.2), new THREE.MeshBasicMaterial({color:0x00ffff}));
                bM.position.set(d==='NEXT'?0.6:-0.6, 0, 0.05); bM.userData={isButton:true, action:d};
                m.add(bM);
            }
            mkArr('NEXT'); mkArr('PREV');
        } else {
             new THREE.TextureLoader().load(data.src, t=>{ m.material.map=t; m.scale.set(1.8,1.8,1); });
        }
        scene.add(m); targets.push(m);
    }

    async function renderPDF(m, num) {
        if(!m.userData.pdfDoc || num < 1 || num > m.userData.totalPages) return;
        m.userData.pageNum = num;
        const p = await m.userData.pdfDoc.getPage(num);
        const v = p.getViewport({scale:2});
        const c = document.createElement('canvas'); c.width=v.width; c.height=v.height;
        await p.render({canvasContext:c.getContext('2d'), viewport:v}).promise;
        if(m.material.map) m.material.map.dispose();
        m.material.map = new THREE.CanvasTexture(c); m.material.needsUpdate=true;
        m.scale.set(1.8 * (v.width/v.height), 1.8, 1);
    }

    function spawnModel(pos, data) {
        const l = data.type==='fbx' ? new FBXLoader() : new GLTFLoader();
        l.load(data.src, (o) => {
            const m = data.type==='fbx'?o:o.scene;
            m.position.copy(pos); 
            const b = new THREE.Box3().setFromObject(m); const s = b.getSize(new THREE.Vector3());
            m.scale.setScalar(1.0/Math.max(s.x,s.y,s.z)); // Auto-scale
            m.userData = { isModel:true, label:data.label };
            // Simple hitbox
            const h = new THREE.Mesh(new THREE.BoxGeometry(s.x,s.y,s.z), new THREE.MeshBasicMaterial({visible:false}));
            m.add(h); 
            scene.add(m); targets.push(m);
        });
    }

    // --- UTILS ---
    function updateMenuPos() {
        const d = new THREE.Vector3(); camera.getWorldDirection(d); d.y=0;
        menuGroup.position.copy(camera.position).add(d.normalize().multiplyScalar(2.5));
        menuGroup.lookAt(camera.position);
        drawMenu();
    }
    
    function drawMenu() {
        const c = menuCtx; const W=1024;
        c.fillStyle = 'rgba(0,10,20,0.9)'; c.fillRect(0,0,W,W);
        c.fillStyle = '#00ffff'; c.font = '60px Courier'; c.fillText("TACTICAL INTEL", 100, 100);
        
        const sys = ["[SAVE]","[LOAD]","[CLEAR]","[VOICE]","[SCAN]","[RESET]"];
        const list = sys.concat(CUSTOM_DATABASE);
        
        let y = 200;
        for(let i=0; i<9; i++) {
            const idx = i + menuScrollIndex;
            if(idx >= list.length) break;
            const item = list[idx];
            const txt = (item.label || item);
            if(idx === hoveredFileIndex) { c.fillStyle='rgba(0,255,255,0.3)'; c.fillRect(50, y-50, 900, 60); }
            c.fillStyle = idx<6 ? '#ff0055':'#00ffff';
            c.fillText(txt.substring(0,30), 80, y);
            y += 70;
        }
        if(sysMessage) c.fillText(sysMessage, 100, 900);
        menuTexture.needsUpdate = true;
    }

    function updateHUD() {
        const c = hudContext; c.clearRect(0,0,1024,1024);
        c.fillStyle='#00ffff'; c.font='30px Courier'; c.textAlign='center';
        c.fillText(`AI: ${aiStatus} | VIS: ${visionMode}`, 512, 50);
        
        // Gaze Ring
        if(gazeProgress > 0) {
            c.beginPath(); c.arc(512,512, 60, -1.57, -1.57+(6.28*gazeProgress));
            c.lineWidth=10; c.strokeStyle='#00ffff'; c.stroke();
        }
        hudTexture.needsUpdate = true;
    }

    function saveMission() { 
        const d = targets.map(t=>({ type:t.userData.type, label:t.userData.label, pos:t.position, rot:t.rotation })); 
        localStorage.setItem('helen_layout_ai', JSON.stringify(d)); 
        sysMessage="SAVED"; drawMenu();
    }
    
    function loadMission() {
        const d = JSON.parse(localStorage.getItem('helen_layout_ai'));
        d.forEach(i => {
            if(i.type === 'pdf') spawnScreen(i.pos, {type:'pdf', buffer:new ArrayBuffer(0), label:i.label}); // Placeholder
            // Note: Full reload requires restoring DB buffers which is complex for this snippet
        });
    }

    function animate() {
        renderer.setAnimationLoop(() => { handleInput(); updateHUD(); renderer.render(scene, camera); });
    }
    
    function initControls() {
        const input = document.getElementById('intel-input');
        input.onchange = async (e) => {
            for(let f of e.target.files) {
                let d = { label:f.name.toUpperCase() };
                if(f.name.endsWith('.pdf')) { d.type='pdf'; d.buffer = await f.arrayBuffer(); }
                else if(f.name.endsWith('.fbx')) { d.type='fbx'; d.src = URL.createObjectURL(f); }
                else if(f.name.endsWith('.glb')) { d.type='glb'; d.src = URL.createObjectURL(f); }
                else { d.type='img'; d.src = URL.createObjectURL(f); }
                CUSTOM_DATABASE.push(d);
            }
        };
        
        window.onmousedown = (e) => { isMouseDown=true; prevMouse={x:e.clientX, y:e.clientY}; };
        window.onmouseup = () => isMouseDown=false;
        window.onmousemove = (e) => {
            if(!isMouseDown || renderer.xr.isPresenting) return;
            dolly.rotation.y -= (e.clientX - prevMouse.x)*0.002;
            prevMouse = {x:e.clientX, y:e.clientY};
        };
        window.onkeydown = (e) => { if(e.key==='v') visionMode=(visionMode+1)%3; if(camMaterial) camMaterial.uniforms.uMode.value=visionMode; };
        
        // Init Cameras
        scanCameras();
        if(GEMINI_KEY) checkAuth();
    }
</script>
</body>
</html>
