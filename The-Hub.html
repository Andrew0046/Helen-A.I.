<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hub v33.1: Overlay Test</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: monospace; color: white; }
        
        /* THE RAW VIDEO OVERLAY */
        /* This sits ON TOP of VR. If this is black, the stream is dead. */
        #remote-video { 
            position: fixed; 
            bottom: 10px; right: 10px; 
            width: 160px; height: 120px; 
            border: 2px solid lime; 
            z-index: 99999; 
            background: #222;
            object-fit: cover;
        }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #111; z-index: 999; }
        .hidden { display: none !important; }
        .btn-main { padding: 20px 40px; font-size: 20px; background: #00d2ff; border: none; font-weight: bold; cursor: pointer; }
    </style>

    <script>
        // CUSTOM COMPONENT: Forces the VR screen to update every frame
        AFRAME.registerComponent('force-update', {
            tick: function () {
                const mesh = this.el.getObject3D('mesh');
                if (mesh && mesh.material.map) {
                    mesh.material.map.needsUpdate = true;
                }
            }
        });
    </script>
</head>
<body>

    <video id="remote-video" autoplay playsinline muted></video>

    <div id="ui-layer">
        <h1>v33.1 Overlay Test</h1>
        <p>1. Start Phone B.</p>
        <p>2. Enter VR.</p>
        <p>3. Click CONNECT inside VR.</p>
        <button id="btn-enter" class="btn-main">ENTER VR</button>
    </div>

    <a-scene background="color: #000">
        
        <a-assets>
            <img id="grid" src="https://cdn.aframe.io/a-painter/images/floor.jpg">
        </a-assets>

        <a-plane position="0 0 -4" rotation="-90 0 0" width="80" height="80" src="#grid" color="#222"></a-plane>
        <a-sky color="#111"></a-sky>

        <a-entity id="rig" position="0 1.6 0">
            <a-camera look-controls="reverseMouseDrag: true" wasd-controls="enabled: false">
                <a-cursor color="#00d2ff" fuse="true" fuse-timeout="1500"></a-cursor>
                
                <a-plane 
                    id="vr-screen"
                    position="0 0 -3" width="4" height="3" 
                    visible="false"
                    material="shader: flat; side: double"
                    force-update>
                </a-plane>

                <a-text id="status-text" value="READY" position="0 0.8 -3" align="center" color="yellow"></a-text>

                <a-plane id="btn-connect" position="0 -0.8 -2.5" width="1.5" height="0.4" color="#333" class="clickable">
                    <a-text value="CONNECT" align="center"></a-text>
                </a-plane>

            </a-camera>
        </a-entity>
    </a-scene>

    <script>
        const REMOTE_ID = "vr-hub-cam-01";
        const els = {
            vid: document.getElementById('remote-video'),
            screen: document.getElementById('vr-screen'),
            status: document.getElementById('status-text'),
            btn: document.getElementById('btn-connect')
        };

        // 1. Enter VR
        document.getElementById('btn-enter').addEventListener('click', () => {
            document.getElementById('ui-layer').classList.add('hidden');
            document.querySelector('a-scene').enterVR();
        });

        // 2. Connect Logic
        els.btn.addEventListener('click', () => {
            els.status.setAttribute('value', 'DIALING...');
            
            const peer = new Peer({ debug: 1 });

            peer.on('open', () => {
                els.status.setAttribute('value', 'CALLING...');
                
                // Audio dummy to keep connection alive
                const ctx = new AudioContext();
                const dest = ctx.createMediaStreamDestination();
                const call = peer.call(REMOTE_ID, dest.stream);

                call.on('stream', (stream) => {
                    els.status.setAttribute('value', 'STREAM FOUND');
                    
                    // A. Attach to Video Element
                    els.vid.srcObject = stream;
                    
                    // B. Force Play
                    els.vid.play().then(() => {
                        els.status.setAttribute('value', 'PLAYING');
                        
                        // C. Paint to VR
                        const texture = new THREE.VideoTexture(els.vid);
                        texture.minFilter = THREE.LinearFilter;
                        texture.magFilter = THREE.LinearFilter;
                        
                        const mesh = els.screen.getObject3D('mesh');
                        mesh.material.map = texture;
                        mesh.material.needsUpdate = true;
                        
                        els.screen.setAttribute('visible', true);
                        els.btn.setAttribute('visible', false); // Hide button
                    }).catch(e => {
                        els.status.setAttribute('value', 'PLAY ERROR: ' + e);
                    });
                });
            });

            peer.on('error', (err) => {
                els.status.setAttribute('value', 'ERR: ' + err.type);
            });
        });
    </script>
</body>
</html>
