<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hub v33.0: Native Core</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: monospace; color: white; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #111; z-index: 999; }
        .hidden { display: none !important; }
        .btn-main { padding: 20px 40px; font-size: 20px; background: #00d2ff; border: none; font-weight: bold; cursor: pointer; }
        
        /* THE VIDEO ELEMENT - VISIBLE BUT TINY */
        /* We keep it visible so the browser doesn't pause decoding */
        #remote-video { 
            position: absolute; top: 0; left: 0; 
            width: 160px; height: 120px; 
            z-index: 1000; background: #333;
            border: 2px solid red; /* Visual check on 2D screen */
        }
    </style>
</head>
<body>

    <video id="remote-video" autoplay playsinline muted crossorigin="anonymous"></video>

    <div id="ui-layer">
        <h1>The Hub v33.0</h1>
        <p>1. Check Phone B is running.</p>
        <p>2. Enter VR.</p>
        <p>3. Click the CONNECT button in VR.</p>
        <button id="btn-enter" class="btn-main">ENTER VR</button>
    </div>

    <a-scene background="color: #000">
        
        <a-assets>
            <img id="grid" src="https://cdn.aframe.io/a-painter/images/floor.jpg">
        </a-assets>

        <a-plane position="0 0 -4" rotation="-90 0 0" width="80" height="80" src="#grid" color="#222"></a-plane>
        <a-sky color="#111"></a-sky>

        <a-entity id="rig" position="0 1.6 0">
            <a-camera look-controls="reverseMouseDrag: true" wasd-controls="enabled: false">
                <a-cursor color="#00d2ff" fuse="true" fuse-timeout="1500"></a-cursor>
                
                <a-plane position="0 0 -3.05" width="4.2" height="3.2" color="#ff00ff" shader="flat" visible="true"></a-plane>

                <a-video 
                    id="vid-screen"
                    src="#remote-video"
                    width="4" height="3"
                    position="0 0 -3"
                    visible="false">
                </a-video>

                <a-plane id="btn-accept" position="0 0 -2.5" width="2" height="0.5" color="#00ff00" visible="false" class="clickable">
                    <a-text value="TAP TO VIEW STREAM" align="center" color="black" scale="2 2 2"></a-text>
                </a-plane>

            </a-camera>
        </a-entity>

        <a-entity id="menu" position="0 1 -2" rotation="-20 0 0">
            <a-plane id="btn-connect" width="1" height="0.3" color="#333" class="clickable">
                <a-text id="txt-status" value="CONNECT" align="center"></a-text>
            </a-plane>
        </a-entity>

    </a-scene>

    <script>
        const REMOTE_ID = "vr-hub-cam-01";
        const els = {
            vid: document.getElementById('remote-video'),
            screen: document.getElementById('vid-screen'),
            btnConnect: document.getElementById('btn-connect'),
            txtStatus: document.getElementById('txt-status'),
            btnAccept: document.getElementById('btn-accept')
        };

        // 1. Enter VR
        document.getElementById('btn-enter').addEventListener('click', () => {
            document.getElementById('ui-layer').classList.add('hidden');
            document.querySelector('a-scene').enterVR();
        });

        // 2. Connect Button Logic
        els.btnConnect.addEventListener('click', () => {
            els.txtStatus.setAttribute('value', 'DIALING...');
            startPeer();
        });

        // 3. PeerJS Logic
        function startPeer() {
            const peer = new Peer({ debug: 1 });

            peer.on('open', () => {
                els.txtStatus.setAttribute('value', 'CALLING...');
                // Dummy stream to open the door
                const dummy = new AudioContext().createMediaStreamDestination().stream;
                const call = peer.call(REMOTE_ID, dummy);

                call.on('stream', (stream) => {
                    els.txtStatus.setAttribute('value', 'SIGNAL FOUND!');
                    
                    // Assign stream to video tag
                    els.vid.srcObject = stream;
                    
                    // SHOW THE "ACCEPT" BUTTON
                    // We force the user to click this to authorize playback
                    els.btnAccept.setAttribute('visible', true);
                });
            });

            peer.on('error', (err) => {
                els.txtStatus.setAttribute('value', 'ERROR: ' + err.type);
            });
        }

        // 4. THE MAGIC BUTTON (User Gesture)
        els.btnAccept.addEventListener('click', () => {
            // Play video triggered by USER CLICK
            els.vid.play().then(() => {
                console.log("Video Playing!");
                
                // Show screen, Hide button
                els.screen.setAttribute('visible', true);
                els.btnAccept.setAttribute('visible', false);
                els.txtStatus.setAttribute('value', 'LIVE FEED');
                
                // Force an update just in case
                setTimeout(() => {
                    els.vid.width = 640; // Force layout reflow
                }, 500);

            }).catch(e => {
                els.txtStatus.setAttribute('value', 'PLAY BLOCKED: ' + e);
            });
        });

    </script>
</body>
</html>
