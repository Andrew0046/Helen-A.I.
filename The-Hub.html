<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hub v31.0: Diagnostic</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; background: #050505; font-family: monospace; color: white; }
        #ui-layer { position: absolute; z-index: 9999; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.8s; }
        .hidden { opacity: 0; pointer-events: none; }
        h1 { font-weight: 200; letter-spacing: 8px; text-transform: uppercase; margin-bottom: 30px; }
        .hub-card { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); padding: 40px; border-radius: 16px; width: 450px; text-align: center; }
        .btn-main { background: linear-gradient(135deg, #00d2ff 0%, #0078ff 100%); border: none; padding: 15px 30px; color: white; font-weight: bold; font-size: 16px; border-radius: 30px; cursor: pointer; margin-top: 20px; width: 100%; }
        
        /* DEBUG VIDEO: Visible but tiny to force rendering */
        #remote-video { position: absolute; top: 0; left: 0; width: 10px; height: 10px; opacity: 0.1; z-index: 1000; }
        #debug-canvas { position: absolute; top: 0; right: 0; width: 100px; height: 100px; border: 1px solid red; z-index: 1000; background: black; }
    </style>
</head>
<body>

    <video id="remote-video" autoplay playsinline muted crossorigin="anonymous"></video>
    <canvas id="debug-canvas" width="512" height="512"></canvas>
    
    <div id="ui-layer">
        <h1>The <span style="color: #ff9d00">Hub</span> <span style="font-size: 0.5em; vertical-align: super; color: #666">v31.0</span></h1>
        <div class="hub-card">
            <h3>Diagnostic Mode</h3>
            <p style="color: #888;">If connection fails, read the VR Log.</p>
            <button id="btn-start" class="btn-main">ENTER VR</button>
        </div>
    </div>

    <a-scene background="color: #000">
        
        <a-assets>
            <img id="grid-texture" src="https://cdn.aframe.io/a-painter/images/floor.jpg">
        </a-assets>

        <a-sky color="#050505"></a-sky>
        <a-plane position="0 0 -4" rotation="-90 0 0" width="80" height="80" src="#grid-texture" repeat="40 40" color="#1a1a1a"></a-plane>
        <a-light type="ambient" intensity="0.5"></a-light>

        <a-entity id="hub-wrapper" position="0 0.8 -1.8" rotation="-25 0 0">
            <a-box depth="0.01" height="1.0" width="2.8" color="#ffffff" opacity="0.1" class="clickable"></a-box>
            <a-text value="System Ready" position="0 0.42 0.02" align="center" width="2.5"></a-text>
            
            <a-plane id="btn-feed" position="-1.1 0.4 0.02" width="0.5" height="0.12" color="#ffffff" opacity="0.15" class="clickable">
                <a-text id="txt-feed" value="CONNECT" align="center" width="2"></a-text>
            </a-plane>

            <a-plane id="btn-force" position="0 0 0.05" width="1" height="0.3" color="red" visible="false" class="clickable">
                <a-text value="FORCE START VIDEO" align="center" width="3" color="white"></a-text>
            </a-plane>

            <a-text id="debug-log" value="LOG: Waiting..." position="0 -0.6 0.02" align="center" width="3" color="#00ff00"></a-text>
        </a-entity>

        <a-entity id="rig" position="0 1.6 0">
            <a-camera look-controls="reverseMouseDrag: true" wasd-controls="enabled: false">
                <a-cursor color="#00d2ff" fuse="true" fuse-timeout="1500"></a-cursor>
                
                <a-plane id="ar-hud" width="6" height="3.37" position="0 0 -4" 
                         material="shader: flat; transparent: true; opacity: 0.9; side: double; color: #333" 
                         visible="false">
                </a-plane>
            </a-camera>
        </a-entity>
    </a-scene>

    <script>
        // CONFIG
        const REMOTE_PEER_ID = "vr-hub-cam-01"; 
        
        const state = { active: false, peer: null, conn: null, loop: null };
        const els = {
            btn: document.getElementById('btn-feed'),
            txt: document.getElementById('txt-feed'),
            log: document.getElementById('debug-log'),
            hud: document.getElementById('ar-hud'),
            forceBtn: document.getElementById('btn-force'),
            video: document.getElementById('remote-video'),
            canvas: document.getElementById('debug-canvas')
        };
        const ctx = els.canvas.getContext('2d');

        // LOGGING FUNCTION
        function log(msg) {
            console.log(msg);
            els.log.setAttribute('value', "LOG: " + msg);
        }

        // ENTER VR
        document.getElementById('btn-start').addEventListener('click', function() {
            document.getElementById('ui-layer').classList.add('hidden');
            const scene = document.querySelector('a-scene');
            if(scene.enterVR) scene.enterVR();
        });

        // CONNECT BUTTON
        els.btn.addEventListener('click', function() {
            if(!state.active) {
                startConnection();
            } else {
                stopConnection();
            }
        });

        // FORCE START BUTTON
        els.forceBtn.addEventListener('click', function() {
            log("Forcing Play...");
            els.video.play().then(() => log("Forced: Playing!")).catch(e => log("Force Fail: " + e));
            els.forceBtn.setAttribute('visible', false);
        });

        function startConnection() {
            log("Init Peer...");
            els.hud.setAttribute('visible', true);
            els.hud.setAttribute('color', '#ff0000'); // RED = Init

            const peer = new Peer({ debug: 1 });

            peer.on('open', (id) => {
                log("Calling Camera...");
                
                // Dummy stream to open channel
                const dummy = new AudioContext().createMediaStreamDestination().stream;
                const call = peer.call(REMOTE_PEER_ID, dummy);

                if(!call) { log("Call Failed!"); return; }

                call.on('stream', (stream) => {
                    log("Stream Received!");
                    els.hud.setAttribute('color', '#0000ff'); // BLUE = Stream Received
                    
                    els.video.srcObject = stream;
                    
                    // Attempt Play
                    const playPromise = els.video.play();
                    if (playPromise !== undefined) {
                        playPromise.then(_ => {
                            log("Video Playing!");
                            startRendering(); // Start Canvas Loop
                        })
                        .catch(error => {
                            log("AutoPlay Blocked!");
                            els.forceBtn.setAttribute('visible', true); // Show Force Button
                        });
                    }
                });

                call.on('close', () => stopConnection());
                call.on('error', (e) => log("Call Err: " + e));
                
                state.conn = call;
            });

            peer.on('error', (err) => log("Peer Err: " + err.type));
            state.peer = peer;
            state.active = true;
            els.txt.setAttribute('value', 'STOP');
        }

        function stopConnection() {
            log("Stopping...");
            if(state.conn) state.conn.close();
            if(state.peer) state.peer.destroy();
            if(state.loop) cancelAnimationFrame(state.loop);
            
            els.hud.setAttribute('visible', false);
            els.txt.setAttribute('value', 'CONNECT');
            els.forceBtn.setAttribute('visible', false);
            state.active = false;
        }

        // THE RENDER LOOP (Canvas -> Texture)
        function startRendering() {
            els.hud.setAttribute('color', '#ffffff'); // WHITE = Live
            
            // Create Texture from Canvas
            const texture = new THREE.CanvasTexture(els.canvas);
            const mesh = els.hud.getObject3D('mesh');
            if(mesh) mesh.material.map = texture;

            function step() {
                if(!state.active) return;
                
                if (els.video.readyState === els.video.HAVE_ENOUGH_DATA) {
                    // Draw video to canvas
                    ctx.drawImage(els.video, 0, 0, 512, 512);
                    
                    // Update VR Texture
                    if(mesh.material.map) mesh.material.map.needsUpdate = true;
                }
                
                state.loop = requestAnimationFrame(step);
            }
            step();
        }
    </script>
</body>
</html>
