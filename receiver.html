<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sandbox Receiver</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body style="font-family: sans-serif; text-align: center; padding: 20px;">

    <h2>RECEIVER (Phone A)</h2>
    
    <button id="btn" style="padding: 20px; font-size: 20px; background: #0078ff; color: white; border: none; border-radius: 10px; width: 100%; max-width: 400px;">
        1. CLICK TO CONNECT
    </button>
    
    <h3 id="log">Waiting to connect...</h3>
    
    <video id="vid" autoplay playsinline muted style="width: 100%; max-width: 400px; background: black; border: 2px solid #0078ff; min-height: 200px;"></video>
    
    <script>
        const logEl = document.getElementById('log');
        const vid = document.getElementById('vid');
        
        document.getElementById('btn').addEventListener('click', () => {
            logEl.innerText = "1. Connecting to Cloud...";
            logEl.style.color = "blue";
            
            const peer = new Peer({ debug: 2 });
            
            peer.on('open', (id) => {
                logEl.innerText = "2. Cloud OK! Dialing Phone B...";
                
                // THE FIX: We must send a dummy stream or PeerJS crashes silently
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const dummyStream = ctx.createMediaStreamDestination().stream;
                
                const call = peer.call('sandbox-cam-99', dummyStream); 
                
                if (!call) {
                    logEl.innerText = "ERROR: Call Object Failed to create.";
                    logEl.style.color = "red";
                    return;
                }
                
                call.on('stream', remoteStream => {
                    logEl.innerText = "3. Stream arrived! Forcing play...";
                    logEl.style.color = "orange";
                    
                    vid.srcObject = remoteStream;
                    
                    vid.play().then(() => {
                        logEl.innerText = "SUCCESS: LIVE FEED ACTIVE";
                        logEl.style.color = "green";
                    }).catch(e => {
                        logEl.innerText = "PLAY ERROR: " + e;
                        logEl.style.color = "red";
                    });
                });
                
                call.on('error', err => {
                    logEl.innerText = "Call Error: " + err;
                    logEl.style.color = "red";
                });
            });
            
            peer.on('error', err => {
                logEl.innerText = "Cloud Error: " + err.type;
                logEl.style.color = "red";
            });
        });
    </script>
</body>
</html>
