<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Hub 2.0: Pro Cinema</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; color: white; }
        #ui-layer {
            position: absolute; z-index: 9999; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #111 0%, #000 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.8s;
        }
        .hidden { opacity: 0; pointer-events: none; }
        .hub-card {
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(0, 210, 255, 0.2);
            backdrop-filter: blur(15px); padding: 40px; border-radius: 20px; width: 450px; text-align: center;
        }
        .btn-main {
            background: linear-gradient(135deg, #00d2ff 0%, #0078ff 100%); border: none; padding: 15px 30px;
            color: white; font-weight: bold; border-radius: 30px; cursor: pointer; width: 100%; margin-top: 20px;
        }
        input[type="text"] { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid #333; padding: 12px; color: #00d2ff; border-radius: 8px; margin-top: 15px; }
        #playlist-ui { margin-top: 20px; max-height: 120px; overflow-y: auto; text-align: left; font-size: 0.8rem; color: #888; }
        #light-canvas { display: none; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <h1 style="letter-spacing: 10px; font-weight: 200;">HUB <span style="color: #00d2ff; font-weight: 800;">2.0</span></h1>
        <div class="hub-card">
            <input type="file" id="file-input" accept="video/*, image/*" multiple style="display:none">
            <button class="btn-main" onclick="document.getElementById('file-input').click()">+ ADD MEDIA</button>
            <input type="text" id="url-input" placeholder="Paste Direct Stream URL...">
            <button id="btn-url" style="background:none; border: 1px solid #444; color:#00d2ff; padding:8px; margin-top:10px; border-radius:5px; cursor:pointer; width:100%">LOAD URL</button>
            <div id="playlist-ui" style="display:none"><div id="playlist-list"></div></div>
            <button id="btn-start" class="btn-main" style="display:none; background: #00d2ff;">INITIALIZE CINEMA</button>
        </div>
    </div>

    <canvas id="light-canvas" width="32" height="32"></canvas>

    <a-scene background="color: #000" fog="type: exponential; color: #000; density: 0.015">
        <a-assets>
            <video id="video-src" playsinline webkit-playsinline crossorigin="anonymous"></video>
            <img id="img-src" crossorigin="anonymous">
            <img id="grid-texture" src="https://cdn.aframe.io/a-painter/images/floor.jpg">
        </a-assets>

        <a-plane id="env-floor" position="0 0 -4" rotation="-90 0 0" width="80" height="80" src="#grid-texture" repeat="40 40" color="#111" roughness="0.1" metalness="0.9"></a-plane>
        <a-light id="ambi-light" type="ambient" color="#222" intensity="0.2"></a-light>
        <a-light id="screen-glow" type="point" position="0 4 -4" distance="20" intensity="0.5"></a-light>

        <a-curvedimage id="screen-cinema" height="12" radius="14" theta-length="90" rotation="0 135 0" position="0 5 0" side="double"></a-curvedimage>
        <a-videosphere id="screen-360" radius="60" material="shader: flat; side: back; fog: false" visible="false"></a-videosphere>

        <a-entity id="hub-wrapper" position="0 0.8 -1.5" rotation="-20 0 0">
            
            <a-curvedimage src="" height="1.2" radius="2.5" theta-length="60" rotation="0 150 0" color="#050505" opacity="0.9" class="clickable"></a-curvedimage>
            <a-box position="0 0.58 0" height="0.01" width="2.5" depth="0.01" color="#00d2ff" opacity="0.8"></a-box>

            <a-entity id="tabs" position="0 0.45 0.1">
                <a-plane id="tab-remote" position="-0.6 0 0" width="0.4" height="0.15" color="#00d2ff" class="clickable tab-btn">
                    <a-text value="REMOTE" align="center" width="2" color="black" font-weight="bold"></a-text>
                </a-plane>
                <a-plane id="tab-visual" position="0 0 0" width="0.4" height="0.15" color="#222" class="clickable tab-btn">
                    <a-text value="DISPLAY" align="center" width="2" color="white"></a-text>
                </a-plane>
                <a-plane id="tab-seat" position="0.6 0 0" width="0.4" height="0.15" color="#222" class="clickable tab-btn">
                    <a-text value="COMFORT" align="center" width="2" color="white"></a-text>
                </a-plane>
            </a-entity>

            <a-entity id="page-remote" visible="true">
                <a-text id="txt-title" value="Media Ready" position="0 0.28 0.12" align="center" width="2" color="#00d2ff"></a-text>
                <a-text id="time-display" value="00:00 / 00:00" position="0 0.2 0.12" align="center" width="2.5" color="#888"></a-text>
                
                <a-plane id="progress-rail" position="0 0.12 0.12" width="2" height="0.02" color="#333" class="clickable">
                    <a-plane id="progress-fill" position="-1 0 0.01" width="2" height="0.02" color="#00d2ff" scale="0 1 1" pivot="center left"></a-plane>
                </a-plane>

                <a-entity id="remote-btns" position="0 -0.1 0.12">
                    <a-plane id="btn-prev" position="-0.8 0 0" width="0.25" height="0.2" color="#222" class="clickable btn-hover"><a-text value="|<" align="center" width="3"></a-text></a-plane>
                    <a-plane id="btn-seek-back" position="-0.5 0 0" width="0.25" height="0.2" color="#222" class="clickable btn-hover"><a-text value="-15s" align="center" width="2"></a-text></a-plane>
                    <a-plane id="btn-play" position="0 0 0" width="0.5" height="0.25" color="#00d2ff" class="clickable btn-hover"><a-text id="txt-play" value="PLAY" align="center" width="3" color="black"></a-text></a-plane>
                    <a-plane id="btn-seek-fwd" position="0.5 0 0" width="0.25" height="0.2" color="#222" class="clickable btn-hover"><a-text value="+15s" align="center" width="2"></a-text></a-plane>
                    <a-plane id="btn-next" position="0.8 0 0" width="0.25" height="0.2" color="#222" class="clickable btn-hover"><a-text value=">|" align="center" width="3"></a-text></a-plane>
                </a-entity>

                <a-entity id="volume-ctrl" position="0 -0.35 0.12">
                    <a-text value="VOLUME" position="-0.8 0 0" width="2"></a-text>
                    <a-plane id="vol-rail" position="0.1 0 0" width="1.2" height="0.04" color="#333" class="clickable">
                        <a-plane id="vol-fill" position="-0.6 0 0.01" width="1.2" height="0.04" color="#00ff88" scale="1 1 1" pivot="center left"></a-plane>
                    </a-plane>
                </a-entity>
            </a-entity>

            <a-entity id="page-visual" visible="false">
                <a-entity position="0 0.1 0.12">
                    <a-plane id="btn-mode" position="-0.6 0 0" width="0.8" height="0.2" color="#222" class="clickable btn-hover"><a-text value="2D / 360 MODE" align="center" width="2.5"></a-text></a-plane>
                    <a-plane id="btn-void" position="0.6 0 0" width="0.8" height="0.2" color="#222" class="clickable btn-hover"><a-text value="VOID MODE" align="center" width="2.5"></a-text></a-plane>
                </a-entity>
                <a-entity position="0 -0.2 0.12">
                    <a-text value="CURVATURE" position="-0.6 0.15 0" align="center" width="2" color="#888"></a-text>
                    <a-plane id="curve-less" position="-0.8 0 0" width="0.3" height="0.15" color="#333" class="clickable btn-hover"><a-text value="-" align="center"></a-text></a-plane>
                    <a-plane id="curve-more" position="-0.4 0 0" width="0.3" height="0.15" color="#333" class="clickable btn-hover"><a-text value="+" align="center"></a-text></a-plane>
                    
                    <a-text value="SPEED" position="0.6 0.15 0" align="center" width="2" color="#888"></a-text>
                    <a-plane id="btn-speed" position="0.6 0 0" width="0.4" height="0.15" color="#333" class="clickable btn-hover"><a-text id="txt-speed" value="1x" align="center"></a-text></a-plane>
                </a-entity>
            </a-entity>

            <a-entity id="page-seat" visible="false">
                <a-entity position="0 0.05 0.12">
                    <a-plane id="seat-front" position="-0.7 0.1 0" width="0.5" height="0.2" color="#222" class="clickable btn-hover"><a-text value="FRONT" align="center" width="2"></a-text></a-plane>
                    <a-plane id="seat-back" position="0 0.1 0" width="0.5" height="0.2" color="#222" class="clickable btn-hover"><a-text value="BALCONY" align="center" width="2"></a-text></a-plane>
                    <a-plane id="seat-lay" position="0.7 0.1 0" width="0.5" height="0.2" color="#222" class="clickable btn-hover"><a-text value="RECLINE" align="center" width="2"></a-text></a-plane>
                    <a-plane id="btn-reset" position="0 -0.2 0" width="1.2" height="0.2" color="#e50914" class="clickable btn-hover"><a-text value="RESET SENSORS / CENTER" align="center" width="3"></a-text></a-plane>
                </a-entity>
            </a-entity>

        </a-entity>

        <a-entity id="rig" position="0 1.6 0">
            <a-camera look-controls="reverseMouseDrag: true">
                <a-cursor id="cursor" fuse="true" fuse-timeout="1200" color="#00d2ff" raycaster="objects: .clickable"></a-cursor>
            </a-camera>
        </a-entity>
    </a-scene>

    <script>
        const video = document.getElementById('video-src');
        const img = document.getElementById('img-src');
        const screenCinema = document.getElementById('screen-cinema');
        const screen360 = document.getElementById('screen-360');
        const rig = document.getElementById('rig');
        const floor = document.getElementById('env-floor');
        const scene = document.querySelector('a-scene');

        let playlist = [];
        let currentTrack = 0;
        let is360 = false;
        let isVoid = false;
        let currentCurve = 90;
        let audioCtx, gainNode, panner;
        let hubTimer;

        /* --- 1. MEDIA SYSTEM --- */
        document.getElementById('file-input').addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            playlist = playlist.concat(files.map(f => ({ type: f.type.startsWith('image/') ? 'image' : 'video', src: f, name: f.name })));
            renderPlaylist();
        });

        document.getElementById('btn-url').addEventListener('click', () => {
            const url = document.getElementById('url-input').value.trim();
            if(url) {
                playlist.push({ type: url.match(/\.(jpg|png|jpeg)$/) ? 'image' : 'video', src: url, name: "Web Content" });
                renderPlaylist();
            }
        });

        function renderPlaylist() {
            const list = document.getElementById('playlist-list');
            document.getElementById('playlist-ui').style.display = 'block';
            document.getElementById('btn-start').style.display = 'block';
            list.innerHTML = playlist.map((item, i) => `<div style="padding:4px; border-bottom:1px solid #222">${i+1}. ${item.name}</div>`).join('');
        }

        document.getElementById('btn-start').addEventListener('click', () => {
            document.getElementById('ui-layer').classList.add('hidden');
            loadTrack(0);
        });

        function loadTrack(index) {
            if (index < 0 || index >= playlist.length) return;
            currentTrack = index;
            const item = playlist[currentTrack];
            const src = item.src instanceof File ? URL.createObjectURL(item.src) : item.src;

            document.getElementById('txt-title').setAttribute('value', item.name.substring(0,25));

            if (item.type === 'image') {
                video.pause();
                img.onload = () => {
                    screenCinema.setAttribute('src', '#img-src');
                    screen360.setAttribute('src', '#img-src');
                    const mesh = screenCinema.getObject3D('mesh');
                    if (mesh) mesh.material.map.needsUpdate = true;
                    drawAmbilight(img);
                };
                img.src = src;
                document.getElementById('video-controls').setAttribute('visible', false);
            } else {
                video.src = src;
                screenCinema.setAttribute('src', '#video-src');
                screen360.setAttribute('src', '#video-src');
                document.getElementById('video-controls').setAttribute('visible', true);
                initAudio();
                video.play().then(() => {
                    document.getElementById('txt-play').setAttribute('value', 'PAUSE');
                    requestAnimationFrame(updateAmbilight);
                });
            }
        }

        /* --- 2. HUB 2.0 TAB LOGIC --- */
        const pages = ['page-remote', 'page-visual', 'page-seat'];
        const tabs = ['tab-remote', 'tab-visual', 'tab-seat'];

        tabs.forEach((tabId, i) => {
            document.getElementById(tabId).addEventListener('click', () => {
                pages.forEach((p, idx) => {
                    document.getElementById(p).setAttribute('visible', idx === i);
                    document.getElementById(tabs[idx]).setAttribute('color', idx === i ? '#00d2ff' : '#222');
                    document.querySelector(`#${tabs[idx]} a-text`).setAttribute('color', idx === i ? 'black' : 'white');
                });
            });
        });

        /* --- 3. CONTROLS --- */
        document.getElementById('btn-play').addEventListener('click', () => {
            if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
            if(video.paused) { video.play(); document.getElementById('txt-play').setAttribute('value', 'PAUSE'); }
            else { video.pause(); document.getElementById('txt-play').setAttribute('value', 'PLAY'); }
        });

        document.getElementById('btn-next').addEventListener('click', () => loadTrack(currentTrack + 1));
        document.getElementById('btn-prev').addEventListener('click', () => loadTrack(currentTrack - 1));

        document.getElementById('vol-rail').addEventListener('click', (e) => {
            const vol = (e.detail.intersection.point.x + 0.5) / 1.2; // Simple rail math
            const clamped = Math.min(Math.max(vol, 0), 1);
            if(gainNode) gainNode.gain.value = clamped * 3;
            document.getElementById('vol-fill').setAttribute('scale', `${clamped} 1 1`);
        });

        document.getElementById('btn-mode').addEventListener('click', () => {
            is360 = !is360;
            screenCinema.setAttribute('visible', !is360);
            screen360.setAttribute('visible', is360);
            floor.setAttribute('visible', !is360);
            if(is360) scene.removeAttribute('fog');
            else scene.setAttribute('fog', 'type: exponential; color: #000; density: 0.015');
        });

        document.getElementById('btn-void').addEventListener('click', () => {
            isVoid = !isVoid;
            if(!is360) floor.setAttribute('visible', !isVoid);
            scene.setAttribute('background', isVoid ? 'color: #000' : 'color: #050505');
        });

        document.getElementById('btn-reset').addEventListener('click', () => {
            const cam = rig.querySelector('a-camera').object3D;
            rig.setAttribute('rotation', `0 ${-cam.rotation.y * (180/Math.PI)} 0`);
        });

        /* --- 4. SCREEN GEOMETRY --- */
        function updateScreen() {
            screenCinema.setAttribute('theta-length', currentCurve);
            screenCinema.setAttribute('rotation', `0 ${180 - (currentCurve / 2)} 0`);
        }
        document.getElementById('curve-more').addEventListener('click', () => { currentCurve = Math.min(160, currentCurve+10); updateScreen(); });
        document.getElementById('curve-less').addEventListener('click', () => { currentCurve = Math.max(30, currentCurve-10); updateScreen(); });

        /* --- 5. SEATING --- */
        const moveRig = (p) => rig.setAttribute('position', p);
        document.getElementById('seat-front').addEventListener('click', () => moveRig("0 1.6 -1"));
        document.getElementById('seat-back').addEventListener('click', () => moveRig("0 2.5 2"));
        document.getElementById('seat-lay').addEventListener('click', () => moveRig("0 0.5 0"));

        /* --- 6. AUDIO & VISUAL LOOPS --- */
        function initAudio() {
            if(audioCtx) return;
            const AC = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AC();
            const src = audioCtx.createMediaElementSource(video);
            gainNode = audioCtx.createGain();
            gainNode.gain.value = 3.0;
            panner = audioCtx.createPanner();
            panner.panningModel = 'HRTF';
            panner.setPosition(0, 4.5, -5);
            src.connect(gainNode).connect(panner).connect(audioCtx.destination);
        }

        setInterval(() => {
            if(video.duration) {
                const pct = video.currentTime / video.duration;
                document.getElementById('progress-fill').setAttribute('scale', `${pct} 1 1`);
                document.getElementById('time-display').setAttribute('value', `${fmt(video.currentTime)} / ${fmt(video.duration)}`);
            }
        }, 500);

        function fmt(s) { const m = Math.floor(s/60); const sec = Math.floor(s%60); return `${m}:${sec<10?'0'+sec:sec}`; }

        const drawAmbilight = (source) => {
            const ctx = document.getElementById('light-canvas').getContext('2d');
            ctx.drawImage(source, 0, 0, 32, 32);
            const p = ctx.getImageData(16,16,1,1).data;
            const hex = "#" + ((1<<24)+(p[0]<<16)+(p[1]<<8)+p[2]).toString(16).slice(1);
            if(!isVoid && !is360) document.getElementById('ambi-light').setAttribute('color', hex);
            document.getElementById('screen-glow').setAttribute('color', hex);
        };

        function updateAmbilight() { if(!video.paused) { drawAmbilight(video); requestAnimationFrame(updateAmbilight); } }
    </script>
</body>
</html>
