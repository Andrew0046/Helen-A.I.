<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hub v3.0: Cockpit Edition</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <style>
        /* --- 2D DASHBOARD (INITIAL UI) --- */
        body { margin: 0; overflow: hidden; background: #050505; font-family: 'Segoe UI', Roboto, sans-serif; color: white; }
        
        #ui-layer {
            position: absolute; z-index: 9999; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .hidden { opacity: 0; pointer-events: none; }

        h1 { font-weight: 200; letter-spacing: 8px; text-transform: uppercase; margin-bottom: 30px; }
        h1 span { font-weight: 700; color: #00d2ff; text-shadow: 0 0 20px rgba(0, 210, 255, 0.5); }

        .hub-card {
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px); padding: 40px; border-radius: 16px; width: 450px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        .btn-main {
            background: linear-gradient(135deg, #00d2ff 0%, #0078ff 100%); border: none; padding: 15px 30px;
            color: white; font-weight: bold; font-size: 16px; letter-spacing: 1px; border-radius: 30px;
            cursor: pointer; margin-top: 20px; width: 100%; transition: transform 0.2s;
        }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0, 120, 255, 0.4); }

        .url-box { margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; display: flex; gap: 10px; }
        input[type="text"] { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid #333; padding: 10px; color: white; border-radius: 4px; }
        .btn-small { background: #333; border: 1px solid #444; color: #aaa; padding: 0 15px; border-radius: 4px; cursor: pointer; }

        #playlist-ui {
            margin-top: 20px; max-height: 150px; overflow-y: auto; text-align: left;
            background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; font-size: 0.9rem; color: #aaa;
        }
        .playlist-item { padding: 5px; border-bottom: 1px solid #333; cursor: pointer; }
        .playlist-item:hover { color: white; background: rgba(255,255,255,0.1); }
        .playlist-active { color: #ff9d00; font-weight: bold; }

        /* Drag Overlay */
        #drop-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 210, 255, 0.2); border: 5px dashed #00d2ff;
            z-index: 10000; display: none; align-items: center; justify-content: center;
            font-size: 2rem; font-weight: bold; text-transform: uppercase; pointer-events: none;
        }
        
        #light-canvas { display: none; }
    </style>
</head>
<body>

    <div id="drop-overlay">Drop File to Play</div>

    <div id="ui-layer">
        <h1>The <span style="color: #ff9d00">Hub</span> <span style="font-size: 0.5em; vertical-align: super; color: #666">v3.0</span></h1>
        <div class="hub-card">
            <h3 style="margin: 0 0 10px; font-weight: 400;">Initialize System</h3>
            <p style="color: #888; font-size: 0.9rem;">Select media or drag & drop files</p>
            
            <input type="file" id="file-input" accept="video/*, image/*" multiple style="display:none">
            <button class="btn-main" onclick="document.getElementById('file-input').click()">LOAD FILES</button>
            
            <div class="url-box">
                <input type="text" id="url-input" placeholder="Paste stream URL...">
                <button class="btn-small" id="btn-url">GO</button>
            </div>

            <div id="playlist-ui" style="display:none">
                <div style="color:white; font-weight:bold; margin-bottom:5px;">Queue:</div>
                <div id="playlist-list"></div>
            </div>
            
            <button id="btn-start" class="btn-main" style="display:none; background: #ff9d00; margin-top: 20px;">ENTER VR</button>
        </div>
    </div>

    <canvas id="light-canvas" width="32" height="32"></canvas>

    <a-scene background="color: #000" fog="type: exponential; color: #000; density: 0.015">
        
        <a-assets>
            <video id="video-src" src="" playsinline webkit-playsinline loop="false" crossorigin="anonymous"></video>
            <img id="img-src" src="" crossorigin="anonymous">
            <img id="grid-texture" src="https://cdn.aframe.io/a-painter/images/floor.jpg">
        </a-assets>

        <a-plane id="env-floor" position="0 0 -4" rotation="-90 0 0" width="80" height="80" 
                 src="#grid-texture" repeat="40 40" color="#1a1a1a" roughness="0.2" metalness="0.8">
        </a-plane>
        <a-sky color="#050505"></a-sky>

        <a-light id="ambi-light" type="ambient" color="#222" intensity="0.2"></a-light>
        <a-light id="screen-glow" type="point" position="0 4 -4" distance="20" decay="2" intensity="0.5" color="#fff"></a-light>

        <a-curvedimage id="screen-cinema" src="#video-src" 
            height="12" radius="14" theta-length="90" 
            rotation="0 135 0" position="0 5 0" 
            side="double" visible="true">
        </a-curvedimage>

        <a-videosphere id="screen-360" src="#video-src" 
            radius="60" rotation="0 -90 0" 
            material="shader: flat; side: back; fog: false" 
            visible="false">
        </a-videosphere>


        <a-entity position="0 -0.8 -1.2">
            <a-sphere id="menu-orb" radius="0.15" color="#00d2ff" material="emissive: #0078ff; emissiveIntensity: 0.5"
                      class="clickable btn-hover"
                      animation__hover="property: scale; to: 1.2 1.2 1.2; dur: 200; startEvents: mouseenter"
                      animation__leave="property: scale; to: 1 1 1; dur: 200; startEvents: mouseleave"
                      animation__pulse="property: material.emissiveIntensity; from: 0.2; to: 0.8; dur: 2000; dir: alternate; loop: true">
            </a-sphere>
            <a-text value="MENU" position="0 -0.25 0" align="center" width="2" color="#aaa"></a-text>
        </a-entity>


        <a-entity id="hub-wrapper" position="0 -0.4 -1.5" rotation="-20 0 0" visible="true">

            <a-entity position="0 0 0">
                <a-box width="1.6" height="0.5" depth="0.05" color="#0a0a0a" opacity="0.9" 
                       material="roughness: 0.2; metalness: 0.8"
                       class="clickable"
                       animation__hover="property: position; to: 0 0.05 0; dur: 200; startEvents: mouseenter"
                       animation__leave="property: position; to: 0 0 0; dur: 200; startEvents: mouseleave">
                </a-box>
                
                <a-text id="txt-title" value="Waiting..." position="-0.7 0.22 0.04" align="left" width="2" color="white"></a-text>
                <a-text id="time-display" value="00:00" position="0.6 0.22 0.04" align="right" width="2" color="#00d2ff"></a-text>

                <a-box id="bar-bg" position="0 0.15 0.03" width="1.4" height="0.03" depth="0.01" color="#333" class="clickable"></a-box>
                <a-box id="progress-fill" position="-0.7 0.15 0.04" width="1.4" height="0.03" depth="0.01" color="#00d2ff" scale="0 1 1" pivot="center left"></a-box>

                <a-circle id="btn-play" position="0 -0.05 0.04" radius="0.12" color="#00d2ff" class="clickable btn-hover"
                        animation__scale="property: scale; to: 1.1 1.1 1; startEvents: mouseenter; dur: 150"
                        animation__reset="property: scale; to: 1 1 1; startEvents: mouseleave; dur: 150">
                    <a-text id="txt-play" value=">" align="center" position="0.01 -0.01 0" width="8" color="#000"></a-text>
                </a-circle>

                <a-plane id="btn-seek-back" position="-0.4 -0.05 0.04" width="0.3" height="0.15" color="#222" class="clickable btn-hover" opacity="0.8">
                    <a-text value="<<" align="center" width="6"></a-text>
                    <a-text value="-15s" position="0 -0.06 0" align="center" width="2" color="#aaa"></a-text>
                </a-plane>
                <a-plane id="btn-seek-fwd" position="0.4 -0.05 0.04" width="0.3" height="0.15" color="#222" class="clickable btn-hover" opacity="0.8">
                    <a-text value=">>" align="center" width="6"></a-text>
                    <a-text value="+15s" position="0 -0.06 0" align="center" width="2" color="#aaa"></a-text>
                </a-plane>
                
                <a-plane id="btn-speed" position="0 -0.3 0.04" width="0.4" height="0.08" color="#222" class="clickable btn-hover">
                     <a-text id="txt-speed" value="SPEED: 1x" align="center" width="2" color="#666"></a-text>
                </a-plane>
            </a-entity>

            <a-entity position="-1.2 0 0.2" rotation="0 25 0">
                <a-box width="0.8" height="0.5" depth="0.05" color="#111" opacity="0.8"></a-box>
                <a-text value="SYSTEM" position="0 0.18 0.04" align="center" width="2" color="#666"></a-text>

                <a-plane id="btn-mode" position="-0.2 0.05 0.04" width="0.3" height="0.12" color="#222" class="clickable btn-hover">
                     <a-text value="360" align="center" width="3"></a-text>
                </a-plane>
                <a-plane id="btn-void" position="0.2 0.05 0.04" width="0.3" height="0.12" color="#222" class="clickable btn-hover">
                     <a-text value="VOID" align="center" width="3"></a-text>
                </a-plane>

                <a-plane id="btn-prev" position="-0.2 -0.1 0.04" width="0.3" height="0.12" color="#333" class="clickable btn-hover">
                     <a-text value="|<<" align="center" width="4"></a-text>
                </a-plane>
                <a-plane id="btn-next" position="0.2 -0.1 0.04" width="0.3" height="0.12" color="#333" class="clickable btn-hover">
                     <a-text value=">>|" align="center" width="4"></a-text>
                </a-plane>
            </a-entity>

            <a-entity position="1.2 0 0.2" rotation="0 -25 0">
                <a-box width="0.8" height="0.5" depth="0.05" color="#111" opacity="0.8"></a-box>
                <a-text value="COMFORT" position="0 0.18 0.04" align="center" width="2" color="#666"></a-text>

                <a-plane id="btn-reset" position="0 0.05 0.04" width="0.7" height="0.12" color="#222" class="clickable btn-hover">
                    <a-text value="RESET VIEW" align="center" width="3"></a-text>
                </a-plane>

                <a-plane id="seat-front" position="-0.25 -0.1 0.04" width="0.2" height="0.12" color="#333" class="clickable btn-hover">
                    <a-text value="CLOSE" align="center" width="1.8"></a-text>
                </a-plane>
                <a-plane id="seat-back" position="0 -0.1 0.04" width="0.2" height="0.12" color="#333" class="clickable btn-hover">
                    <a-text value="FAR" align="center" width="1.8"></a-text>
                </a-plane>
                <a-plane id="seat-lay" position="0.25 -0.1 0.04" width="0.2" height="0.12" color="#333" class="clickable btn-hover">
                    <a-text value="BED" align="center" width="1.8"></a-text>
                </a-plane>
                
                <a-entity id="curve-more" visible="false"></a-entity>
                <a-entity id="curve-less" visible="false"></a-entity>
            </a-entity>

        </a-entity>

        <a-entity id="rig" position="0 1.6 0">
            <a-camera look-controls="reverseMouseDrag: true" wasd-controls="enabled: false">
                <a-cursor id="cursor" fuse="true" fuse-timeout="1200" color="#ff9d00" raycaster="objects: .clickable"
                    animation__click="property: scale; startEvents: click; from: 0.1 0.1 0.1; to: 1 1 1; dur: 150"
                    animation__fusing="property: scale; startEvents: fusing; from: 1 1 1; to: 0.1 0.1 0.1; dur: 1200">
                </a-cursor>
            </a-camera>
        </a-entity>

    </a-scene>

    <script>
        /* --- CONFIG & STATE --- */
        const video = document.getElementById('video-src');
        const img = document.getElementById('img-src');
        const uiLayer = document.getElementById('ui-layer');
        const fileInput = document.getElementById('file-input');
        const urlInput = document.getElementById('url-input');
        const playlistUI = document.getElementById('playlist-ui');
        const playlistList = document.getElementById('playlist-list');
        const btnStart = document.getElementById('btn-start');
        
        const screenCinema = document.getElementById('screen-cinema');
        const screen360 = document.getElementById('screen-360');
        const rig = document.getElementById('rig');
        const hubWrapper = document.getElementById('hub-wrapper');
        const floor = document.getElementById('env-floor');
        const scene = document.querySelector('a-scene');

        const playBtnText = document.getElementById('txt-play');
        const timeText = document.getElementById('time-display');
        const progressFill = document.getElementById('progress-fill');
        const titleText = document.getElementById('txt-title');
        
        let playlist = []; 
        let currentTrack = 0;
        let is360 = false;
        let isVoid = false;
        let currentCurve = 90; 
        
        // Audio & Memory State
        let audioCtx, panner, audioSourceNode;
        let currentObjectURL = null; 
        let hubTimer;

        /* --- 1. ORB & MENU LOGIC (NEW) --- */
        const menuOrb = document.getElementById('menu-orb');
        
        menuOrb.addEventListener('click', () => {
            const isVis = hubWrapper.getAttribute('visible');
            hubWrapper.setAttribute('visible', !isVis);
            // Visual feedback on Orb
            menuOrb.setAttribute('color', !isVis ? '#00d2ff' : '#444');
        });

        // Hide dashboard on video play, but allow Orb to bring it back
        function autoHideDashboard() {
            setTimeout(() => {
                if(!video.paused) {
                    hubWrapper.setAttribute('visible', false);
                    menuOrb.setAttribute('color', '#444'); 
                }
            }, 3000);
        }

        /* --- 2. PLAYLIST & FILE HANDLING --- */
        
        function handleFiles(files) {
            if (files.length > 0) {
                const newItems = Array.from(files).map(f => {
                    const isImage = f.type.startsWith('image/');
                    return { type: isImage ? 'image' : 'video', src: f, name: f.name };
                });
                playlist = playlist.concat(newItems);
                updatePlaylistUI();
            }
        }

        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        // Drag & Drop
        const dropOverlay = document.getElementById('drop-overlay');
        document.body.addEventListener('dragover', (e) => { e.preventDefault(); dropOverlay.style.display = 'flex'; });
        document.body.addEventListener('dragleave', (e) => { e.preventDefault(); dropOverlay.style.display = 'none'; });
        document.body.addEventListener('drop', (e) => {
            e.preventDefault();
            dropOverlay.style.display = 'none';
            handleFiles(e.dataTransfer.files);
        });

        document.getElementById('btn-url').addEventListener('click', () => {
            const url = urlInput.value.trim();
            if(url) {
                const isImage = url.match(/\.(jpeg|jpg|gif|png)$/) != null;
                playlist.push({ type: isImage ? 'image' : 'video', src: url, name: "Web Stream" });
                urlInput.value = ""; 
                updatePlaylistUI();
            }
        });

        function updatePlaylistUI() {
            playlistUI.style.display = 'block';
            btnStart.style.display = 'block';
            playlistList.innerHTML = '';
            playlist.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'playlist-item';
                if(index === currentTrack && uiLayer.classList.contains('hidden')) div.classList.add('playlist-active');
                div.innerText = `${index + 1}. [${item.type.toUpperCase()}] ${item.name}`;
                div.onclick = () => { currentTrack = index; highlightActive(); }
                playlistList.appendChild(div);
            });
        }
        
        function highlightActive() {
             Array.from(playlistList.children).forEach((child, i) => {
                 child.classList.toggle('playlist-active', i === currentTrack);
             });
        }

        btnStart.addEventListener('click', () => {
            if(playlist.length > 0) {
                uiLayer.classList.add('hidden');
                loadTrack(currentTrack);
            }
        });

        function loadTrack(index) {
            if (index >= 0 && index < playlist.length) {
                
                // Memory Cleanup
                if (currentObjectURL) {
                    URL.revokeObjectURL(currentObjectURL);
                    currentObjectURL = null;
                }

                currentTrack = index;
                const item = playlist[currentTrack];
                
                let src = "";
                if(item.src instanceof File) {
                    src = URL.createObjectURL(item.src);
                    currentObjectURL = src; 
                } else {
                    src = item.src;
                }

                let displayName = item.name;
                if(displayName.length > 30) displayName = displayName.substring(0, 27) + "...";
                titleText.setAttribute('value', displayName);

                if (item.type === 'image') {
                    video.pause();
                    hubWrapper.setAttribute('visible', true);
                    
                    screenCinema.setAttribute('src', '');
                    screen360.setAttribute('src', '');

                    img.onload = function() {
                        screenCinema.setAttribute('src', '#img-src');
                        screen360.setAttribute('src', '#img-src');
                        const mesh = screenCinema.getObject3D('mesh');
                        if (mesh && mesh.material.map) mesh.material.map.needsUpdate = true;
                        drawAmbilight(img);
                    };
                    img.src = src;

                } else {
                    video.src = src;
                    screenCinema.setAttribute('src', '#video-src');
                    screen360.setAttribute('src', '#video-src');

                    initAudio();
                    
                    video.play().then(() => {
                        playBtnText.setAttribute('value', '||'); // Pause Icon
                        autoHideDashboard();
                    }).catch(e => {
                        playBtnText.setAttribute('value', '>'); // Play Icon
                    });
                    
                    requestAnimationFrame(updateAmbilight);
                }
            }
        }

        video.addEventListener('ended', () => {
            if (currentTrack < playlist.length - 1) loadTrack(currentTrack + 1);
            hubWrapper.setAttribute('visible', true);
        });


        /* --- 3. VR INTERACTIONS --- */
        function flash(el) {
            if(!el) return;
            const oldColor = el.getAttribute('color');
            el.setAttribute('color', '#fff');
            setTimeout(() => el.setAttribute('color', oldColor), 150);
        }

        document.getElementById('btn-play').addEventListener('click', function() {
            togglePlay();
            flash(this);
        });

        function togglePlay() {
            if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
            if(video.paused) { 
                video.play(); 
                playBtnText.setAttribute('value', '||'); 
                autoHideDashboard();
            } else { 
                video.pause(); 
                playBtnText.setAttribute('value', '>'); 
            }
        }

        document.getElementById('btn-prev').addEventListener('click', function() {
            if(currentTrack > 0) loadTrack(currentTrack - 1); flash(this);
        });
        document.getElementById('btn-next').addEventListener('click', function() {
            if(currentTrack < playlist.length - 1) loadTrack(currentTrack + 1); flash(this);
        });

        document.getElementById('btn-seek-back').addEventListener('click', function() {
            video.currentTime = Math.max(0, video.currentTime - 15); flash(this);
        });
        document.getElementById('btn-seek-fwd').addEventListener('click', function() {
            video.currentTime = Math.min(video.duration, video.currentTime + 15); flash(this);
        });

        document.getElementById('btn-mode').addEventListener('click', function() {
            is360 = !is360;
            screenCinema.setAttribute('visible', !is360);
            screen360.setAttribute('visible', is360);
            floor.setAttribute('visible', !is360);
            if(is360) scene.removeAttribute('fog');
            else if(!isVoid) scene.setAttribute('fog', 'type: exponential; color: #000; density: 0.015');
            flash(this);
        });

        document.getElementById('btn-void').addEventListener('click', function() {
            isVoid = !isVoid;
            if(!is360) floor.setAttribute('visible', !isVoid);
            if(isVoid) scene.removeAttribute('fog'); 
            else scene.setAttribute('fog', 'type: exponential; color: #000; density: 0.015');
            flash(this);
        });

        document.getElementById('btn-reset').addEventListener('click', function() {
            const cam = document.querySelector('[camera]').object3D;
            const yRot = cam.rotation.y * (180 / Math.PI);
            rig.setAttribute('rotation', {x:0, y: -yRot, z:0});
            flash(this);
        });

        document.getElementById('btn-speed').addEventListener('click', function() {
            const speeds = [1, 1.25, 1.5, 2, 0.5, 0.75];
            video.playbackRate = speeds[(speeds.indexOf(video.playbackRate) + 1) % speeds.length];
            document.getElementById('txt-speed').setAttribute('value', `SPEED: ${video.playbackRate}x`);
            flash(this);
        });


        /* --- 4. KEYBOARD SHORTCUTS --- */
        window.addEventListener('keydown', (e) => {
            if(uiLayer.classList.contains('hidden')) {
                switch(e.code) {
                    case 'Space': 
                        e.preventDefault(); togglePlay(); flash(document.getElementById('btn-play')); break;
                    case 'ArrowRight': 
                        video.currentTime = Math.min(video.duration, video.currentTime + 15); flash(document.getElementById('btn-seek-fwd')); break;
                    case 'ArrowLeft': 
                        video.currentTime = Math.max(0, video.currentTime - 15); flash(document.getElementById('btn-seek-back')); break;
                    case 'KeyR': document.getElementById('btn-reset').click(); break;
                }
            }
        });


        /* --- 5. SEATING & SCREEN --- */
        const seats = {
            front: { pos: "0 1.6 -1", rot: "-20 0 0" },
            back: { pos: "0 2.5 2", rot: "-20 0 0" },
            recline: { pos: "0 0.5 0", rot: "-45 0 0" }
        };
        
        document.getElementById('seat-front').addEventListener('click', function() {
            rig.setAttribute('position', seats.front.pos);
            hubWrapper.setAttribute('rotation', seats.front.rot); flash(this);
        });
        document.getElementById('seat-back').addEventListener('click', function() {
            rig.setAttribute('position', seats.back.pos);
            hubWrapper.setAttribute('rotation', seats.back.rot); flash(this);
        });
        document.getElementById('seat-lay').addEventListener('click', function() {
            rig.setAttribute('position', seats.recline.pos);
            hubWrapper.setAttribute('rotation', seats.recline.rot); flash(this);
        });


        /* --- 6. LOOPS & UI --- */
        setInterval(() => {
            if(video.duration) {
                const pct = video.currentTime / video.duration;
                progressFill.object3D.scale.x = pct;
                progressFill.object3D.position.x = -0.7 + (1.4 * pct / 2); // Corrected for new size
                
                const cur = fmt(video.currentTime);
                timeText.setAttribute('value', cur);
            }
        }, 500);

        function fmt(s) {
            const m = Math.floor(s/60);
            const sec = Math.floor(s%60);
            return `${m}:${sec<10?'0'+sec:sec}`;
        }

        // Gaze Hover
        document.querySelectorAll('.clickable').forEach(el => {
            el.addEventListener('mouseenter', () => {
                if(el.classList.contains('btn-hover')) el.setAttribute('color', '#ff9d00');
            });
            el.addEventListener('mouseleave', () => {
                if(el.classList.contains('btn-hover')) el.setAttribute('color', '#222');
                if(el.id === 'btn-play') el.setAttribute('color', '#00d2ff');
                if(el.id === 'menu-orb') el.setAttribute('color', '#00d2ff');
            });
        });


        /* --- 7. AUDIO & VISUALS --- */
        function initAudio() {
            if(!audioCtx) {
                const AC = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AC();
            }
            if (!audioSourceNode) {
                audioSourceNode = audioCtx.createMediaElementSource(video);
                const gainNode = audioCtx.createGain();
                gainNode.gain.value = 3.0;
                
                panner = audioCtx.createPanner();
                panner.panningModel = 'HRTF';
                panner.distanceModel = 'inverse';
                panner.refDistance = 10; 
                panner.maxDistance = 10000;
                panner.setPosition(0, 4.5, -5);
                
                audioSourceNode.connect(gainNode);
                gainNode.connect(panner);
                panner.connect(audioCtx.destination);
            }
            if(audioCtx.state === 'suspended') audioCtx.resume();
        }

        const ctx = document.getElementById('light-canvas').getContext('2d');
        const ambi = document.getElementById('ambi-light');
        const glow = document.getElementById('screen-glow');

        function updateAmbilight() {
            if(!video.paused && !video.ended) {
                drawAmbilight(video);
                requestAnimationFrame(updateAmbilight);
            }
        }
        
        function drawAmbilight(source) {
            try {
                ctx.drawImage(source, 0, 0, 32, 32);
                const p = ctx.getImageData(16,16,1,1).data;
                const hex = "#" + ((1<<24)+(p[0]<<16)+(p[1]<<8)+p[2]).toString(16).slice(1);
                if(!isVoid && !is360) ambi.setAttribute('color', hex);
                glow.setAttribute('color', hex);
            } catch(e) { }
        }

    </script>
</body>
</html>
