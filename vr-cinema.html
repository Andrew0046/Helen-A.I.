<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Hub 2.0: Summon Edition</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <style>
        /* --- 2D DASHBOARD --- */
        body { margin: 0; background: #000; font-family: 'Segoe UI', sans-serif; color: white; }
        #ui-layer {
            position: absolute; z-index: 999; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #1a1a1a 0%, #000 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .hidden { display: none !important; }

        .hub-card {
            background: rgba(20, 20, 20, 0.8); border: 1px solid rgba(0, 210, 255, 0.3);
            backdrop-filter: blur(20px); padding: 50px; border-radius: 24px; width: 500px; text-align: center;
            box-shadow: 0 0 80px rgba(0, 210, 255, 0.1);
        }
        h1 { margin: 0 0 30px; letter-spacing: 6px; font-weight: 200; color: #fff; }
        h1 span { color: #00d2ff; font-weight: 700; text-shadow: 0 0 15px rgba(0, 210, 255, 0.8); }

        .btn-neon {
            background: linear-gradient(90deg, #00d2ff 0%, #0078ff 100%); border: none; padding: 18px 40px;
            color: #000; font-weight: 800; font-size: 14px; letter-spacing: 2px; border-radius: 50px;
            cursor: pointer; margin-top: 30px; width: 100%; transition: 0.3s;
        }
        .btn-neon:hover { transform: scale(1.02); box-shadow: 0 0 30px rgba(0, 120, 255, 0.6); }

        #playlist-preview { margin-top: 20px; text-align: left; font-size: 0.85rem; color: #666; max-height: 100px; overflow-y: auto; }
        #light-canvas { display: none; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="hub-card">
            <h1>HUB <span>2.0</span></h1>
            <p style="color: #888;">SUMMON SYSTEM READY</p>
            <input type="file" id="file-input" accept="video/*, image/*" multiple style="display:none">
            <button class="btn-neon" onclick="document.getElementById('file-input').click()">LOAD MEDIA</button>
            <div id="playlist-preview"></div>
            <button id="btn-start" class="btn-neon" style="display:none; background: white; color: black;">ENTER VR</button>
        </div>
    </div>

    <canvas id="light-canvas" width="32" height="32"></canvas>

    <a-scene background="color: #000" fog="type: exponential; color: #000; density: 0.015">
        <a-assets>
            <video id="video-src" playsinline webkit-playsinline loop="false" crossorigin="anonymous"></video>
            <img id="img-src" crossorigin="anonymous">
            <img id="grid-texture" src="https://cdn.aframe.io/a-painter/images/floor.jpg">
        </a-assets>

        <a-plane id="env-floor" position="0 0 -4" rotation="-90 0 0" width="100" height="100" 
                 src="#grid-texture" repeat="50 50" color="#111" roughness="0.2" metalness="0.8"></a-plane>
        <a-light id="ambi-light" type="ambient" color="#222" intensity="0.2"></a-light>
        <a-light id="screen-glow" type="point" position="0 5 -5" distance="30" decay="2" intensity="0.5" color="#fff"></a-light>

        <a-curvedimage id="screen-cinema" src="#video-src" height="12" radius="14" theta-length="90" rotation="0 135 0" position="0 5 0" side="double" visible="true"></a-curvedimage>
        <a-videosphere id="screen-360" src="#video-src" radius="60" rotation="0 -90 0" material="shader: flat; side: back; fog: false" visible="false"></a-videosphere>

        <a-entity id="summon-orb-wrapper" position="0 0.5 -1.2" visible="true">
            <a-sphere id="summon-orb" radius="0.08" color="#333" opacity="0.8" class="clickable-long">
                <a-sphere radius="0.04" color="#00d2ff" opacity="0.5"></a-sphere>
            </a-sphere>
            
            <a-ring id="summon-ring" radius-inner="0.1" radius-outer="0.11" color="#00d2ff" 
                    theta-length="0" rotation="-90 0 0" opacity="0.8"></a-ring>
            
            <a-text value="MENU" position="0 -0.15 0" align="center" width="2" color="#666"></a-text>
        </a-entity>


        <a-entity id="hub-wrapper" position="0 0.9 -1.6" rotation="-20 0 0" visible="false" scale="0.1 0.1 0.1">
            
            <a-entity id="panel-center" position="0 0 0">
                <a-box width="1.4" height="0.6" depth="0.02" color="#050505" opacity="0.95" class="clickable"></a-box>
                <a-box width="1.4" height="0.01" depth="0.03" position="0 0.3 0" color="#00d2ff" opacity="0.8"></a-box>

                <a-text id="txt-title" value="Ready" position="0 0.22 0.02" align="center" width="2" color="#00d2ff"></a-text>
                <a-text id="time-display" value="00:00 / 00:00" position="0 0.16 0.02" align="center" width="1.8" color="#666"></a-text>

                <a-plane position="0 0.12 0.02" width="1.2" height="0.01" color="#222"></a-plane>
                <a-plane id="progress-fill" position="-0.6 0.12 0.025" width="1.2" height="0.01" color="#00d2ff" scale="0 1 1" pivot="center left"></a-plane>

                <a-plane id="btn-seek-back" position="-0.4 0 0.02" width="0.2" height="0.12" color="#111" class="clickable btn-hover"><a-text value="-15s" align="center" width="1.5"></a-text></a-plane>
                <a-plane id="btn-play" position="0 0 0.02" width="0.5" height="0.15" color="#00d2ff" class="clickable btn-hover"><a-text id="txt-play" value="PLAY" align="center" width="3" color="black" font-weight="bold"></a-text></a-plane>
                <a-plane id="btn-seek-fwd" position="0.4 0 0.02" width="0.2" height="0.12" color="#111" class="clickable btn-hover"><a-text value="+15s" align="center" width="1.5"></a-text></a-plane>

                <a-plane id="btn-vol" position="0 -0.18 0.02" width="0.8" height="0.03" color="#222" class="clickable btn-hover">
                     <a-plane id="vol-fill" position="-0.4 0 0.01" width="0.8" height="0.03" color="#00ff00" scale="0.5 1 1" pivot="center left"></a-plane>
                </a-plane>
                
                <a-circle id="btn-close" position="0 -0.35 0.02" radius="0.06" color="#333" class="clickable btn-hover">
                    <a-text value="X" align="center" color="#aaa" width="3"></a-text>
                </a-circle>
            </a-entity>

            <a-entity id="panel-left" position="-1.05 0 0.2" rotation="0 25 0">
                <a-box width="0.6" height="0.5" depth="0.02" color="#080808" opacity="0.9" class="clickable"></a-box>
                <a-text value="LIBRARY" position="0 0.2 0.02" align="center" width="2" color="#666"></a-text>
                <a-plane id="btn-prev" position="-0.15 0 0.02" width="0.2" height="0.12" color="#1a1a1a" class="clickable btn-hover"><a-text value="|<<" align="center" width="2"></a-text></a-plane>
                <a-plane id="btn-next" position="0.15 0 0.02" width="0.2" height="0.12" color="#1a1a1a" class="clickable btn-hover"><a-text value=">>|" align="center" width="2"></a-text></a-plane>
            </a-entity>

            <a-entity id="panel-right" position="1.05 0 0.2" rotation="0 -25 0">
                <a-box width="0.6" height="0.5" depth="0.02" color="#080808" opacity="0.9" class="clickable"></a-box>
                <a-text value="VISION" position="0 0.2 0.02" align="center" width="2" color="#666"></a-text>
                <a-plane id="btn-mode" position="0 0.08 0.02" width="0.5" height="0.1" color="#1a1a1a" class="clickable btn-hover"><a-text value="2D / 360" align="center" width="1.6"></a-text></a-plane>
                <a-plane id="btn-void" position="0 -0.05 0.02" width="0.5" height="0.1" color="#1a1a1a" class="clickable btn-hover"><a-text value="VOID" align="center" width="1.6"></a-text></a-plane>
            </a-entity>

        </a-entity>

        <a-entity id="rig" position="0 1.6 0">
            <a-camera look-controls="reverseMouseDrag: true" wasd-controls="enabled: false">
                <a-cursor id="cursor" fuse="true" fuse-timeout="1200" color="#00d2ff" raycaster="objects: .clickable, .clickable-long"></a-cursor>
            </a-camera>
        </a-entity>

    </a-scene>

    <script>
        const video = document.getElementById('video-src');
        const img = document.getElementById('img-src');
        const uiLayer = document.getElementById('ui-layer');
        const fileInput = document.getElementById('file-input');
        const playlistPreview = document.getElementById('playlist-preview');
        const btnStart = document.getElementById('btn-start');
        
        const screenCinema = document.getElementById('screen-cinema');
        const screen360 = document.getElementById('screen-360');
        const hubWrapper = document.getElementById('hub-wrapper');
        const summonOrbWrapper = document.getElementById('summon-orb-wrapper');
        const summonRing = document.getElementById('summon-ring');
        
        // UI Refs
        const playBtnText = document.getElementById('txt-play');
        const timeText = document.getElementById('time-display');
        const progressFill = document.getElementById('progress-fill');
        const titleText = document.getElementById('txt-title');
        const volFill = document.getElementById('vol-fill');

        let playlist = [], currentTrack = 0, is360 = false, isVoid = false, volumeLevel = 1.0;
        let audioCtx, gainNode;
        
        // --- 1. SUMMON LOGIC (Long Press) ---
        let summonTimer = null;
        let animationInterval = null;
        const ACTIVATION_TIME = 2000; // 2 seconds to activate

        // Get the orb element
        const orb = document.getElementById('summon-orb');

        orb.addEventListener('mouseenter', () => {
            // Start Animation
            let progress = 0;
            const step = 360 / (ACTIVATION_TIME / 20); // Calculate degrees per tick
            
            orb.setAttribute('color', '#00d2ff');
            
            // Visual loop
            animationInterval = setInterval(() => {
                progress += step;
                summonRing.setAttribute('theta-length', Math.min(360, progress));
            }, 20);

            // Logic Timer
            summonTimer = setTimeout(() => {
                openCockpit();
            }, ACTIVATION_TIME);
        });

        orb.addEventListener('mouseleave', () => {
            // Cancel everything
            clearTimeout(summonTimer);
            clearInterval(animationInterval);
            
            // Reset visuals
            orb.setAttribute('color', '#333');
            summonRing.setAttribute('theta-length', 0);
        });

        function openCockpit() {
            // Hide Orb
            summonOrbWrapper.setAttribute('visible', false);
            
            // Show Cockpit with pop animation
            hubWrapper.setAttribute('visible', true);
            hubWrapper.setAttribute('animation', 'property: scale; from: 0.1 0.1 0.1; to: 1 1 1; dur: 400; easing: easeOutElastic');
            
            // Reset timer logic for auto-hide
            resetAutoHide();
        }

        function closeCockpit() {
            hubWrapper.setAttribute('visible', false);
            hubWrapper.setAttribute('scale', '0.1 0.1 0.1'); // Reset scale for next pop
            summonOrbWrapper.setAttribute('visible', true);
        }

        // --- 2. AUTO HIDE LOGIC ---
        let hubTimer;
        const resetAutoHide = () => {
            clearTimeout(hubTimer);
            // Only auto-hide if video is playing
            hubTimer = setTimeout(() => {
                if(!video.paused && hubWrapper.getAttribute('visible')) {
                    closeCockpit();
                }
            }, 6000);
        };

        // Standard buttons keep menu alive
        document.querySelectorAll('.clickable').forEach(el => {
            el.addEventListener('mouseenter', () => {
                resetAutoHide();
                if(el.classList.contains('btn-hover')) el.setAttribute('color', '#00d2ff');
            });
            el.addEventListener('mouseleave', () => {
                resetAutoHide();
                if(el.classList.contains('btn-hover')) {
                     if(el.id === 'btn-play') el.setAttribute('color', '#00d2ff');
                     else el.setAttribute('color', '#111'); 
                }
            });
        });
        
        // Manual Close X button
        document.getElementById('btn-close').addEventListener('click', closeCockpit);


        /* --- 3. MEDIA & PLAYLIST --- */
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            addItems(files.map(f => ({ type: f.type.startsWith('image') ? 'image' : 'video', src: f, name: f.name })));
        });

        function addItems(items) {
            playlist = playlist.concat(items);
            btnStart.style.display = 'block';
            playlistPreview.innerHTML = playlist.map((item, i) => `<div>${i+1}. ${item.name}</div>`).join('');
        }

        btnStart.addEventListener('click', () => {
            if(playlist.length > 0) {
                uiLayer.classList.add('hidden');
                loadTrack(0);
                // Start with Cockpit open
                openCockpit();
            }
        });

        function loadTrack(index) {
            if (index >= 0 && index < playlist.length) {
                currentTrack = index;
                const item = playlist[currentTrack];
                let src = (item.src instanceof File) ? URL.createObjectURL(item.src) : item.src;

                titleText.setAttribute('value', item.name.substring(0, 20));

                if (item.type === 'image') {
                    img.onload = function() {
                        screenCinema.setAttribute('src', '#img-src');
                        screen360.setAttribute('src', '#img-src');
                        const mesh = screenCinema.getObject3D('mesh');
                        if (mesh && mesh.material.map) mesh.material.map.needsUpdate = true;
                        updateAmbilight(img);
                    };
                    img.src = src;
                    video.pause();
                    playBtnText.setAttribute('value', 'IMG');
                } else {
                    video.src = src;
                    screenCinema.setAttribute('src', '#video-src');
                    screen360.setAttribute('src', '#video-src');
                    initAudio();
                    video.play().then(() => playBtnText.setAttribute('value', 'PAUSE'))
                                .catch(() => playBtnText.setAttribute('value', 'PLAY'));
                    requestAnimationFrame(() => updateAmbilight(video));
                }
            }
        }

        /* --- 4. STANDARD INTERACTIONS --- */
        document.getElementById('btn-play').addEventListener('click', function() {
            if(video.paused) { video.play(); playBtnText.setAttribute('value', 'PAUSE'); }
            else { video.pause(); playBtnText.setAttribute('value', 'PLAY'); }
        });

        document.getElementById('btn-seek-back').addEventListener('click', () => video.currentTime -= 15);
        document.getElementById('btn-seek-fwd').addEventListener('click', () => video.currentTime += 15);
        
        document.getElementById('btn-prev').addEventListener('click', () => { if(currentTrack > 0) loadTrack(currentTrack - 1); });
        document.getElementById('btn-next').addEventListener('click', () => { if(currentTrack < playlist.length - 1) loadTrack(currentTrack + 1); });

        document.getElementById('btn-mode').addEventListener('click', function() {
            is360 = !is360;
            screenCinema.setAttribute('visible', !is360);
            screen360.setAttribute('visible', is360);
            document.getElementById('env-floor').setAttribute('visible', !is360);
            if(is360) document.querySelector('a-scene').removeAttribute('fog'); 
            else document.querySelector('a-scene').setAttribute('fog', 'type: exponential; color: #000; density: 0.015');
        });

        document.getElementById('btn-void').addEventListener('click', function() {
            isVoid = !isVoid;
            if(!is360) document.getElementById('env-floor').setAttribute('visible', !isVoid);
            document.querySelector('a-scene').setAttribute('background', isVoid ? 'color: #000' : 'color: #050505');
        });
        
        document.getElementById('btn-vol').addEventListener('click', function() {
            if(!gainNode) return;
            volumeLevel = (volumeLevel >= 3.0) ? 0.5 : volumeLevel + 1.0;
            gainNode.gain.value = volumeLevel;
            volFill.setAttribute('scale', `${Math.min(1, volumeLevel / 3.0)} 1 1`);
        });

        /* --- LOOPS --- */
        setInterval(() => {
            if(video.duration) {
                const pct = video.currentTime / video.duration;
                progressFill.object3D.scale.x = pct;
                progressFill.object3D.position.x = -0.6 + (1.2 * pct / 2);
                timeText.setAttribute('value', `${fmt(video.currentTime)} / ${fmt(video.duration)}`);
            }
        }, 500);

        function fmt(s) { return `${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,'0')}`; }

        function initAudio() {
            if(audioCtx) return;
            const AC = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AC();
            const src = audioCtx.createMediaElementSource(video);
            gainNode = audioCtx.createGain();
            gainNode.gain.value = volumeLevel;
            const panner = audioCtx.createPanner();
            panner.setPosition(0, 4.5, -5);
            src.connect(gainNode).connect(panner).connect(audioCtx.destination);
        }

        const ctx = document.getElementById('light-canvas').getContext('2d');
        const ambi = document.getElementById('ambi-light');
        const glow = document.getElementById('screen-glow');

        function updateAmbilight(source) {
            if(source === video && (video.paused || video.ended)) return;
            try {
                ctx.drawImage(source, 0, 0, 32, 32);
                const d = ctx.getImageData(16,16,1,1).data;
                const hex = "#" + ((1<<24)+(d[0]<<16)+(d[1]<<8)+d[2]).toString(16).slice(1);
                if(!isVoid && !is360) ambi.setAttribute('color', hex);
                glow.setAttribute('color', hex);
            } catch(e) {}
            if(source === video) requestAnimationFrame(() => updateAmbilight(video));
        }

    </script>
</body>
</html>
