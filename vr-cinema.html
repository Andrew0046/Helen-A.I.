<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hub 2.0: Sleep Node Edition</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <style>
        /* --- 2D DASHBOARD --- */
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', Roboto, sans-serif; color: white; }
        
        #ui-layer {
            position: absolute; z-index: 9999; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        .hidden { display: none !important; }

        .hub-card {
            background: rgba(20, 20, 20, 0.8); border: 1px solid rgba(0, 210, 255, 0.3);
            backdrop-filter: blur(20px); padding: 50px; border-radius: 24px; width: 500px; text-align: center;
            box-shadow: 0 0 80px rgba(0, 210, 255, 0.1);
        }

        h1 { margin: 0 0 30px; letter-spacing: 6px; font-weight: 200; color: #fff; }
        h1 span { color: #00d2ff; font-weight: 700; text-shadow: 0 0 15px rgba(0, 210, 255, 0.8); }

        .btn-neon {
            background: linear-gradient(90deg, #00d2ff 0%, #0078ff 100%); border: none; padding: 18px 40px;
            color: #000; font-weight: 800; font-size: 14px; letter-spacing: 2px; border-radius: 50px;
            cursor: pointer; margin-top: 30px; width: 100%; transition: 0.3s;
            box-shadow: 0 10px 30px rgba(0, 120, 255, 0.3);
        }
        .btn-neon:hover { transform: scale(1.02); box-shadow: 0 10px 50px rgba(0, 120, 255, 0.6); }

        .url-input { 
            width: 100%; background: #000; border: 1px solid #333; color: #00d2ff; padding: 15px; 
            border-radius: 8px; margin-top: 20px; box-sizing: border-box; font-family: monospace;
        }

        #playlist-preview {
            margin-top: 20px; text-align: left; font-size: 0.85rem; color: #666; max-height: 100px; overflow-y: auto;
        }

        #light-canvas { display: none; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="hub-card">
            <h1>HUB <span>2.0</span></h1>
            <p style="color: #888;">IMMERSIVE COCKPIT SYSTEM</p>
            
            <input type="file" id="file-input" accept="video/*, image/*" multiple style="display:none">
            <button class="btn-neon" onclick="document.getElementById('file-input').click()">INITIALIZE MEDIA</button>
            
            <input type="text" class="url-input" id="url-input" placeholder="OR ENTER STREAM URL...">
            <button id="btn-url-add" style="background:none; border:none; color:#444; margin-top:10px; cursor:pointer;">+ ADD URL</button>

            <div id="playlist-preview"></div>
            
            <button id="btn-start" class="btn-neon" style="display:none; background: white; color: black;">LAUNCH VR</button>
        </div>
    </div>

    <canvas id="light-canvas" width="32" height="32"></canvas>

    <a-scene background="color: #000" fog="type: exponential; color: #000; density: 0.015">
        
        <a-assets>
            <video id="video-src" src="" playsinline webkit-playsinline loop="false" crossorigin="anonymous"></video>
            <img id="img-src" src="" crossorigin="anonymous">
            <img id="grid-texture" src="https://cdn.aframe.io/a-painter/images/floor.jpg">
        </a-assets>

        <a-plane id="env-floor" position="0 0 -4" rotation="-90 0 0" width="100" height="100" 
                 src="#grid-texture" repeat="50 50" color="#111" roughness="0.2" metalness="0.8">
        </a-plane>
        <a-light id="ambi-light" type="ambient" color="#222" intensity="0.2"></a-light>
        <a-light id="screen-glow" type="point" position="0 5 -5" distance="30" decay="2" intensity="0.5" color="#fff"></a-light>

        <a-curvedimage id="screen-cinema" src="#video-src" 
            height="12" radius="14" theta-length="90" 
            rotation="0 135 0" position="0 5 0" 
            side="double" visible="true">
        </a-curvedimage>

        <a-videosphere id="screen-360" src="#video-src" 
            radius="60" rotation="0 -90 0" 
            material="shader: flat; side: back; fog: false" 
            visible="false">
        </a-videosphere>


        <a-entity id="sleep-node" position="0 0.8 -1.5" visible="true">
            
            <a-sphere radius="0.08" color="#111" opacity="0.9" class="clickable btn-hover" id="btn-wake">
                <a-sphere radius="0.04" color="#00d2ff" opacity="0.5"></a-sphere>
            </a-sphere>
            
            <a-ring id="wake-ring" radius-inner="0.1" radius-outer="0.12" color="#00d2ff" 
                    theta-length="0" rotation="0 0 0" opacity="0.8"></a-ring>
            
            <a-text value="LOOK TO WAKE" position="0 -0.15 0" align="center" width="1.5" color="#444"></a-text>
        </a-entity>


        <a-entity id="hub-wrapper" position="0 0.9 -1.6" rotation="-20 0 0" visible="false">
            
            <a-entity id="panel-center" position="0 0 0">
                <a-box width="1.4" height="0.6" depth="0.02" color="#050505" opacity="0.95" class="clickable"></a-box>
                <a-box width="1.4" height="0.01" depth="0.03" position="0 0.3 0" color="#00d2ff" opacity="0.8"></a-box>

                <a-text id="txt-title" value="Ready" position="0 0.22 0.02" align="center" width="2" color="#00d2ff"></a-text>
                <a-text id="time-display" value="00:00 / 00:00" position="0 0.16 0.02" align="center" width="1.8" color="#666"></a-text>

                <a-plane position="0 0.12 0.02" width="1.2" height="0.01" color="#222"></a-plane>
                <a-plane id="progress-fill" position="-0.6 0.12 0.025" width="1.2" height="0.01" color="#00d2ff" scale="0 1 1" pivot="center left"></a-plane>

                <a-plane id="btn-seek-back" position="-0.4 0 0.02" width="0.2" height="0.12" color="#111" class="clickable btn-hover"><a-text value="-15s" align="center" width="1.5"></a-text></a-plane>
                <a-plane id="btn-play" position="0 0 0.02" width="0.5" height="0.15" color="#00d2ff" class="clickable btn-hover">
                    <a-text id="txt-play" value="PLAY" align="center" width="3" color="black" font-weight="bold"></a-text>
                </a-plane>
                <a-plane id="btn-seek-fwd" position="0.4 0 0.02" width="0.2" height="0.12" color="#111" class="clickable btn-hover"><a-text value="+15s" align="center" width="1.5"></a-text></a-plane>

                <a-text value="VOL" position="-0.55 -0.18 0.02" width="1.5" align="center" color="#444"></a-text>
                <a-plane id="btn-vol" position="0 -0.18 0.02" width="0.8" height="0.03" color="#222" class="clickable btn-hover">
                     <a-plane id="vol-fill" position="-0.4 0 0.01" width="0.8" height="0.03" color="#00ff00" scale="0.5 1 1" pivot="center left"></a-plane>
                </a-plane>
            </a-entity>


            <a-entity id="panel-left" position="-1.05 0 0.2" rotation="0 25 0">
                <a-box width="0.6" height="0.5" depth="0.02" color="#080808" opacity="0.9" class="clickable"></a-box>
                <a-text value="LIBRARY" position="0 0.2 0.02" align="center" width="2" color="#666" letter-spacing="2"></a-text>
                
                <a-plane id="btn-prev" position="-0.15 0 0.02" width="0.2" height="0.12" color="#1a1a1a" class="clickable btn-hover">
                    <a-text value="|<<" align="center" width="2"></a-text>
                </a-plane>
                <a-plane id="btn-next" position="0.15 0 0.02" width="0.2" height="0.12" color="#1a1a1a" class="clickable btn-hover">
                    <a-text value=">>|" align="center" width="2"></a-text>
                </a-plane>

                <a-text id="txt-track-info" value="Track 1/1" position="0 -0.15 0.02" align="center" width="1.5" color="#444"></a-text>
            </a-entity>


            <a-entity id="panel-right" position="1.05 0 0.2" rotation="0 -25 0">
                <a-box width="0.6" height="0.5" depth="0.02" color="#080808" opacity="0.9" class="clickable"></a-box>
                <a-text value="VISION" position="0 0.2 0.02" align="center" width="2" color="#666" letter-spacing="2"></a-text>

                <a-plane id="btn-mode" position="0 0.08 0.02" width="0.5" height="0.1" color="#1a1a1a" class="clickable btn-hover">
                    <a-text value="2D / 360 MODE" align="center" width="1.6"></a-text>
                </a-plane>

                <a-plane id="btn-curve-toggle" position="-0.14 -0.05 0.02" width="0.22" height="0.1" color="#1a1a1a" class="clickable btn-hover">
                    <a-text value="CURVE" align="center" width="1.4"></a-text>
                </a-plane>

                <a-plane id="btn-void" position="0.14 -0.05 0.02" width="0.22" height="0.1" color="#1a1a1a" class="clickable btn-hover">
                    <a-text value="VOID" align="center" width="1.4"></a-text>
                </a-plane>

                <a-plane id="btn-seat" position="0 -0.18 0.02" width="0.5" height="0.1" color="#1a1a1a" class="clickable btn-hover">
                    <a-text value="SEAT: FRONT" id="txt-seat" align="center" width="1.6"></a-text>
                </a-plane>
            </a-entity>

        </a-entity>


        <a-entity id="rig" position="0 1.6 0">
            <a-camera look-controls="reverseMouseDrag: true" wasd-controls="enabled: false">
                <a-cursor id="cursor" fuse="true" fuse-timeout="1500" color="#00d2ff" raycaster="objects: .clickable"
                    animation__click="property: scale; startEvents: click; from: 0.1 0.1 0.1; to: 1 1 1; dur: 150"
                    animation__fusing="property: scale; startEvents: fusing; from: 1 1 1; to: 0.1 0.1 0.1; dur: 1500">
                </a-cursor>
            </a-camera>
        </a-entity>

    </a-scene>

    <script>
        /* --- CONFIG --- */
        const video = document.getElementById('video-src');
        const img = document.getElementById('img-src');
        const uiLayer = document.getElementById('ui-layer');
        const fileInput = document.getElementById('file-input');
        const urlInput = document.getElementById('url-input');
        const playlistPreview = document.getElementById('playlist-preview');
        const btnStart = document.getElementById('btn-start');
        
        // Scene Elements
        const screenCinema = document.getElementById('screen-cinema');
        const screen360 = document.getElementById('screen-360');
        const rig = document.getElementById('rig');
        const hubWrapper = document.getElementById('hub-wrapper');
        const sleepNode = document.getElementById('sleep-node'); // The "Small Button"
        const wakeRing = document.getElementById('wake-ring');
        const floor = document.getElementById('env-floor');
        const scene = document.querySelector('a-scene');

        // UI Elements
        const playBtnText = document.getElementById('txt-play');
        const timeText = document.getElementById('time-display');
        const progressFill = document.getElementById('progress-fill');
        const titleText = document.getElementById('txt-title');
        const trackText = document.getElementById('txt-track-info');
        const volFill = document.getElementById('vol-fill');

        // State
        let playlist = [];
        let currentTrack = 0;
        let is360 = false;
        let isVoid = false;
        let currentCurve = 90;
        let audioCtx, gainNode;
        let volumeLevel = 1.0;

        /* --- 1. SLEEP/WAKE SYSTEM (NEW) --- */
        
        let wakeTimer;
        let sleepTimer;
        let wakeAnimationInterval;
        let wakeProgress = 0;

        // A. WAKE UP LOGIC (Long Gaze)
        const btnWake = document.getElementById('btn-wake');
        
        btnWake.addEventListener('mouseenter', () => {
            // Start Long Timer (2000ms)
            wakeProgress = 0;
            wakeRing.setAttribute('theta-length', 0);
            
            // Animation Loop
            wakeAnimationInterval = setInterval(() => {
                wakeProgress += 360 / 40; // 40 frames approx 2 sec
                if(wakeProgress > 360) wakeProgress = 360;
                wakeRing.setAttribute('theta-length', wakeProgress);
            }, 50);

            wakeTimer = setTimeout(() => {
                // ACTIVATE COCKPIT
                activateCockpit();
            }, 2000); // 2 Seconds
        });

        btnWake.addEventListener('mouseleave', () => {
            // Cancel everything
            clearTimeout(wakeTimer);
            clearInterval(wakeAnimationInterval);
            wakeRing.setAttribute('theta-length', 0); // Reset ring
        });

        function activateCockpit() {
            sleepNode.setAttribute('visible', false); // Hide Orb
            hubWrapper.setAttribute('visible', true); // Show Cockpit
            resetSleepTimer(); // Start inactivity timer
        }

        // B. SLEEP LOGIC (Inactivity)
        function resetSleepTimer() {
            clearTimeout(sleepTimer);
            
            // Only sleep if the cockpit is currently open
            if(hubWrapper.getAttribute('visible')) {
                sleepTimer = setTimeout(() => {
                    // Only go to sleep if video is playing (or user wants it)
                    if(video.type !== 'image' && !video.paused) {
                        goToSleep();
                    }
                }, 6000); // 6 Seconds inactivity
            }
        }

        function goToSleep() {
            hubWrapper.setAttribute('visible', false); // Hide Cockpit
            sleepNode.setAttribute('visible', true);   // Show Orb
        }

        // C. INTERACTION TRACKING
        document.querySelectorAll('.clickable').forEach(el => {
            el.addEventListener('mouseenter', () => {
                if(el.id !== 'btn-wake') resetSleepTimer(); // Keep awake if looking at cockpit buttons
                if(el.classList.contains('btn-hover')) el.setAttribute('color', '#00d2ff');
            });
            el.addEventListener('mouseleave', () => {
                if(el.id !== 'btn-wake') resetSleepTimer(); // Countdown starts on leave
                if(el.classList.contains('btn-hover')) {
                     if(el.id === 'btn-play') el.setAttribute('color', '#00d2ff');
                     else el.setAttribute('color', '#1a1a1a'); 
                }
            });
        });


        /* --- 2. PLAYLIST LOGIC --- */
        
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            addItems(files.map(f => ({ type: f.type.startsWith('image') ? 'image' : 'video', src: f, name: f.name })));
        });

        document.getElementById('btn-url-add').addEventListener('click', () => {
            const url = urlInput.value.trim();
            if(url) {
                const isImage = url.match(/\.(jpeg|jpg|gif|png)$/) != null;
                addItems([{ type: isImage ? 'image' : 'video', src: url, name: "Web Stream" }]);
                urlInput.value = ""; 
            }
        });

        function addItems(items) {
            playlist = playlist.concat(items);
            btnStart.style.display = 'block';
            playlistPreview.innerHTML = playlist.map((item, i) => `<div>${i+1}. ${item.name}</div>`).join('');
        }

        btnStart.addEventListener('click', () => {
            if(playlist.length > 0) {
                uiLayer.classList.add('hidden');
                loadTrack(0);
                activateCockpit(); // Show cockpit on start
            }
        });

        function loadTrack(index) {
            if (index >= 0 && index < playlist.length) {
                currentTrack = index;
                const item = playlist[currentTrack];
                let src = (item.src instanceof File) ? URL.createObjectURL(item.src) : item.src;

                titleText.setAttribute('value', item.name.substring(0, 20));
                trackText.setAttribute('value', `Track ${currentTrack + 1}/${playlist.length}`);

                if (item.type === 'image') {
                    img.onload = function() {
                        screenCinema.setAttribute('src', '#img-src');
                        screen360.setAttribute('src', '#img-src');
                        const mesh = screenCinema.getObject3D('mesh');
                        if (mesh && mesh.material.map) mesh.material.map.needsUpdate = true;
                        updateAmbilight(img);
                    };
                    img.src = src;
                    video.pause();
                    playBtnText.setAttribute('value', 'IMG');
                    goToSleep(); // Auto-hide controls for images
                    
                } else {
                    video.src = src;
                    screenCinema.setAttribute('src', '#video-src');
                    screen360.setAttribute('src', '#video-src');
                    initAudio();
                    video.play().then(() => playBtnText.setAttribute('value', 'PAUSE'))
                                .catch(() => playBtnText.setAttribute('value', 'PLAY'));
                    requestAnimationFrame(() => updateAmbilight(video));
                }
            }
        }


        /* --- 3. COCKPIT CONTROLS --- */
        
        function flash(el) {
            const oldColor = el.getAttribute('color');
            el.setAttribute('color', '#fff');
            setTimeout(() => el.setAttribute('color', oldColor), 150);
        }

        document.getElementById('btn-play').addEventListener('click', function() {
            if(video.paused) { video.play(); playBtnText.setAttribute('value', 'PAUSE'); }
            else { video.pause(); playBtnText.setAttribute('value', 'PLAY'); }
            flash(this);
        });

        document.getElementById('btn-seek-back').addEventListener('click', function() {
            video.currentTime = Math.max(0, video.currentTime - 15); flash(this);
        });
        document.getElementById('btn-seek-fwd').addEventListener('click', function() {
            video.currentTime = Math.min(video.duration, video.currentTime + 15); flash(this);
        });
        
        document.getElementById('btn-vol').addEventListener('click', function() {
            if(!gainNode) return;
            volumeLevel += 1.0;
            if(volumeLevel > 3.0) volumeLevel = 0.5;
            gainNode.gain.value = volumeLevel;
            const scale = Math.min(1, volumeLevel / 3.0);
            volFill.setAttribute('scale', `${scale} 1 1`);
            volFill.setAttribute('color', volumeLevel > 1.5 ? '#ff0055' : '#00ff00');
            flash(this);
        });

        document.getElementById('btn-prev').addEventListener('click', function() {
            if(currentTrack > 0) loadTrack(currentTrack - 1); flash(this);
        });
        document.getElementById('btn-next').addEventListener('click', function() {
            if(currentTrack < playlist.length - 1) loadTrack(currentTrack + 1); flash(this);
        });

        document.getElementById('btn-mode').addEventListener('click', function() {
            is360 = !is360;
            screenCinema.setAttribute('visible', !is360);
            screen360.setAttribute('visible', is360);
            floor.setAttribute('visible', !is360);
            if(is360) scene.removeAttribute('fog'); 
            else scene.setAttribute('fog', 'type: exponential; color: #000; density: 0.015');
            flash(this);
        });

        document.getElementById('btn-void').addEventListener('click', function() {
            isVoid = !isVoid;
            if(!is360) floor.setAttribute('visible', !isVoid);
            scene.setAttribute('background', isVoid ? 'color: #000' : 'color: #050505');
            flash(this);
        });

        document.getElementById('btn-curve-toggle').addEventListener('click', function() {
            currentCurve += 30;
            if(currentCurve > 120) currentCurve = 60;
            screenCinema.setAttribute('theta-length', currentCurve);
            screenCinema.setAttribute('rotation', `0 ${180 - (currentCurve / 2)} 0`);
            flash(this);
        });
        
        const seatNames = ["FRONT", "BACK", "RECLINE"];
        let seatIdx = 0;
        const seatPos = [{ pos: "0 1.6 0", rot: "-20 0 0" }, { pos: "0 2.5 3", rot: "-20 0 0" }, { pos: "0 0.5 0", rot: "-45 0 0" }];
        
        document.getElementById('btn-seat').addEventListener('click', function() {
            seatIdx = (seatIdx + 1) % 3;
            const s = seatPos[seatIdx];
            rig.setAttribute('position', s.pos);
            hubWrapper.setAttribute('rotation', s.rot);
            sleepNode.setAttribute('position', `0 ${s.pos.split(' ')[1] - 0.8} -1.5`); // Adjust orb height based on seat
            document.getElementById('txt-seat').setAttribute('value', `SEAT: ${seatNames[seatIdx]}`);
            flash(this);
        });


        /* --- 4. LOOPS & SYSTEMS --- */
        setInterval(() => {
            if(video.duration) {
                const pct = video.currentTime / video.duration;
                progressFill.object3D.scale.x = pct;
                progressFill.object3D.position.x = -0.6 + (1.2 * pct / 2);
                
                const cur = fmt(video.currentTime);
                const tot = fmt(video.duration);
                timeText.setAttribute('value', `${cur} / ${tot}`);
            }
        }, 500);

        function fmt(s) {
            const m = Math.floor(s/60);
            const sec = Math.floor(s%60);
            return `${m}:${sec<10?'0'+sec:sec}`;
        }

        function initAudio() {
            if(audioCtx) return;
            const AC = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AC();
            const src = audioCtx.createMediaElementSource(video);
            gainNode = audioCtx.createGain();
            gainNode.gain.value = volumeLevel;
            const panner = audioCtx.createPanner();
            panner.setPosition(0, 4.5, -5);
            src.connect(gainNode).connect(panner).connect(audioCtx.destination);
        }

        const ctx = document.getElementById('light-canvas').getContext('2d');
        const ambi = document.getElementById('ambi-light');
        const glow = document.getElementById('screen-glow');

        function updateAmbilight(source) {
            if(source === video && (video.paused || video.ended)) return;
            try {
                ctx.drawImage(source, 0, 0, 32, 32);
                const p = ctx.getImageData(16,16,1,1).data;
                const hex = "#" + ((1<<24)+(p[0]<<16)+(p[1]<<8)+p[2]).toString(16).slice(1);
                if(!isVoid && !is360) ambi.setAttribute('color', hex);
                glow.setAttribute('color', hex);
            } catch(e) {}
            if(source === video) requestAnimationFrame(() => updateAmbilight(video));
        }

    </script>
</body>
</html>
